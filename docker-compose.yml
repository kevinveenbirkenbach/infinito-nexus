# CI profile defaults: point containers to CoreDNS and set search domain
x-ci-defaults: &ci_defaults
  dns:
    - 172.30.0.53
  dns_opt:
    - ndots:1

services:
  # ------------------------------------------------------------
  # CoreDNS (CI only)
  # ------------------------------------------------------------
  coredns:
    image: coredns/coredns:1.11.1
    container_name: infinito-coredns
    profiles: ["ci"]
    command: ["-conf", "/Corefile"]
    volumes:
      - ./compose/Corefile:/Corefile:ro
    networks:
      default:
        ipv4_address: 172.30.0.53

  # ------------------------------------------------------------
  # Infinito runner container (systemd-enabled for CI)
  # ------------------------------------------------------------
  infinito:
    build:
      context: .
      dockerfile: Dockerfile
      network: host  # affects only image build networking
    pull_policy: never

    # Run systemd as PID 1
    command:
      - /sbin/init
      - systemd.log_target=console
      - systemd.log_level=debug
      - systemd.journald.forward_to_console=1
      - systemd.journald.max_level_console=debug

    stop_signal: SIGRTMIN+3

    # systemd inside docker needs access to the host cgroup namespace
    privileged: true
    tmpfs:
      - /run
      - /run/lock

    # Helpful for interactive debugging
    tty: true
    stdin_open: true

    container_name: infinito_nexus_${INFINITO_DISTRO:-arch}
    image: "infinito-${INFINITO_DISTRO:-arch}"
    restart: "no"

    profiles: ["ci"]
    <<: *ci_defaults

    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp/gh-action/:/tmp/gh-action/
      - .:/opt/src/infinito
      - data:/var/lib/docker/volumes/
      - backups:/Backups/
      - letsencrypt:/etc/letsencrypt/

    environment:
      DOCKER_HOST: unix:///var/run/docker.sock
      INSTALL_LOCAL_BUILD: "1"
      INFINITO_SRC_DIR: /opt/src/infinito
      PYTHONHTTPSVERIFY: "1"
      GIT_SSL_NO_VERIFY: "0"

    ports:
      - "${BIND_IP:-127.0.0.1}:25:25"
      - "${BIND_IP:-127.0.0.1}:110:110"
      - "${BIND_IP:-127.0.0.1}:143:143"
      - "${BIND_IP:-127.0.0.1}:465:465"
      - "${BIND_IP:-127.0.0.1}:587:587"
      - "${BIND_IP:-127.0.0.1}:993:993"
      - "${BIND_IP:-127.0.0.1}:995:995"
      - "${BIND_IP:-127.0.0.1}:4190:4190"

      - "${BIND_IP:-127.0.0.1}:80:80"
      - "${BIND_IP:-127.0.0.1}:443:443"
      - "${BIND_IP:-127.0.0.1}:8448:8448"

      - "${BIND_IP:-127.0.0.1}:3478-3480:3478-3480/udp"
      - "${BIND_IP:-127.0.0.1}:3478-3480:3478-3480"

      - "${BIND_IP:-127.0.0.1}:1935:1935"

      - "${BIND_IP:-127.0.0.1}:2201:2201"
      - "${BIND_IP:-127.0.0.1}:2202:2202"
      - "${BIND_IP:-127.0.0.1}:2203:22"
      - "${BIND_IP:-127.0.0.1}:33552:33552"

      - "${BIND_IP:-127.0.0.1}:48081-48083:48081-48083"
      - "${BIND_IP:-127.0.0.1}:48087:48087"

volumes:
  data:
  backups:
  letsencrypt:

networks:
  default:
    driver: bridge
    ipam:
      config:
        - subnet: ${SUBNET:-172.30.0.0/24}
          gateway: ${GATEWAY:-172.30.0.1}
