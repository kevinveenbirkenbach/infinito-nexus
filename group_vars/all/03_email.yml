# Email Configuration
SYSTEM_EMAIL_ENABLED:         true
SYSTEM_EMAIL_TIMEOUT:         "30"
SYSTEM_EMAIL_EXTERNAL:        "{{ ('web-app-mailu' in group_names) | bool }}"

# In DiD it's just possible to react on localhost. Full qualified mail host names aren't possible.
# From Docker->DiD->DiD it is propably not possible to send emails.
# Will lead to problems with the health checks 
SYSTEM_EMAIL_ENVIRONMENT: >-
  {{ ('external' if ((SYSTEM_EMAIL_EXTERNAL | bool) or (TLS_ENABLED | bool )) else 'localhost')
     ~ ('_container' if ((DOCKER_IN_CONTAINER | bool) and (not TLS_ENABLED | bool)) else '') }}

# Server
SYSTEM_EMAIL_DOMAIN:          "{{ DOMAIN_PRIMARY }}"
SYSTEM_EMAIL_HOST:            "{{ (SYSTEM_EMAIL_ENVIRONMENT in ['external_container','localhost','localhost_container']) | ternary('localhost',(lookup('domain','web-app-mailu'))) }}"
SYSTEM_EMAIL_PORT:            "{{ (SYSTEM_EMAIL_EXTERNAL | bool and SYSTEM_EMAIL_TLS | bool) | ternary(465,25) }}"
SYSTEM_EMAIL_TLS:             "{{ (SYSTEM_EMAIL_EXTERNAL | bool) | ternary(TLS_ENABLED,false) }}"
SYSTEM_EMAIL_AUTH:            "{{ (SYSTEM_EMAIL_ENVIRONMENT in ['external_container','localhost']) | ternary(false,SYSTEM_EMAIL_TLS) }}"
SYSTEM_EMAIL_START_TLS:       false
SYSTEM_EMAIL_SMTP:            true

# Credentials
_SYSTEM_EMAIL_USER:           "{{ users.get('no-reply', {}) }}"
SYSTEM_EMAIL_FROM: >-
  {{
    _SYSTEM_EMAIL_USER.get('email')
    if (SYSTEM_EMAIL_EXTERNAL | bool)
    else ('root@' ~ inventory_hostname ~ '.localdomain')
  }}
SYSTEM_EMAIL_USERNAME:        "{{ SYSTEM_EMAIL_FROM }}"
SYSTEM_EMAIL_PASSWORD:        "{{ _SYSTEM_EMAIL_USER.get('tokens',{}).get('web-app-mailu', '') }}"
