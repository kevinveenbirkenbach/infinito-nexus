# Webserver Configuration

# Effective CPUs (float) across proxy and the current app
WEBSERVER_CPUS_EFFECTIVE: >-
  {{
    [
      (applications | resource_filter('svc-prx-openresty',  'cpus', service_name | default(''), RESOURCE_CPUS)) | float,
      (applications | resource_filter(application_id,       'cpus', service_name | default(''), RESOURCE_CPUS)) | float
    ] | min
  }}

# Nginx requires an integer for worker_processes:
# - if cpus < 1 → 1
# - else → floor to int
WEBSERVER_WORKER_PROCESSES: >-
  {{
    1 if (WEBSERVER_CPUS_EFFECTIVE | float) < 1
    else (WEBSERVER_CPUS_EFFECTIVE | float | int)
  }}

# worker_connections from pids_limit (use the smaller one), with correct key/defaults
WEBSERVER_WORKER_CONNECTIONS: >-
  {{
    [
      (applications | resource_filter('svc-prx-openresty', 'pids_limit', service_name | default(''), RESOURCE_PIDS_LIMIT)) | int,
      (applications | resource_filter(application_id,      'pids_limit', service_name | default(''), RESOURCE_PIDS_LIMIT)) | int
    ] | min
  }}

# @todo It propably makes sense to distinguish between target and source mount path, so that the config files can be stored in the openresty volumes folder
