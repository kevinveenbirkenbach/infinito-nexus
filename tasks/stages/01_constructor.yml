---
- name: Detect container environment (systemd-detect-virt)
  ansible.builtin.command: systemd-detect-virt --container
  changed_when: false
  failed_when: false

- name: Display selected initial host vars
  ansible.builtin.debug:
    msg: |
      group_names:
      {{ group_names | to_nice_yaml(indent=2) }}
      allowed_applications: {{ allowed_applications }}
      RUNTIME: {{ RUNTIME }}
      TLS_ENABLED: {{ TLS_ENABLED }}
      ASYNC_ENABLED: {{ ASYNC_ENABLED }}
      SOFTWARE_NAME: {{ SOFTWARE_NAME }}
  when: MODE_DEBUG | bool

- name: Check DNS resolution for test domain
  ansible.builtin.command: "getent hosts {{ DOMAIN_TEST }}"
  register: dns_check
  changed_when: false
  failed_when: dns_check.rc != 0
  when: MODE_ASSERT | bool

- name: Merge variables
  block:
  - name: Merge users
    ansible.builtin.set_fact:
      users: "{{ default_users | combine(users | default({}), recursive=True) }}"
    no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

  - name: Merge networks definitions
    ansible.builtin.set_fact:
      networks: "{{ defaults_networks | combine(networks | default({}, true), recursive=True) }}"

  - name: Merge application definitions
    ansible.builtin.set_fact:
      applications: "{{ defaults_applications | merge_with_defaults(applications | default({}, true)) }}"
    no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

  - name: "Sanity check: all group_names must exist in applications"
    ansible.builtin.assert:
      that:
        - item in applications
      fail_msg: "Group '{{ item }}' has no entry in 'applications'"
      success_msg: "Group '{{ item }}' is defined in 'applications'"
    loop: "{{ group_names }}"
    when: MODE_ASSERT | bool

  - name: Merge current play applications
    ansible.builtin.set_fact:
      CURRENT_PLAY_APPLICATIONS: >-
        {{
          applications
          | applications_if_group_and_deps(group_names)
          | combine(
              applications
              | dict2items
              | selectattr('key', 'in', WEBSERVER_CORE_APPLICATIONS)
              | items2dict
            )
        }}
    no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

  - name: Merge current play domain definitions
    ansible.builtin.set_fact:
      CURRENT_PLAY_DOMAINS: >-
        {{
          applications
          | canonical_domains_map(
              DOMAIN_PRIMARY,
              recursive=True,
              roles_base_dir=([ playbook_dir, 'roles' ] | path_join),
              seed=(CURRENT_PLAY_APPLICATIONS | dict2items | map(attribute='key') | list)
            )
          | combine(domains | default({}, true), recursive=True)
          | combine(
              {
                'svc-prx-openresty': {
                  'canonical': ([ DOMAIN_PRIMARY ] | flatten | map('string') | list)
                }
              },
              recursive=True
            )
        }}

  - name: Merge domain definitions for all domains
    ansible.builtin.set_fact:
      domains: >-
        {{
          defaults_applications
          | canonical_domains_map(DOMAIN_PRIMARY)
          | combine(CURRENT_PLAY_DOMAINS, recursive=True)
        }}

  - name: Merge CURRENT_PLAY_REDIRECT_DOMAINS
    ansible.builtin.set_fact:
      # The following mapping is necessary to define the exceptions for domains which are created, but which aren't used
      CURRENT_PLAY_REDIRECT_DOMAINS: >-
        {{
          []
          | add_redirect_if_group(
              'web-svc-asset',
              ([ lookup('domain','web-svc-asset') ] | flatten | map('string') | first),
              ([ lookup('domain','web-svc-file')  ] | flatten | map('string') | first),
              group_names
            )
          | merge_mapping(redirect_domain_mappings | default([]), 'source')
          | merge_mapping(
              [
                {
                  'source': ([ DOMAIN_PRIMARY  ] | flatten | map('string') | first),
                  'target': ([ DOMAIN_HOMEPAGE ] | flatten | map('string') | first)
                }
              ],
              'source'
            )
        }}

  - name: Set current play redirect domain mappings
    ansible.builtin.set_fact:
      CURRENT_PLAY_REDIRECT_DOMAINS: >-
        {{
          CURRENT_PLAY_APPLICATIONS
          | domain_mappings(DOMAIN_PRIMARY, AUTO_BUILD_ALIASES)
          | merge_mapping(CURRENT_PLAY_REDIRECT_DOMAINS, 'source')
        }}

  - name: Set current play all domains incl. www redirect if enabled
    ansible.builtin.set_fact:
      CURRENT_PLAY_DOMAINS_ALL: >-
        {{
          (
            CURRENT_PLAY_DOMAINS
            | combine(
                CURRENT_PLAY_REDIRECT_DOMAINS | default([])
                | items2dict(key_name='source', value_name='source'),
                recursive=True
              )
            | to_json
            | from_json
          )
          | generate_all_domains(WWW_REDIRECT_ENABLED | bool)
        }}

  - name: Merge OIDC configuration
    ansible.builtin.set_fact:
      OIDC: "{{ defaults_oidc | combine(OIDC | default({}, true), recursive=True) }}"
    no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

  - name: Merge design configuration
    ansible.builtin.set_fact:
      design: "{{ defaults_design | combine(design | default({}, true), recursive=True) }}"

  - name: Merge service_provider configuration
    ansible.builtin.set_fact:
      service_provider: "{{ defaults_service_provider | combine(service_provider | default({}, true), recursive=True) }}"

- name: "Persist {{ SOFTWARE_NAME }} version"
  ansible.builtin.include_role:
    name: sys-version

- name: Include Token Store
  ansible.builtin.include_role:
    name: sys-token-store
  when: run_once_sys_token_store is not defined

- name: init root user
  ansible.builtin.include_role:
    name: user-root

- name: update device
  ansible.builtin.include_role:
    name: update-compose

- name: "Ensure correct timezone is '{{ HOST_TIMEZONE }}'"
  community.general.timezone:
    name: "{{ HOST_TIMEZONE }}"
  when: not DOCKER_IN_CONTAINER | bool

- name: System Cleanup
  ansible.builtin.include_role:
    name: sys-cleanup
  when:
    - MODE_CLEANUP | bool
    - DOCKER_IN_CONTAINER | bool

- name: "Load base roles"
  ansible.builtin.include_tasks: "./tasks/groups/{{ item }}-roles.yml"
  loop:
    - update      # 1. Update system
    - drv         # 2. Load driver roles
    - gen         # 3. Load generic roles
    - svc-net     # 4. Load network roles
    - svc-db      # 5. Load database roles
    - svc-prx     # 6. Load proxy roles
    - svc-ai      # 7. Load AI roles
    - svc-bkp     # 8. Load Backup Roles
  loop_control:
    label: "{{ item }}-roles.yml"
