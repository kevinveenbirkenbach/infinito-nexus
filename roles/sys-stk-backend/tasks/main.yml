# run_once_sys_stk_backend: disabled

- name: "SYS-STK-BACKEND | Load optional dependencies (once)"
  ansible.builtin.include_tasks: "_load_service.yml"
  loop:
    - id: "svc-db-openldap"
      name: "ldap"

    - id: "svc-ai-ollama"
      name: "ollama"
  loop_control:
    loop_var: service
    label: "{{ service.id }}"
  vars:
    service_id: "{{ service.id }}"
    service_name: "{{ service.name }}"

- name: "Load Database"
  ansible.builtin.include_tasks: "01_database.yml"
  when: applications | service_load_enabled(application_id, 'database', False)

- name: "For '{{ application_id }}': Load docker-compose"
  include_role:
    name: docker-compose
  vars:
    docker_compose_flush_handlers: false

- block:
    - name: "set oauth2_proxy_application_id (Needed due to lazzy loading issue)"
      set_fact:
        oauth2_proxy_application_id: "{{ application_id }}"
    - name: "include the web-app-oauth2-proxy role {{ domain }}"
      include_tasks: "{{ playbook_dir }}/roles/web-app-oauth2-proxy/tasks/main.yml"
  when: applications | get_app_conf(application_id, 'docker.services.oauth2.enabled', False)

- name: "flush docker compose and oauth2 proxy for '{{ application_id }}'"
  meta: flush_handlers
  when: docker_compose_flush_handlers | bool

