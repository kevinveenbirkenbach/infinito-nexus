- name: "cleanup (if enabled)"
  include_tasks: 02_cleanup.yml
  when: >
    MODE_CLEANUP | bool or
    MODE_RESET | bool

- name: "reset (if enabled) for {{ role_name}}"
  include_tasks: 03_reset.yml
  when: MODE_RESET | bool

- name: "Load variables from {{ DOCKER_VARS_FILE }} for {{ role_name }}/{{ application_id }}"
  include_vars: "{{ DOCKER_VARS_FILE }}"

- name: "Load docker compose & openresty handlers"
  include_tasks: "{{ [ playbook_dir, 'tasks/utils/load_handlers.yml' ] | path_join }}"
  loop:
    - docker-compose
    - svc-prx-openresty
  loop_control:
    loop_var: handler_role_name
  vars:
    application_id: svc-prx-openresty # Required to use correct config path at handlers

- name: "Include tasks to create directories"
  include_tasks: 04_directories.yml

- name: Create NGINX Base Config
  template:
    src:  nginx.conf.j2
    dest: "{{ NGINX.FILES.CONFIGURATION }}"
  notify: restart openresty

- name: Include OpenResty (Once)
  include_tasks: "utils/load_app.yml"
  vars:
    load_app_id: svc-prx-openresty
  when: run_once_svc_prx_openresty is not defined

- name: Include health dependencies
  include_role:
    name: "{{ item }}"
  loop:
    - sys-ctl-hlth-webserver
    - sys-ctl-hlth-csp

- meta: flush_handlers 

- include_tasks: utils/once/flag.yml
