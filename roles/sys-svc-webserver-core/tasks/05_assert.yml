- name: Stat nginx.conf
  ansible.builtin.stat:
    path: "{{ lookup('nginx','files.configuration') }}"
  register: nginx_conf_stat

- name: Assert nginx.conf is a file
  ansible.builtin.assert:
    that:
      - nginx_conf_stat.stat.exists
      - nginx_conf_stat.stat.isreg
    fail_msg: >-
      Expected nginx.conf to be a FILE at {{ lookup('nginx','files.configuration') }},
      but it is missing or not a file (type mismatch). This would break docker bind mounts.

# Optional but very useful: conf.d must be a directory
- name: Stat conf.d directory
  ansible.builtin.stat:
    path: "{{ lookup('nginx','directories.configuration.base') }}"
  register: nginx_confd_stat

- name: Assert conf.d is a directory
  ansible.builtin.assert:
    that:
      - nginx_confd_stat.stat.exists
      - nginx_confd_stat.stat.isdir
    fail_msg: >-
      Expected conf.d to be a DIRECTORY at {{ lookup('nginx','directories.configuration.base') }},
      but it is missing or not a directory.


- name: "Assert default webserver responds with 404 for {{ DOMAIN_TEST }}"
  ansible.builtin.uri:
    url: "http://{{ DOMAIN_TEST }}:80/"
    method: GET
    return_content: true
    status_code: 404
    use_proxy: false
    timeout: 10
  register: default_vhost_check

- name: Assert default webserver response body
  ansible.builtin.assert:
    that:
      - default_vhost_check.status == 404
      - "'This service is not provided' in (default_vhost_check.content | default(''))"
    fail_msg: >-
      Expected http://{{ DOMAIN_TEST }} to return HTTP 404 with
      default Infinito.Nexus fallback message, but got:
      status={{ default_vhost_check.status }},
      body={{ default_vhost_check.content | default('') }}
