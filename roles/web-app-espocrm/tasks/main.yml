---
- name: "load docker, db and proxy for {{ application_id }}"
  include_role: 
    name: sys-stk-full-stateful
  vars:
    docker_compose_flush_handlers:  true

- name: Check if config.php exists in EspoCRM
  command: docker exec --user root {{ ESPOCRM_CONTAINER }} test -f {{ ESPOCRM_CONFIG_FILE_PRIVATE }}
  register: config_file_exists
  changed_when: false
  failed_when: false

- name: Patch EspoCRM config.php
  include_tasks: 01_patch_config.yml
  when: config_file_exists.rc == 0

- name: Flush handlers to make DB available before password reset
  meta: flush_handlers
