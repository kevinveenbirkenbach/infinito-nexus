- name: Ensure administrator user exists and is admin
  shell: >
    {{ BIN_COMPOSE }} exec -e OPENPROJECT_ADMIN_PASSWORD={{ OPENPROJECT_ADMINISTRATOR_PASSWORD | quote }} web bash -c "
      cd /app &&
      bundle exec rails runner \"
        pw = ENV['OPENPROJECT_ADMIN_PASSWORD']
        u = User.find_by(login: '{{ OPENPROJECT_ADMINISTRATOR_USERNAME }}')
        if u.nil?
          u = User.new(
            login: '{{ OPENPROJECT_ADMINISTRATOR_USERNAME }}',
            mail: '{{ OPENPROJECT_ADMINISTRATOR_EMAIL }}',
            firstname: 'Admin',
            lastname: 'User',
            password: pw,
            password_confirmation: pw
          )
          u.admin = true
          u.save!
          puts 'Administrator {{ OPENPROJECT_ADMINISTRATOR_USERNAME }} created and set as admin.'
        else
          u.admin = true
          u.save!
          puts 'User {{ OPENPROJECT_ADMINISTRATOR_USERNAME }} updated to admin.'
        end
      \"
    "
  args:
    chdir: "{{ lookup('docker', application_id, 'directories.instance') }}"
  async: "{{ ASYNC_TIME if ASYNC_ENABLED | bool else omit }}"
  poll: "{{ ASYNC_POLL if ASYNC_ENABLED | bool else omit }}"
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"
