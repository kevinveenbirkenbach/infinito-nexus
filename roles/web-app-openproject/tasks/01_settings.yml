---
# This task file applies OpenProject settings safely.
# It waits for the web container to be running, ensures migrations are applied,
# then sets all configured settings via rails runner fed from STDIN (robust quoting).

- name: Wait until OpenProject web container is running
  shell: >
    container inspect -f '{{"{{"}}.State.Status{{"}}"}}' {{ OPENPROJECT_WEB_CONTAINER }}
  register: openproject_web_state
  retries: 60
  delay: 5
  until: openproject_web_state.stdout.strip() == "running"
  changed_when: false

- name: Check for pending migrations (non-fatal)
  shell: >
    {{ BIN_COMPOSE }} exec {{ OPENPROJECT_WEB_SERVICE }} bash -lc
    "cd /app && bin/rails db:abort_if_pending_migrations RAILS_ENV=production"
  args:
    chdir: "{{ lookup('container', application_id, 'directories.instance') }}"
  register: openproject_pending_migrations_check
  failed_when: false
  changed_when: false

- name: Run migrations if pending
  shell: >
    {{ BIN_COMPOSE }} exec {{ OPENPROJECT_WEB_SERVICE }} bash -lc
    "cd /app && bin/rails db:migrate RAILS_ENV=production"
  args:
    chdir: "{{ lookup('container', application_id, 'directories.instance') }}"
  when: openproject_pending_migrations_check.rc != 0
  register: openproject_migrate
  retries: 30
  delay: 10
  until: openproject_migrate.rc == 0

- name: Wait until OpenProject web container is running (after migrations)
  shell: >
    container inspect -f '{{"{{"}}.State.Status{{"}}"}}' {{ OPENPROJECT_WEB_CONTAINER }}
  register: openproject_web_state_after_migrate
  retries: 60
  delay: 5
  until: openproject_web_state_after_migrate.stdout.strip() == "running"
  changed_when: false

- name: Set settings in OpenProject (rails runner via STDIN; robust quoting + booleans)
  shell: >
    {{ BIN_COMPOSE }} exec {{ OPENPROJECT_WEB_SERVICE }} bash -lc
    "cd /app && cat | bundle exec rails runner -"
  args:
    chdir: "{{ lookup('container', application_id, 'directories.instance') }}"
    stdin: |
      {% for kv in (OPENPROJECT_RAILS_SETTINGS | dict2items) %}
      Setting[:{{ kv.key }}] = {{ kv.value | to_json }}
      {% endfor %}
  register: openproject_apply_settings
  retries: 30
  delay: 5
  until: openproject_apply_settings.rc == 0
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"
