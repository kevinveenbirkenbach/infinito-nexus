- name: Run DB migrations (OpenProject)
  shell: >
    docker compose run --rm {{ OPENPROJECT_SEEDER_SERVICE }} bash -lc
    "cd /app && RAILS_ENV={{ ENVIRONMENT | lower }} bin/rails db:migrate"
  args:
    chdir: "{{ docker_compose.directories.instance }}"
  register: openproject_migrate
  changed_when: openproject_migrate.rc == 0
  failed_when: openproject_migrate.rc != 0

- name: Clear schema cache
  shell: >
    docker compose run --rm {{ OPENPROJECT_SEEDER_SERVICE }} bash -lc
    "cd /app && RAILS_ENV={{ ENVIRONMENT | lower }} bin/rails db:schema:cache:clear"
  args:
    chdir: "{{ docker_compose.directories.instance }}"