---
- name: "For '{{ application_id }}': include role to receive certs & do modification routines"
  include_role:
    name: srv-composer
  vars:
    domain: "{{ item }}"
    http_port:   "{{ ports.localhost.http[application_id] }}"
  loop:
    - "{{ domains | get_domain('web-app-mailu') }}"
    - "{{ domain }}"

- name: "For '{{ application_id }}': load docker and db"
  include_role: 
    name: cmp-db-docker
  vars:
    docker_compose_flush_handlers: true 
    
- name: "For '{{ application_id }}': configure {{ domains | get_domain(application_id) }}.conf"
  template: 
    src: roles/srv-proxy-core/templates/vhost/basic.conf.j2 
    dest: "{{ NGINX.DIRECTORIES.HTTP.SERVERS }}{{ domains | get_domain(application_id) }}.conf"
  notify: restart openresty

- name: "For '{{ application_id }}': include tasks update-repository-with-files.yml"
  include_tasks: utils/update-repository-with-files.yml
  vars:
    detached_files: 
      - "docker-compose.yml"