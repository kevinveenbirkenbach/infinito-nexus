- name: Include dependencies
  include_role:
    name: '{{ item }}'
  loop:
    - dev-git
    - dev-make
    - dev-nix

- name: Ensure OpenSSH client is installed
  package:
    name: openssh
    state: present
  become: true

- name: Ensure GitHub host key is in known_hosts
  known_hosts:
    path: "~/.ssh/known_hosts"
    name: github.com
    key: "{{ lookup('pipe', 'ssh-keyscan -t ed25519 github.com | grep -v \"^#\"') }}"
  become: true
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

- name: Create installation directory for Kevin's Package Manager
  file:
    path: "{{ PKGMGR_INSTALL_PATH }}"
    state: directory
    mode: '0755'
  become: true

- name: Check if pkgmgr git repo already exists
  stat:
    path: "{{ PKGMGR_INSTALL_PATH }}/.git"
  register: pkgmgr_git_repo
  become: true

- name: Remove legacy 'latest' tag from existing pkgmgr repo (if present)
  command: git tag -d latest
  args:
    chdir: "{{ PKGMGR_INSTALL_PATH }}"
  when: pkgmgr_git_repo.stat.exists
  ignore_errors: true
  become: true

- name: Clone Kevin's Package Manager repository (always latest HEAD)
  git:
    repo:     "{{ PKGMGR_REPO_URL }}"
    dest:     "{{ PKGMGR_INSTALL_PATH }}"
    version:  "HEAD"
    force:    yes
    depth:    1
  become: true

- name: create config.yaml
  template:
    src: config.yaml.j2
    dest: "{{ PKGMGR_CONFIG_PATH }}"
  become: true

- name: Run the Package Manager install command to create an alias for Kevins package manager
  shell: |
    source ~/.venvs/pkgmgr/bin/activate
    make setup
  args:
    chdir: "{{ PKGMGR_INSTALL_PATH }}"
    executable: /bin/bash
  become: true

- name: "Update all repositories with pkgmgr"
  command: "pkgmgr update --all --clone-mode shallow"
  when: MODE_UPDATE | bool

- include_tasks: utils/once/flag.yml
