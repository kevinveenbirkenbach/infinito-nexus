- name: "Render LDAP CLI helper"
  template:
    src: ldap/cli.php.j2
    dest: "{{ JOOMLA_LDAP_CONF_FILE }}"
    mode: "0644"
  when: JOOMLA_LDAP_ENABLED | bool
  notify: docker compose restart

- block:
  - name: "Ensure ldapautocreate plugin hostdir exists"
    file:
      path: "{{ JOOMLA_LDAP_AUT_CRT_HOST_DIR }}"
      state: directory
      mode: "0755"

  - name: "Deploy ldapautocreate plugin files"
    copy:
      src: "ldapautocreate.{{ item }}"
      dest: "{{ [ JOOMLA_LDAP_AUT_CRT_HOST_DIR, 'ldapautocreate.' ~ item ] | path_join }}"
      mode: "0644"
    notify: docker compose restart
    loop:
      - php
      - xml
  when: JOOMLA_LDAP_AUTO_CREATE_ENABLED | bool

- name: "Deploy LDAP diagnose CLI"
  template:
    src: ldap/diagnose.php.j2
    dest: "{{ docker_compose.directories.volumes }}/cli-ldap-diagnose.php"
    mode: "0644"
  when: MODE_DEBUG | bool

- name: "Deploy Joomla plugin inspector CLI (list state)"
  template:
    src: ldap/plugins.php.j2
    dest: "{{ docker_compose.directories.volumes }}/cli-plugins.php"
    mode: "0644"
  when: MODE_DEBUG | bool

- name: "Deploy Joomla auth trace CLI"
  template:
    src: ldap/auth-trace.php.j2
    dest: "{{ docker_compose.directories.volumes }}/cli-ldap-auth-trace.php"
    mode: "0644"
  when: MODE_DEBUG | bool
