---

- name: "Ensure base directory"
  ansible.builtin.file:
    path: "{{ PATH_INFINITO_SECRETS_DIR }}"
    state: directory
    owner: "{{ SYS_TOKEN_STORE_OWNER }}"
    group: "{{ SYS_TOKEN_STORE_GROUP }}"
    mode: "{{ SYS_TOKEN_STORE_DIR_MODE }}"
  become: true

- name: "Ensure store file exists"
  ansible.builtin.file:
    path: "{{ PATH_INFINITO_TOKENS }}"
    state: touch
    owner: "{{ SYS_TOKEN_STORE_OWNER }}"
    group: "{{ SYS_TOKEN_STORE_GROUP }}"
    mode: "{{ SYS_TOKEN_STORE_FILE_MODE }}"
  become: true

- name: "Load existing store"
  ansible.builtin.import_tasks: 02_load.yml

- name: "Hydrate users tokens from store (users wins if non-empty)"
  ansible.builtin.set_fact:
    users: "{{ users | default({}) | hydrate_users_tokens(sys_token_store_users | default({})) }}"
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

- include_tasks: utils/once/flag.yml
