---
# REQUIRED:
#   sys_token_store_user_key
#   sys_token_store_app
#
# OUTPUT:
#   sys_token_store_token

- name: "sys-token-store | Ensure store exists"
  ansible.builtin.import_tasks: 01_core.yml

- name: "sys-token-store | Load existing store"
  ansible.builtin.import_tasks: load.yml

- name: "sys-token-store | Read token from users (preferred)"
  ansible.builtin.set_fact:
    sys_token_store_users_token: >-
      {{
        (
          users.get(sys_token_store_user_key, {})
          .get('tokens', {})
          .get(sys_token_store_app, '')
        )
        | default('', true)
        | string
        | trim
      }}
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

- name: "sys-token-store | Read token from store (fallback)"
  ansible.builtin.set_fact:
    sys_token_store_store_token: >-
      {{
        (
          sys_token_store_users.get(sys_token_store_user_key, {})
          .get('tokens', {})
          .get(sys_token_store_app, '')
        )
        | default('', true)
        | string
        | trim
      }}
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

- name: "sys-token-store | Resolve token (users > store > '')"
  ansible.builtin.set_fact:
    sys_token_store_token: >-
      {{
        sys_token_store_users_token
        if (sys_token_store_users_token != '')
        else sys_token_store_store_token
      }}
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"
