- include_tasks: utils/once/flag.yml

- name: Include dependencies
  include_role:
    name: "sys-hostname"
  when: not (run_once_sys_hostname | default(false) | bool)

- block:
  - name: "Check if Mail Host is reachable"
    uri:
      url: "{{ lookup('tls', 'web-app-mailu', 'url.base') }}"
      method: HEAD
      validate_certs: yes
      status_code: "{{ mailu_valid_status_codes }}"
    register: mail_host_reachability
    failed_when: false
    changed_when: false
    when:
      - run_once_web_app_mailu is not defined

  - name: "Load Mailu Routines for '{{ role_name }}'"
    include_tasks: 02_mailu.yml
    when:
      - >
          (
            mail_host_reachability is defined and
            (mail_host_reachability.status | default(0) | int)
              not in mailu_valid_status_codes
          )
          or
          (
            (users['no-reply'].tokens | default({})).get('web-app-mailu', '') | length == 0
          )
  vars:
    mailu_valid_status_codes: "{{ applications | get_app_conf('web-app-mailu','server.status_codes.default') }}"
  when:
    - "'web-app-mailu' in group_names"

- name: Setup emails via localhost
  include_role:
    name: sys-svc-mail-smtp
  when: 
    - run_once_sys_svc_mail_smtp is not defined
    - not (SYSTEM_EMAIL_EXTERNAL | bool)

- name: Setup msmtp client
  include_role:
    name: sys-svc-mail-msmtp
  when: 
    - run_once_sys_svc_mail_msmtp is not defined
