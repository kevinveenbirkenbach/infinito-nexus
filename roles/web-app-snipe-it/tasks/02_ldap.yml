# @See https://raw.githubusercontent.com/snipe/snipe-it/master/app/Models/Setting.php
---

- name: Configure Snipe-IT LDAP
  ansible.builtin.script: ldap.sh
  args:
    chdir: "{{ docker_compose.directories.instance }}"
  environment:
    SNIPE_IT_SERVICE: "{{ SNIPE_IT_SERVICE }}"
    APP_KEY: "{{ SNIPE_IT_APP_KEY }}"
    LDAP_SERVER_URI: "{{ LDAP.SERVER.URI }}"
    LDAP_SERVER_PORT: "{{ LDAP.SERVER.PORT }}"
    LDAP_BIND_DN: "{{ LDAP.DN.ADMINISTRATOR.DATA }}"
    LDAP_BIND_PASSWORD_B64: "{{ LDAP.BIND_CREDENTIAL | b64encode }}"
    LDAP_BASEDN: "{{ LDAP.DN.OU.USERS }}"
    LDAP_FILTER_USERS_ALL: "{{ SNIPE_IT_LDAP_FILTER_FRAGMENT }}"
    LDAP_USER_ID_ATTR: "{{ LDAP.USER.ATTRIBUTES.ID }}"
    LDAP_USER_FIRSTNAME_ATTR: "{{ SNIPE_IT_LDAP_USER_FIRSTNAME }}"
    LDAP_USER_SURNAME_ATTR: "{{ LDAP.USER.ATTRIBUTES.SURNAME }}"
    LDAP_USER_MAIL_ATTR: "{{ LDAP.USER.ATTRIBUTES.MAIL }}"
    LDAP_AUTH_FILTER_QUERY: "{{ SNIPE_IT_LDAP_AUTH_FILTER_QUERY }}"
    OIDC_RESET_URL: "{{ OIDC.CLIENT.RESET_CREDENTIALS }}"
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"
