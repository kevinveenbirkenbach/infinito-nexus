---
- name: "Check if Snipe-IT admin user already exists (by username)"
  ansible.builtin.command:
    argv:
      - docker
      - compose
      - -f
      - /opt/compose/snipe-it/docker-compose.yml
      - -f
      - /opt/compose/snipe-it/docker-compose.ca.override.yml
      - exec
      - -T
      - -e
      - "APP_KEY={{ SNIPE_IT_APP_KEY }}"
      - snipe-it
      - php
      - -r
      - |
        require "vendor/autoload.php";
        $app = require "bootstrap/app.php";
        $app->make(Illuminate\Contracts\Console\Kernel::class)->bootstrap();
        $exists = \App\Models\User::where("username", "{{ users.administrator.username }}")
          ->whereNull("deleted_at")
          ->exists();
        exit($exists ? 0 : 1);
  register: snipe_it_admin_exists
  changed_when: false
  failed_when: false

- name: "Create Snipe-IT administrator account"
  ansible.builtin.shell: >
    docker compose {{ lookup('compose_f_args', application_id) }} exec -T
    -e APP_KEY="{{ SNIPE_IT_APP_KEY }}"
    {{ SNIPE_IT_SERVICE }}
    php artisan snipeit:create-admin
    --first_name "System"
    --last_name "Administrator"
    --username "{{ users.administrator.username }}"
    --email "{{ users.administrator.email }}"
    --password {{ users.administrator.password | quote }}
    --no-interaction
  args:
    chdir: "{{ lookup('docker', application_id, 'directories.instance') }}"
  when: snipe_it_admin_exists.rc != 0
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"
