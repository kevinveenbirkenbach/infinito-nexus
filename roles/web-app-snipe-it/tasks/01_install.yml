- name: Wait until application container is up
  shell: "docker compose ps -q {{ SNIPE_IT_SERVICE }}"
  args:
    chdir: "{{ docker_compose.directories.instance }}"
  register: snipeit_app_id
  retries: 30
  delay: 5
  until: snipeit_app_id.stdout | length > 0
  changed_when: false

- name: "Wait until the Snipe-IT Service is available"
  uri:
    url: "{{ SNIPE_IT_URL }}"
    method: GET
    return_content: no
    status_code: 200
  register: snipeit_admin_check
  retries: 30
  delay: 5
  until: snipeit_admin_check.status == 200
  when: not ( SNIPE_IT_OAUTH2_ENABLED | bool )

- name: Run Snipe-IT migrations (idempotent)
  shell: |
    docker compose exec -T \
      -e APP_KEY="{{ SNIPE_IT_APP_KEY }}" \
      -e XDG_CONFIG_HOME=/tmp \
      {{ SNIPE_IT_SERVICE }} \
      php artisan migrate --force
  args:
    chdir: "{{ docker_compose.directories.instance }}"
  register: snipeit_migrate
  changed_when: >
    ('Migrating:' in snipeit_migrate.stdout)
    or ('Migrated:' in snipeit_migrate.stdout)
  failed_when: snipeit_migrate.rc != 0

- name: Seed Snipe-IT database (optional, safe to rerun if seeder is idempotent)
  shell: |
    docker compose exec -T \
      -e APP_KEY="{{ SNIPE_IT_APP_KEY }}" \
      -e XDG_CONFIG_HOME=/tmp \
      {{ SNIPE_IT_SERVICE }} \
      php -d memory_limit=512M artisan db:seed --force
  args:
    chdir: "{{ docker_compose.directories.instance }}"
  register: snipeit_seed
  changed_when: "'Seeding:' in snipeit_seed.stdout"
  failed_when: snipeit_seed.rc != 0
