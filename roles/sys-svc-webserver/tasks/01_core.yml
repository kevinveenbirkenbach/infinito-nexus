- name: "cleanup (if enabled)"
  include_tasks: 02_cleanup.yml
  when: >
    MODE_CLEANUP | bool or
    MODE_RESET | bool

- name: "reset (if enabled)"
  include_tasks: 03_reset.yml
  when: MODE_RESET | bool

- name: "Load variables from {{ DOCKER_VARS_FILE }} for {{ role_name }}/{{ application_id }}"
  include_vars: "{{ DOCKER_VARS_FILE }}"

- name: "Load docker compose handlers"
  include_tasks: "{{ playbook_dir }}/tasks/utils/load_handlers.yml"
  vars:
    handler_role_name: "docker-compose"

- name: "Include tasks to create directories"
  include_tasks: 04_directories.yml

- name: create nginx config file
  template: 
    src:  nginx.conf.j2
    dest: "{{ NGINX.FILES.CONFIGURATION }}"
  notify: docker compose up

- name: Include openresty
  # Outside of run_once block is necessary for handler loading
  # Otherwise the when: condition from the block is added to the handlers
  # Inside openresty their is a validation that it doesn't run multiple times
  include_role:
    name: svc-prx-openresty

    # Explicit set to guaranty that application_id will not be overwritten.
    # Should be anyhow the default case
    public: false

  vars:
    # Flush openresty handler on first run, so that openresty is up, before openresty related handlers are triggered
    flush_handlers: true
  when: run_once_svc_prx_openresty is not defined

- name: Include health dependencies
  include_role:
    name: "{{ item }}"
  loop:
    - sys-ctl-hlth-webserver
    - sys-ctl-hlth-csp
  vars:
    flush_handlers: false

- include_tasks: utils/run_once.yml
