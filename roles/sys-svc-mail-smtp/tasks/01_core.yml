- include_tasks: utils/once/flag.yml

- name: "Ensure msmtp-mta is absent (conflicts with postfix smtp-forwarder)"
  package:
    name:
      - msmtp-mta
    state: absent

- name: "Install local SMTP relay (Postfix)"
  package:
    name:
      - postfix
      - postfix-lmdb
    state: present

- name: "Configure Postfix as localhost-only relay"
  ansible.builtin.template:
    src: "postfix-main.cf.j2"
    dest: "/etc/postfix/main.cf"
    mode: "0644"
  notify: reload postfix

- name: "Deploy postfix aliases"
  ansible.builtin.template:
    src: "aliases.j2"
    dest: "/etc/postfix/aliases"
    mode: "0644"
  notify: reload postfix

- name: "Build alias database"
  ansible.builtin.command: newaliases
  changed_when: false
  notify: reload postfix

- name: "Ensure postfix is enabled and running"
  ansible.builtin.systemd:
    name: postfix
    enabled: true
    state: started