- include_tasks: utils/once/flag.yml

- name: "Disable MSMTP to avoid port conflicts"
  include_tasks: "{{ [playbook_dir, 'roles/sys-svc-mail-msmtp/tasks/disable.yml' ] | path_join }}"

- name: Include dependency 'sys-daemon'
  include_role:
    name: sys-daemon
  when: run_once_sys_daemon is not defined

- name: "Install local SMTP relay (Postfix)"
  package:
    name:
      - postfix
      - postfix-lmdb
    state: present

- name: "Configure Postfix as localhost-only relay"
  ansible.builtin.template:
    src: "postfix-main.cf.j2"
    dest: "/etc/postfix/main.cf"
    mode: "0644"
  notify: restart postfix

- name: "Deploy postfix aliases"
  ansible.builtin.template:
    src: "aliases.j2"
    dest: "/etc/postfix/aliases"
    mode: "0644"
  notify: restart postfix

- name: "Build alias database"
  ansible.builtin.command: newaliases
  changed_when: false
  notify: restart postfix
