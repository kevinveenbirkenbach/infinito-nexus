# run_once_sys_front_inj_matomo: deactivated

- name: Include Token Store
  include_role:
    name: sys-token-store
  when: run_once_sys_token_store is not defined

- name: Fail if Matomo token is empty string
  ansible.builtin.fail:
    msg: "Matomo token users.administrator.tokens['web-app-matomo'] is set but empty. Please provide a non-empty token."
  when: (users.administrator.tokens['web-app-matomo'] | default('') | string | trim) == ""

- name: "Check if site {{ domain }} is already registered at Matomo"
  ansible.builtin.uri:
    url: "{{ matomo_index_php_url }}?module=API&method=SitesManager.getSitesIdFromSiteUrl&url={{ WEB_PROTOCOL }}://{{ base_domain }}&format=json&token_auth={{ users.administrator.tokens['web-app-matomo'] }}"
    method: GET
    return_content: yes
    status_code: 200
    validate_certs: yes
  register: site_check
  failed_when: false
  retries: 30
  delay: 2
  until: site_check.status is defined and site_check.status == 200
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

- name: "Matomo site check failed"
  ansible.builtin.fail:
    msg: >-
      Matomo site verification failed for {{ domain }}.
      HTTP status={{ site_check.status | default('n/a') }}
      msg={{ site_check.msg | default('n/a') }}
      {% if not (MASK_CREDENTIALS_IN_LOGS | bool) %}
      content={{ site_check.content | default('n/a') }}
      {% endif %}
  when: site_check.status is not defined or site_check.status != 200

- name: Set matomo_site_id to Null
  set_fact:
    matomo_site_id:

- name: Set fact for site ID if site already exists
  set_fact:
    matomo_site_id: "{{ site_check.json[0].idsite }}"
  when: "(site_check.json | length) > 0"
  changed_when: false

- name: Add site to Matomo and get ID if not exists
  ansible.builtin.uri:
    url: "{{ matomo_index_php_url }}"
    method: POST
    body: "module=API&method=SitesManager.addSite&siteName={{ base_domain }}&urls={{ WEB_PROTOCOL }}://{{ base_domain }}&format=json&token_auth={{ users.administrator.tokens['web-app-matomo'] }}"
    body_format: form-urlencoded
    status_code: 200
    return_content: yes
    validate_certs: yes
  register: add_site
  when: "matomo_site_id is not defined or matomo_site_id is none"
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

- name: Set fact for site ID if site was added
  set_fact:
    matomo_site_id: "{{ add_site.json.value }}"
  when: "matomo_site_id is not defined or matomo_site_id is none"
  changed_when: false

- name: Load Matomo tracking JS template
  set_fact:
    matomo_tracking_code: "{{ lookup('template','matomo-tracking.js.j2') }}"

- name: Collapse Matomo code into one-liner
  set_fact:
    matomo_tracking_code_one_liner: "{{ matomo_tracking_code | to_one_liner }}"

- name: Append Matomo CSP hash
  set_fact:
    applications: "{{ applications | append_csp_hash(application_id, matomo_tracking_code_one_liner) }}"
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"
  changed_when: false
