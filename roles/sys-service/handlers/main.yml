- name: "Enable systemctl service"
  systemd:
    name: "{{ system_service_name }}"
    enabled: yes
    daemon_reload: true
  become: true
  async:  "{{ system_service_async }}"
  poll:   "{{ system_service_poll }}"
  listen: refresh systemctl service
  when: not (DOCKER_IN_CONTAINER | bool)

- name: "Set systemctl service state"
  systemd:
    name: "{{ system_service_name }}"
    state: "{{ system_service_state }}"
  become: true
  async:  "{{ system_service_async }}"
  poll:   "{{ system_service_poll }}"
  when:   
    - not (system_service_suppress_flush | bool)
    - not (DOCKER_IN_CONTAINER | bool)
  listen: refresh systemctl service

- name: "Run systemctl service script in container"
  command: "{{ system_service_script_exec }}"
  become: true
  register: system_service_script_run
  changed_when: system_service_script_run.rc == 0
  failed_when: >
    system_service_script_run.rc != 0 and (
      ('System has not been booted with systemd' not in (system_service_script_run.stderr | default(''))) and
      ('Failed to connect to system scope bus' not in (system_service_script_run.stderr | default(''))) and
      ("Can't operate." not in (system_service_script_run.stderr | default('')))
    )
  listen: refresh systemctl service
  when:
    - DOCKER_IN_CONTAINER | bool
    - not (system_service_suppress_flush | bool)
    - system_service_state | default('') == 'restarted'
    - system_service_script_exec | default('') | length > 0
