- name: Build data (single async task)
  shell: |
    set -euo pipefail
    infinito build tree --no-signal --alarm-timeout 0 -s {{ mig_roles_meta_volume }}
    infinito build roles_list --no-signal --alarm-timeout 0 -o {{ mig_roles_meta_list }}
  async: "{{ (3600 if ASYNC_ENABLED | bool else omit) | default(omit) }}"
  poll:  "{{ ASYNC_POLL if ASYNC_ENABLED | bool else omit }}"
  register: mig_build_job

- name: Fail if MIG build job did not start
  fail:
    msg: >
      MIG build job failed to start. No job ID returned.
  when: mig_build_job.ansible_job_id is not defined
