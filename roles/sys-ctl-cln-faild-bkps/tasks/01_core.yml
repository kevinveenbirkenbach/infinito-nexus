- name: Include dependencies
  include_role:
    name: '{{ item }}'
  loop:
    - sys-ctl-alm-compose
    - sys-lock
    - sys-daemon

- name: "Install '{{ CLEANUP_FAILED_BACKUPS_PKG }}' via pip"
  include_role:
    name: sys-pip-install
  vars:
    package_name: '{{ CLEANUP_FAILED_BACKUPS_PKG }}'

- include_role:
    name: sys-service
  vars:
    system_service_timer_enabled:       true
    system_service_on_calendar:         "{{ SYS_SCHEDULE_CLEANUP_FAILED_BACKUPS }}"
    system_service_copy_files:          false
    system_service_tpl_on_failure:      "{{ SYS_SERVICE_ON_FAILURE_COMPOSE }}"
    system_service_tpl_exec_start_pre:  '/usr/bin/python {{ PATH_SYSTEM_LOCK_SCRIPT }} {{ SYS_SERVICE_GROUP_MANIPULATION | join(" ")  }} --ignore {{ SYS_SERVICE_GROUP_CLEANUP| join(" ") }} --timeout "{{ SYS_TIMEOUT_CLEANUP_SERVICES }}"'
    system_service_tpl_exec_start: >-
      /bin/sh -c "{{ CLEANUP_FAILED_BACKUPS_PKG }}
      --backups-root {{ PATH_INFINITO_BACKUP_DIR | quote }}
      --all
      --force-keep {{ CLEANUP_FAILED_BACKUPS_FORCE_KEEP }}
      --workers {{ CLEANUP_FAILED_BACKUPS_WORKERS }}
      --yes"

- include_tasks: utils/once/flag.yml
