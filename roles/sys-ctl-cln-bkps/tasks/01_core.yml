- name: Include dependencies
  include_role:
    name: '{{ item }}'
  loop:
  - dev-python-pip
  - sys-ctl-alm-compose
  - sys-lock

- name: install lsof and python-psutil
  package:
    name:
    - lsof
    - python-psutil
    state: present

- include_role:
    name: sys-service
  vars:
    system_service_tpl_on_failure:      "{{ SYS_SERVICE_ON_FAILURE_COMPOSE }}"
    system_service_tpl_exec_start:      "{{ system_service_script_exec }} --backups-folder-path {{ BACKUPS_FOLDER_PATH }} --maximum-backup-size-percent {{ SIZE_PERCENT_MAXIMUM_BACKUP }}"
    system_service_tpl_exec_start_pre:  '/usr/bin/python {{ PATH_SYSTEM_LOCK_SCRIPT }} {{ SYS_SERVICE_GROUP_MANIPULATION | join(" ")  }} --ignore {{ SYS_SERVICE_GROUP_CLEANUP | join(" ") }} --timeout "{{ SYS_TIMEOUT_BACKUP_SERVICES }}"'
    system_service_copy_files:          true
    system_service_force_linear_sync:   false

- meta: flush_handlers

- include_tasks: utils/once/flag.yml
