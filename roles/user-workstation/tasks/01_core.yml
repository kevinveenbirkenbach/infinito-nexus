- name: Validate WORKSTATION_USER is defined
  ansible.builtin.fail:
    msg: "WORKSTATION_USER must be defined (e.g. WORKSTATION_USER: biber)."
  when: WORKSTATION_USER is not defined or (WORKSTATION_USER | string | length) == 0

- name: Validate users.<WORKSTATION_USER> exists
  ansible.builtin.fail:
    msg: "users.{{ WORKSTATION_USER }} must be defined."
  when: users is not defined or users[WORKSTATION_USER] is not defined

- name: Ensure primary group exists
  ansible.builtin.group:
    name: "{{ USER_WORKSTATION_USERNAME }}"
    gid: "{{ USER_WORKSTATION_GID | default(omit) }}"
    state: present

- name: Create workstation user
  ansible.builtin.user:
    name: "{{ USER_WORKSTATION_USERNAME }}"
    uid: "{{ USER_WORKSTATION_UID }}"
    group: "{{ USER_WORKSTATION_USERNAME }}"
    groups: "{{ USER_WORKSTATION_GROUPS }}"
    shell: "{{ USER_WORKSTATION_SHELL }}"
    create_home: true
    update_password: on_create
    password: >-
      {{
        (USER_WORKSTATION_SET_PASSWORD | bool)
        | ternary((users[USER_WORKSTATION_KEY].password | password_hash('sha512')), omit)
      }}
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | default(true) | bool }}"

- name: Deploy workstation user environment via shared user role
  ansible.builtin.include_role:
    name: user
  vars:
     user_key: "{{ USER_WORKSTATION_KEY }}"

- name: Enable sudo via sudoers drop-in (optional)
  ansible.builtin.template:
    src: sudoers.j2
    dest: "/etc/sudoers.d/{{ USER_WORKSTATION_USERNAME }}"
    owner: root
    group: root
    mode: "0440"
  when: USER_WORKSTATION_ENABLE_SUDO | bool

- include_tasks: utils/once/flag.yml
