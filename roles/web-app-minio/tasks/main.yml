---
- name: "load docker and db for {{ application_id }}"
  include_role:
    name: sys-stk-backend
  vars:
    docker_compose_flush_handlers:        true
    docker_git_repository_pull:           false

- name: "Include role sys-stk-front-proxy for '{{ application_id }}'"
  include_role:
    name: sys-stk-front-proxy
  vars:
    domain:    "{{ minio_proxy.domain }}"
    http_port: "{{ minio_proxy.http_port }}"
  loop: "{{ MINIO_FRONT_PROXY_MATRIX }}"
  loop_control:
    loop_var: minio_proxy
    label: "{{ minio_proxy.domain }} -> {{ minio_proxy.http_port }}"

- block:
    - name: "Check policy (RAW with slash) exists"
      no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"
      shell: >
        {{ BIN_CONTAINER }} run --rm
        -e MC_HOST_minio={{ MINIO_MC_HOST_ENV | quote }}
        {{ MINIO_MC_IMAGE }}
        admin policy info minio {{ MINIO_OIDC_POLICY_NAME | quote }}
      register: mc_policy_info_raw
      failed_when: false
      changed_when: false

    - name: "Create policy (RAW with slash) if missing"
      shell: |
        set -euo pipefail
        printf '%s' '{{ (MINIO_OIDC_POLICY_CONTENT | from_yaml | to_json) | b64encode }}' \
          | base64 -d \
          | {{ BIN_CONTAINER }} run --rm -i \
              -e MC_HOST_minio={{ MINIO_MC_HOST_ENV | quote }} \
              {{ MINIO_MC_IMAGE }} \
              admin policy create minio {{ MINIO_OIDC_POLICY_NAME | quote }} /dev/stdin
      args: { executable: /bin/bash }
      no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"
      async: "{{ ASYNC_TIME if ASYNC_ENABLED | bool else omit }}"
      poll:  "{{ ASYNC_POLL if ASYNC_ENABLED | bool else omit }}"
      when:
        - mc_policy_info_raw.rc != 0

  when: MINIO_OIDC_ENABLED | bool
