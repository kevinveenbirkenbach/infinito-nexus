- name: Set default docker_repository_path
  set_fact:
    docker_repository_path: "{{ [ lookup('docker', application_id, 'directories.services'), 'repository/' ] | path_join }}"

- name: Pull docker repository
  git:
    repo:           "{{ docker_git_repository_address }}"
    dest:           "{{ docker_repository_path }}"
    version:        "{{ docker_git_repository_version | default('main') }}"
    single_branch:  yes
    depth:          1
    update:         yes
    recursive:      yes
    force:          yes
    accept_hostkey: yes
  register: docker_repo_pull
  retries: 12
  delay: 30
  until: docker_repo_pull is succeeded
  notify:
    - docker compose build
    - docker compose up
  become: true
