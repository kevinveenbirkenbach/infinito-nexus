- include_tasks: 01_core.yml
  when: run_once_sys_svc_compose is not defined

# This could lead to problems in sys-svc-compose directories which are based on a git repository
# @todo Verify that this isn't the case. E.g. in accounting
- name: "Create all sys-svc-compose directories (including parent directories) for '{{ application_id }}'"
  file:
    path: "{{ item.value }}"
    state: directory
    mode: '0755'
  with_dict: "{{ lookup('docker', application_id, 'directories') }}"

- name: "Include routines to set up a git repository based installation for '{{ application_id }}'."
  include_tasks: "03_repository.yml"
  when: docker_git_repository_pull | bool

- name: "Include file management routines for '{{ application_id }}'."
  include_tasks: "04_files.yml"

- name: "Ensure CA trust assets are installed (only when needed)"
  ansible.builtin.include_role:
    name: sys-svc-compose-ca
  when:
    - domains | has_domain(application_id)
    - lookup('tls_resolve', application_id, want='enabled') | bool
    - lookup('tls_resolve', application_id, want='mode') == 'self_signed'

- name: "Ensure that {{ lookup('docker', application_id, 'directories.instance') }} is up"
  include_tasks: "utils/up.yml"
