- include_tasks: utils/once/flag.yml

- include_role:
    name:   sys-svc-container
    public: false
  when: run_once_sys_svc_container is not defined

- name: Remove all docker compose pull locks
  file:
    path: "{{ PATH_COMPOSE_PULL_LOCK_DIR }}"
    state: absent

- name: "reset (if enabled) for {{ role_name}}"
  include_tasks: 02_reset.yml
  when: MODE_RESET | bool

- name: "create {{ PATH_COMPOSE_INSTANCES }}"
  file:
    path:   "{{ PATH_COMPOSE_INSTANCES }}"
    state:  directory
    mode:   0700
    owner:  root
    group:  root

- name: Install compose wrapper
  become: true
  ansible.builtin.copy:
    src: "compose.py"
    dest: "{{ PATH_COMPOSE }}"
    mode: "0755"
    owner: root
    group: root

- name: Include backup, repair and health services for docker
  include_role:
    name: "{{ service_role }}"
  loop:
    - sys-ctl-cln-docker
    - sys-ctl-bkp-docker-2-loc
    - sys-ctl-hlth-container
    - sys-ctl-hlth-volumes
    - sys-ctl-rpr-container-hard
  loop_control:
    loop_var: service_role
  when: COMPOSE_LOAD_SERVICES | bool
