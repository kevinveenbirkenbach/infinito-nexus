---
- name: Validate Docker Compose configuration
  ansible.builtin.shell: |
    set -euo pipefail
    docker compose -p {{ application_id | get_entity_name }} \
      {{ lookup('compose_file_args', application_id, include_ca=False) }} \
      {% if lookup('docker', application_id, 'files.env') is file %}--env-file {{ lookup('docker', application_id, 'files.env') }}{% endif %} \
      config --quiet
  args:
    chdir: "{{ lookup('docker', application_id, 'directories.instance') }}"
    executable: /bin/bash
  register: dc_validate
  changed_when: false
  failed_when: dc_validate.rc != 0
  listen:
    - docker compose up
  when: MODE_ASSERT | bool

- name: docker compose pull
  ansible.builtin.script:
    cmd: >-
      pull.py
      --chdir {{ lookup('docker', application_id, 'directories.instance') }}
      --project {{ application_id | get_entity_name }}
      --compose-files {{ lookup('compose_file_args', application_id, include_ca=False) | quote }}
      {% if lookup('docker', application_id, 'files.env') is file %}--env-file {{ lookup('docker', application_id, 'files.env') }}{% endif %}
      --lock-dir {{ DIR_COMPOSE_PULL_LOCK }}
      --lock-key {{ lookup('docker', application_id, 'directories.instance') | hash('sha1') }}
      --attempts 6
      --sleep 20
      --sleep-cap 240
      --ignore-buildable
  register: pull
  changed_when: "'pulled' in pull.stdout"
  environment:
    COMPOSE_HTTP_TIMEOUT: "600"
    DOCKER_CLIENT_TIMEOUT: "600"
  listen:
    - docker compose up

- name: Build docker compose
  ansible.builtin.shell: |
    set -euo pipefail
    docker compose build || {
      echo "Retrying without cache and pulling bases...";
      docker compose build --no-cache --pull;
    }
  args:
    chdir: "{{ lookup('docker', application_id, 'directories.instance') }}"
    executable: /bin/bash
  environment:
    COMPOSE_HTTP_TIMEOUT: "600"
    DOCKER_CLIENT_TIMEOUT: "600"
    DOCKER_BUILDKIT: "1"
    COMPOSE_DOCKER_CLI_BUILD: "1"
  listen:
    - docker compose build

- name: Generate CA trust override
  ansible.builtin.shell: |
    set -euo pipefail
    {{ lookup('compose_ca_inject_cmd', application_id) }}
  args:
    chdir: "{{ lookup('docker', application_id, 'directories.instance') }}"
    executable: /bin/bash
  listen:
    - docker compose up
  when:
    - domains | has_domain(application_id)
    - lookup('tls', application_id, 'enabled') | bool
    - lookup('tls', application_id, 'mode') == 'self_signed'

- name: docker compose up
  ansible.builtin.shell: |
    set -euo pipefail
    {{ BIN_COMPOSE }} up -d --force-recreate --remove-orphans
  register: dc_up
  changed_when: true
  environment:
    COMPOSE_HTTP_TIMEOUT: "600"
    DOCKER_CLIENT_TIMEOUT: "600"
    COMPOSE_PARALLEL_LIMIT: "{{ '4' if (DOCKER_IN_CONTAINER | bool) else omit }}"
  args:
    chdir: "{{ lookup('docker', application_id, 'directories.instance') }}"
    executable: /bin/bash
  listen:
    - docker compose up

- name: Aggressively prune Docker data (keep networks + keep in-use images)
  become: true
  ansible.builtin.shell: |
    set -euo pipefail

    echo "Docker disk usage before cleanup:"
    docker system df || true

    docker container prune -f || true
    docker image prune -af || true
    docker volume prune -f || true

    docker buildx prune -af || true
    docker builder prune -af || true

    echo "Docker disk usage after cleanup:"
    docker system df || true
  args:
    executable: /bin/bash
  changed_when: true
  when: STORAGE_CONSTRAINED | bool
  listen:
    - docker compose up
    - docker compose build
