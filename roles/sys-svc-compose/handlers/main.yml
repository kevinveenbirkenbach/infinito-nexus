---
- name: Validate Docker Compose configuration
  ansible.builtin.shell: |
    set -euo pipefail
    compose config --quiet
  args:
    chdir: "{{ lookup('container', application_id, 'directories.instance') }}"
    executable: /bin/bash
  register: dc_validate
  changed_when: false
  failed_when: dc_validate.rc != 0
  listen:
    - compose up
  when: MODE_ASSERT | bool

- name: compose pull
  ansible.builtin.script:
    cmd: >-
      pull.py
      --chdir {{ lookup('container', application_id, 'directories.instance') }}
      --project {{ application_id | get_entity_name }}
      --compose-files {{ lookup('compose_file_args', application_id, include_ca=False) | quote }}
      {% if lookup('container', application_id, 'files.env') is file %}--env-file {{ lookup('container', application_id, 'files.env') }}{% endif %}
      --lock-dir {{ DIR_COMPOSE_PULL_LOCK }}
      --lock-key {{ lookup('container', application_id, 'directories.instance') | hash('sha1') }}
      --attempts 6
      --sleep 20
      --sleep-cap 240
      --ignore-buildable
  register: pull
  changed_when: "'pulled' in pull.stdout"
  environment:
    COMPOSE_HTTP_TIMEOUT: "600"
    DOCKER_CLIENT_TIMEOUT: "600"
  listen:
    - compose up

- name: Build compose 
  ansible.builtin.shell: |
    set -euo pipefail
    compose build || {
      echo "Retrying without cache and pulling bases...";
      compose build --no-cache --pull;
    }
  args:
    chdir: "{{ lookup('container', application_id, 'directories.instance') }}"
    executable: /bin/bash
  environment:
    COMPOSE_HTTP_TIMEOUT: "600"
    DOCKER_CLIENT_TIMEOUT: "600"
    DOCKER_BUILDKIT: "1"
    COMPOSE_DOCKER_CLI_BUILD: "1"
  listen:
    - compose build

- name: Generate CA trust override
  ansible.builtin.shell: |
    set -euo pipefail
    {{ lookup('compose_ca_inject_cmd', application_id) }}
  args:
    chdir: "{{ lookup('container', application_id, 'directories.instance') }}"
    executable: /bin/bash
  listen:
    - compose up
  when:
    - domains | has_domain(application_id)
    - lookup('tls', application_id, 'enabled') | bool
    - lookup('tls', application_id, 'mode') == 'self_signed'

- name: compose up
  ansible.builtin.shell: |
    set -euo pipefail
    compose up -d --force-recreate --remove-orphans
  register: dc_up
  changed_when: true
  environment:
    COMPOSE_HTTP_TIMEOUT: "600"
    DOCKER_CLIENT_TIMEOUT: "600"
    COMPOSE_PARALLEL_LIMIT: "{{ '4' if (DOCKER_IN_CONTAINER | bool) else omit }}"
  args:
    chdir: "{{ lookup('container', application_id, 'directories.instance') }}"
    executable: /bin/bash
  listen:
    - compose up

- name: Aggressively prune Docker data (keep networks + keep in-use images)
  become: true
  ansible.builtin.shell: |
    set -euo pipefail

    echo "Docker disk usage before cleanup:"
    container system df || true

    container container prune -f || true
    container image prune -af || true
    container volume prune -f || true

    container buildx prune -af || true
    container builder prune -af || true

    echo "Docker disk usage after cleanup:"
    container system df || true
  args:
    executable: /bin/bash
  changed_when: true
  when: STORAGE_CONSTRAINED | bool
  listen:
    - compose up
    - compose build
