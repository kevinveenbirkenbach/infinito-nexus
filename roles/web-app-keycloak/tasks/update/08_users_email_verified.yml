---
# Set emailVerified=true for all configured users from vars.
# Contract:
#   - users is ALWAYS a dict
#   - username is ALWAYS stored in users.<key>.username
#   - dict key is ignored completely

- name: "Set emailVerified=true for all configured users in realm '{{ KEYCLOAK_REALM }}'"
  ansible.builtin.script: set_email_verified.sh
  args:
    chdir: "{{ role_path }}/files"
  environment:
    KEYCLOAK_EXEC_CONTAINER: "{{ KEYCLOAK_EXEC_CONTAINER }}"
    KEYCLOAK_KCADM: "{{ KEYCLOAK_KCADM }}"
    KEYCLOAK_REALM: "{{ KEYCLOAK_REALM }}"
    KEYCLOAK_USERNAME: "{{ item.value.username }}"
    KEYCLOAK_EMAIL_VERIFIED: "true"
  loop: "{{ users | non_reserved_users | dict2items }}"
  loop_control:
    label: "{{ item.value.username }}"
  register: kc_email_verified_updates
  changed_when: true
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"
  async: "{{ ASYNC_TIME if ASYNC_ENABLED | bool else omit }}"
  poll:  "{{ ASYNC_POLL if ASYNC_ENABLED | bool else omit }}"
