# roles/web-app-keycloak/tasks/assert/05_ldap.yml
#
# Read-only assertions for LDAP configuration in Keycloak.
# Ensures:
# - LDAP UserStorageProvider exists
# - ldap-roles mapper exists exactly once
# - groups.path is consistent
# - top-level group for groups.path exists
#
# This file must NEVER modify state.

# ---------------------------------------------------------------------------
# Initialize variables (MUST exist before any when/assert)
# ---------------------------------------------------------------------------

- name: Assert | Initialize LDAP assert variables
  set_fact:
    ldap_cmp_id_assert: ""
    desired_group_mapper_raw_assert: {}
    desired_groups_path_assert: ""
    desired_groups_top_assert: ""
    grp_mapper_ids_assert: []
  changed_when: false

# ---------------------------------------------------------------------------
# Resolve LDAP component id (authoritative, client-side filtered)
# ---------------------------------------------------------------------------

- name: Assert | Resolve LDAP component id
  shell: >
    {{ KEYCLOAK_EXEC_KCADM }} get components -r {{ KEYCLOAK_REALM }} --format json
    | jq -r '
      .[]
      | select(
          .providerType=="org.keycloak.storage.UserStorageProvider"
          and .providerId=="ldap"
          and .name=="{{ KEYCLOAK_LDAP_CMP_NAME }}"
        )
      | .id' | head -n1
  register: ldap_cmp_id_assert_raw
  changed_when: false

- name: Assert | Set LDAP component id fact
  set_fact:
    ldap_cmp_id_assert: "{{ ldap_cmp_id_assert_raw.stdout | trim }}"
  changed_when: false

- name: Assert | LDAP component exists
  assert:
    that:
      - ldap_cmp_id_assert not in ["", "null"]
    fail_msg: "LDAP component '{{ KEYCLOAK_LDAP_CMP_NAME }}' not found in realm '{{ KEYCLOAK_REALM }}'."
  when: MODE_ASSERT | bool

# ---------------------------------------------------------------------------
# Load ldap-roles mapper from dictionary (desired state)
# ---------------------------------------------------------------------------

- name: Assert | Load desired ldap-roles mapper from dictionary
  set_fact:
    desired_group_mapper_raw_assert: >-
      {{
        (
          KEYCLOAK_DICTIONARY_REALM.components['org.keycloak.storage.UserStorageProvider']
          | selectattr('name','equalto', KEYCLOAK_LDAP_CMP_NAME)
          | list | first | default({})
        ).subComponents['org.keycloak.storage.ldap.mappers.LDAPStorageMapper']
        | default([])
        | selectattr('name','equalto','ldap-roles')
        | list | first | default({})
      }}
  changed_when: false

- name: Assert | ldap-roles mapper exists in dictionary
  assert:
    that:
      - desired_group_mapper_raw_assert | length > 0
    fail_msg: "'ldap-roles' mapper missing in KEYCLOAK_DICTIONARY_REALM."
  when: MODE_ASSERT | bool

# ---------------------------------------------------------------------------
# Extract desired groups.path (dictionary)
# ---------------------------------------------------------------------------

- name: Assert | Extract desired groups.path
  when: desired_group_mapper_raw_assert | length > 0
  set_fact:
    desired_groups_path_assert: "{{ (desired_group_mapper_raw_assert.config['groups.path'] | default([])) | first | default('') | trim }}"
    desired_groups_top_assert: "{{ desired_groups_path_assert.lstrip('/') | split('/') | first | default('') }}"
  changed_when: false

- name: Assert | groups.path defined when mapper exists
  when: MODE_ASSERT | bool and desired_group_mapper_raw_assert | length > 0
  assert:
    that:
      - desired_groups_path_assert != ""
    fail_msg: "ldap-roles mapper exists but config.groups.path is empty."

# ---------------------------------------------------------------------------
# Verify ldap-roles mapper instances in Keycloak (actual state)
# ---------------------------------------------------------------------------

- name: Assert | List ldap-roles mappers under LDAP component
  shell: >
    {{ KEYCLOAK_EXEC_KCADM }} get components -r {{ KEYCLOAK_REALM }} --format json
    | jq -r '
      .[]
      | select(
          .parentId=="{{ ldap_cmp_id_assert }}"
          and .providerId=="group-ldap-mapper"
          and .providerType=="org.keycloak.storage.ldap.mappers.LDAPStorageMapper"
          and .name=="ldap-roles"
        )
      | .id'
  register: grp_mapper_ids_assert_raw
  changed_when: false

- name: Assert | Normalize ldap-roles mapper ids
  set_fact:
    grp_mapper_ids_assert: >-
      {{
        (grp_mapper_ids_assert_raw.stdout_lines | default([]))
        | map('trim')
        | reject('equalto','')
        | list
      }}
  changed_when: false

- name: Assert | Exactly one ldap-roles mapper exists
  when: MODE_ASSERT | bool
  assert:
    that:
      - grp_mapper_ids_assert | length == 1
    fail_msg: >-
      Expected exactly ONE 'ldap-roles' mapper under LDAP component,
      found {{ grp_mapper_ids_assert | length }}: {{ grp_mapper_ids_assert }}

# ---------------------------------------------------------------------------
# Verify top-level group for groups.path exists
# ---------------------------------------------------------------------------

- name: Assert | Resolve top-level group id
  when: desired_groups_top_assert | length > 0
  shell: >
    {{ KEYCLOAK_EXEC_KCADM }} get groups -r {{ KEYCLOAK_REALM }} --format json
    | jq -r '.[] | select(.name=="{{ desired_groups_top_assert }}") | .id' | head -n1
  register: groups_top_id_assert
  changed_when: false

- name: Assert | Top-level group exists
  when: MODE_ASSERT | bool and desired_groups_top_assert | length > 0
  assert:
    that:
      - (groups_top_id_assert.stdout | trim) not in ["", "null"]
    fail_msg: >-
      groups.path='{{ desired_groups_path_assert }}' requires top-level group
      '{{ desired_groups_top_assert }}', but it does not exist.

# ---------------------------------------------------------------------------
# Final summary (debug only)
# ---------------------------------------------------------------------------

- name: Assert | LDAP summary
  debug:
    msg:
      ldap_component_id: "{{ ldap_cmp_id_assert }}"
      ldap_roles_mapper_ids: "{{ grp_mapper_ids_assert }}"
      groups_path: "{{ desired_groups_path_assert }}"
      top_group: "{{ desired_groups_top_assert }}"
  when: MODE_ASSERT | bool
