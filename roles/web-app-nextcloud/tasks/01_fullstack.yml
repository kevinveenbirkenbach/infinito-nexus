- name: "include role for {{ application_id }} to receive certs & do modification routines for '{{ NEXTCLOUD_DOMAIN }}:{{ NEXTCLOUD_PORT }}'"
  include_role:
    name: sys-util-csp-cert

- name: create nextcloud proxy configuration file
  template:
    src:    "nginx/host.conf.j2" 
    dest:   "{{ NEXTCLOUD_HOST_NGINX_PATH }}"
  notify: restart openresty

- name: "load docker and db for {{ application_id }}"
  include_role:
    name: sys-stk-back-stateful
  vars:
    docker_compose_flush_handlers: false

- block:
    - name: "Create '{{ NEXTCLOUD_WHITEBOARD_SERVICE_DIRECTORY }}' Directory"
      file:
        path: "{{ NEXTCLOUD_WHITEBOARD_SERVICE_DIRECTORY }}"
        state: directory
        mode: "0755"
    
    - name: "Deploy Whiteboard Dockerfile to '{{ NEXTCLOUD_WHITEBOARD_SERVICE_DOCKERFILE }}'"
      template:
        src:    "Dockerfiles/Whiteboard.j2"
        dest:   "{{ NEXTCLOUD_WHITEBOARD_SERVICE_DOCKERFILE }}"
      notify: docker compose build
      
  when: NEXTCLOUD_WHITEBOARD_ENABLED | bool

- name: "create {{ NEXTCLOUD_HOST_CONF_ADD_PATH }}"
  file:
    path: "{{ NEXTCLOUD_HOST_CONF_ADD_PATH }}"
    state: directory
    mode: "0755"

- name: "Create config files at {{ NEXTCLOUD_HOST_CONF_ADD_PATH }}"
  template:
    src:    "{{ item }}"
    dest:   "{{ NEXTCLOUD_HOST_CONF_ADD_PATH }}/{{ item | basename | regex_replace('\\.j2$', '') }}"
    owner:  "{{ NEXTCLOUD_DOCKER_USER_ID }}"
    group:  "{{ NEXTCLOUD_DOCKER_USER_ID }}"
  loop:     "{{ lookup('fileglob', role_path ~ '/templates/config/*.j2', wantlist=True) }}"
  notify: docker compose up

- name: create internal nextcloud nginx configuration
  template:
    src:  "nginx/docker.conf.j2" 
    dest: "{{ NEXTCLOUD_HOST_NGINX_SRC }}"
  notify: docker compose up
