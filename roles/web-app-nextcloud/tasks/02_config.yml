# Merge all (config) files in infinito directory (container)

- name: Add dynamic config merging from Jinja template
  template:
    src: include.php.j2
    dest: "{{ NEXTCLOUD_HOST_INCL_PATH }}"
  notify: docker compose restart

- name: Flush handlers so Nextcloud container is restarted and ready
  meta: flush_handlers

- name: "Wait until Nextcloud is reachable on port {{ ports.localhost.http[application_id] }}"
  wait_for:
    host: "{{ DOCKER_REACH_HOST }}"
    port: "{{ ports.localhost.http[application_id] }}"
    timeout: 120
    delay: 2
    state: started

- name: Copy include instructions to the container
  command: >
    docker cp {{ NEXTCLOUD_HOST_INCL_PATH }} {{ NEXTCLOUD_CONTAINER }}:{{ NEXTCLOUD_DOCKER_INCL_PATH }}

- name: Wait until Nextcloud is installed (occ status)
  command: "{{ NEXTCLOUD_DOCKER_EXEC_OCC }} status"
  register: occ_status
  retries: 60
  delay: 5
  until: >
    occ_status.rc == 0 and
    (occ_status.stdout | default('')) is search('installed: true')
  changed_when: false
  failed_when: false

- name: Append generated config to config.php only if not present
  command: >
    docker exec -u {{ NEXTCLOUD_DOCKER_USER }} {{ NEXTCLOUD_CONTAINER }} sh -c "
      grep -q '{{ NEXTCLOUD_DOCKER_CONF_ADD_PATH }}' {{ NEXTCLOUD_DOCKER_CONFIG_FILE }} || 
      cat {{ NEXTCLOUD_DOCKER_INCL_PATH }} >> {{ NEXTCLOUD_DOCKER_CONFIG_FILE }}"
  notify: docker compose restart
