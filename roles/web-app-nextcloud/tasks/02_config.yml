# Merge all (config) files in infinito directory (container)

- name: Add dynamic config merging from Jinja template
  template:
    src: include.php.j2
    dest: "{{ NEXTCLOUD_HOST_INCL_PATH }}"
    owner: "{{ NEXTCLOUD_DOCKER_USER_ID }}"
    group: "{{ NEXTCLOUD_DOCKER_USER_ID }}"
    mode: "0644"
  notify: docker compose up

- name: "NEXTCLOUD | Ensure includes.php ownership/permissions on host"
  ansible.builtin.file:
    path: "{{ NEXTCLOUD_HOST_INCL_PATH }}"
    state: file
    owner: "{{ NEXTCLOUD_DOCKER_USER_ID }}"
    group: "{{ NEXTCLOUD_DOCKER_USER_ID }}"
    mode: "0644"  

- name: Flush handlers so Nextcloud container is restarted and ready
  meta: flush_handlers

- name: "Wait until Nextcloud is reachable on port {{ ports.localhost.http[application_id] }}"
  wait_for:
    host: "{{ DOCKER_REACH_HOST }}"
    port: "{{ ports.localhost.http[application_id] }}"
    timeout: 120
    delay: 2
    state: started

- name: Copy include instructions to the container
  command: >
    docker cp {{ NEXTCLOUD_HOST_INCL_PATH }} {{ NEXTCLOUD_CONTAINER }}:{{ NEXTCLOUD_DOCKER_INCL_PATH }}

- name: Wait until Nextcloud is installed (occ status)
  command: "{{ NEXTCLOUD_DOCKER_EXEC_OCC }} status"
  register: occ_status
  retries: 60
  delay: 5
  until: >
    occ_status.rc == 0 and
    (occ_status.stdout | default('')) is search('installed: true')
  changed_when: false

- name: Ensure config.php loads /tmp/includes.php (idempotent)
  ansible.builtin.shell: |
    set -euo pipefail

    docker exec -u root {{ NEXTCLOUD_CONTAINER }} sh -lc '
      cfg="{{ NEXTCLOUD_DOCKER_CONFIG_FILE }}"
      marker="INFINITO:NEXUS CONFIG LOADER"

      grep -q "$marker" "$cfg" && exit 0

      printf "\n/* %s */\nif (is_readable(\"/tmp/includes.php\")) {\n  include \"/tmp/includes.php\";\n}\n" \
        "$marker" >> "$cfg"
    '
  args:
    executable: /bin/bash
  register: cfg_loader_patch
  changed_when: cfg_loader_patch.rc == 0
  failed_when: cfg_loader_patch.rc != 0
  notify: docker compose up
