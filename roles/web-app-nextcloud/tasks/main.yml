---
- name: Setup the full docker stack
  include_tasks: 01_fullstack.yml
  vars:
    domain:     "{{ NEXTCLOUD_DOMAIN }}"
    http_port:  "{{ NEXTCLOUD_PORT }}"

- name: Setup config.php 
  include_tasks: 02_config.yml

- name: Flush all handlers immediately so that occ can be used
  meta: flush_handlers

- name: Wait until Redis is ready (PONG)
  command: "{{ BIN_CONTAINER }} exec {{ NEXTCLOUD_REDIS_CONTAINER }} redis-cli ping"
  register: redis_ping
  retries: 60
  delay: 2
  until: (redis_ping.stdout | default('')) is search('PONG')

- name: Update\Upgrade Nextcloud
  include_tasks: 03_upgrade.yml

- name: Load system configuration steps
  include_tasks: "{{ item }}"
  loop:
    - 04_admin.yml
    - 05_system_config.yml

- name: Setup Nextcloud Plugins
  include_tasks: 06_setup_plugin.yml
  loop: "{{ NEXTCLOUD_PLUGIN_ITEMS }}"
  loop_control:
    loop_var: plugin_item
  vars:
    plugin_key:   "{{ plugin_item.key }}"
    plugin_value: "{{ plugin_item.value }}"
  when: NEXTCLOUD_PLUGINS_ENABLED | bool
