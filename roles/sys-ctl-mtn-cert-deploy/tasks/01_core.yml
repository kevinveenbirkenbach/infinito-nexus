- name: Include dependency 'sys-ctl-alm-compose'
  include_role:
    name: sys-ctl-alm-compose
  when: run_once_sys_ctl_alm_compose is not defined

- name: "Ensure cert deploy target directory exists"
  file:
    path: "{{ docker_compose.directories.volumes }}certs"
    state: directory
    mode: "0755"

- include_role:
    name: sys-service
  vars:
    system_service_state:               restarted
    system_service_on_calendar:         "{{ SYS_SCHEDULE_MAINTANANCE_LETSENCRYPT_DEPLOY }}"
    system_service_timer_enabled:       true
    system_service_tpl_on_failure:      "{{ SYS_SERVICE_ON_FAILURE_COMPOSE }}"
    system_service_force_linear_sync:   false
    system_service_timer_persistent:    true
    system_service_force_flush_instant: true  # Required, because otherwise Mailu may doesn't have certificates
    compose_cmd: >-
      {{ PATH_COMPOSE }}
      --chdir {{ docker_compose.directories.instance }}
      --project {{ (docker_compose.directories.instance | regex_replace('/+$', '')) | basename }}

- include_tasks: utils/once/flag.yml
