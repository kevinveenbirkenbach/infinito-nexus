---
- name: Render HTML-Location-Block in Variable
  set_fact:
    proxy_extra_configuration: >-
      {{ lookup('ansible.builtin.template',
                playbook_dir ~ '/roles/srv-proxy-core/templates/location/html.conf.j2') | trim }}
  vars:
    location: '^~ /html5client'
    oauth2_proxy_enabled: false
    proxy_lua_enabled: false

- name: "load docker, proxy for '{{ application_id }}'"
  include_role:
    name: cmp-docker-proxy
  vars:
    docker_compose_flush_handlers: false
- name: "include 04_seed-database-to-backup.yml"
  include_tasks: "{{ playbook_dir }}/roles/sys-ctl-bkp-docker-2-loc/tasks/04_seed-database-to-backup.yml"

- name: "Unset 'proxy_extra_configuration'"
  set_fact:
    proxy_extra_configuration: null

- name: configure websocket_upgrade.conf
  copy: 
    src:  "websocket_upgrade.conf"
    dest: "{{NGINX.DIRECTORIES.HTTP.MAPS}}websocket_upgrade.conf"
  notify: restart openresty

- name: "Set BBB Facts"
  set_fact:
    bbb_env_file_link:            "{{ docker_repository_path }}.env"
    bbb_env_file_origine:         "{{ docker_compose.files.env }}"
    docker_compose_file_origine:  "{{ docker_repository_path }}docker-compose.yml"
    docker_compose_file_final:    "{{ docker_compose.directories.instance }}docker-compose.yml"

- name: deploy .env
  # This seems redundant @todo Checkout if this is true and if so, delete it
  template: 
    src:  env.j2
    dest: "{{ bbb_env_file_origine }}"

- name: Create symbolic link from .env file to target location
  file:
    src:    "{{ bbb_env_file_origine }}"
    dest:   "{{ bbb_env_file_link }}"
    state:  link

- name: "Setup docker-compose.yml file"
  include_tasks: "01_docker-compose.yml"

- name: Ensure all containers in instance are running
  include_tasks: "{{ playbook_dir }}/roles/docker-compose/tasks/05_ensure_up.yml"

- name: flush docker service
  meta: flush_handlers

- name: "Setup administrator"
  include_tasks: "02_administrator.yml"


