---
- name: "load docker, proxy for '{{application_id}}'"
  include_role:
    name: cmp-docker-proxy

- name: "include 04_seed-database-to-backup.yml"
  include_tasks: "{{ playbook_dir }}/roles/sys-bkp-docker-2-loc/tasks/04_seed-database-to-backup.yml"

- name: configure websocket_upgrade.conf
  copy: 
    src:  "websocket_upgrade.conf"
    dest: "{{nginx.directories.http.maps}}websocket_upgrade.conf"
  notify: restart openresty

- name: "Set BBB Facts"
  set_fact:
    bbb_env_file_link:            "{{ docker_repository_path }}.env"
    bbb_env_file_origine:         "{{ docker_compose.files.env }}"
    docker_compose_file_origine:  "{{ docker_repository_path }}docker-compose.yml"
    docker_compose_file_final:    "{{ docker_compose.directories.instance }}docker-compose.yml"

- name: deploy .env
  # This seems redundant @todo Checkout if this is true and if so, delete it
  template: 
    src:  env.j2
    dest: "{{ bbb_env_file_origine }}"

- name: Create symbolic link from .env file to target location
  file:
    src:    "{{ bbb_env_file_origine }}"
    dest:   "{{ bbb_env_file_link }}"
    state:  link

- name: "Setup docker-compose.yml file"
  include_tasks: "01_docker-compose.yml"

- name: Ensure all containers in instance are running
  include_tasks: "{{ playbook_dir }}/roles/docker-compose/tasks/04_ensure_up.yml"

- name: flush docker service
  meta: flush_handlers

- name: "Setup administrator"
  include_tasks: "02_administrator.yml"


