---
- name: Render HTML-Location-Block in Variable
  set_fact:
    proxy_extra_configuration: >-
      {{ lookup('ansible.builtin.template',
                playbook_dir ~ '/roles/sys-svc-proxy/templates/location/html.conf.j2') | trim }}
  vars:
    location: '^~ /html5client'
    oauth2_proxy_enabled: false
    proxy_lua_enabled: false

- name: "load docker, proxy for '{{ application_id }}'"
  include_role:
    name: sys-stk-full-stateless
  vars:
    docker_compose_flush_handlers: false

- name: "Unset 'proxy_extra_configuration'"
  set_fact:
    proxy_extra_configuration: null

- name: "Include Seed routines for '{{ application_id }}' database backup"
  include_tasks: "{{ [ playbook_dir, 'roles/sys-ctl-bkp-docker-2-loc/tasks/04_seed-database-to-backup.yml' ] | path_join }}"

- name: configure websocket_upgrade.conf
  copy: 
    src:  "websocket_upgrade.conf"
    dest: "{{ [ NGINX.DIRECTORIES.HTTP.MAPS, 'websocket_upgrade.conf' ] | path_join }}"
  notify: restart openresty

- name: "Set BBB Facts"
  set_fact:
    BBB_ENV_FILE_LINK:                "{{ [ docker_repository_path, '.env' ] | path_join }}"
    BBB_ENV_FILE_ORIGINE:             "{{ docker_compose.files.env }}"
    BBB_DOCKER_COMPOSE_FILE_ORIGINE:  "{{ [ docker_repository_path, 'docker-compose.yml' ] | path_join }}"
    BBB_DOCKER_COMPOSE_FILE_FINAL:    "{{ [ docker_compose.directories.instance, 'docker-compose.yml' ] | path_join }}"

- name: Write docker-compose.override.yml for BigBlueButton
  template:
    src:  docker-compose.override.yml.j2
    dest: "{{ [ docker_compose.directories.instance, 'docker-compose.override.yml' ] | path_join }}"
  notify:
    - docker compose up

- name: deploy .env
  # This seems redundant @todo Checkout if this is true and if so, delete it
  template:
    src:  env.j2
    dest: "{{ BBB_ENV_FILE_ORIGINE }}"
  notify:
    - docker compose up

- name: Create symbolic link from .env file to target location
  file:
    src:    "{{ BBB_ENV_FILE_ORIGINE }}"
    dest:   "{{ BBB_ENV_FILE_LINK }}"
    state:  link

- name: "Setup docker-compose.yml file"
  include_tasks: "01_docker-compose.yml"

- name: Ensure all containers in instance are running
  include_tasks: "{{ [ playbook_dir , 'roles/docker-compose/tasks/05_ensure_up.yml' ] | path_join }}"

- name: flush docker service
  meta: flush_handlers

- name: "Setup administrator"
  include_tasks: "02_administrator.yml"

- name: "Load '{{ application_id }}' dependencies"
  include_tasks: "03_dependencies.yml"
