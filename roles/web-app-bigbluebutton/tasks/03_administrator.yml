---
- name: "Wait until Greenlight is reachable via Nginx"
  ansible.builtin.uri:
    url: "{{ lookup('tls_resolve', application_id, want='url.base') }}"
    validate_certs: true
    status_code: 200
    return_content: true
  register: greenlight_http
  until:
    - greenlight_http.status == 200
    - "'Greenlight' in greenlight_http.content or 'Sign in' in greenlight_http.content"
  retries: 30
  delay: 5
  changed_when: false

- name: "Ensure Greenlight admin (B64-safe, idempotent)"
  ansible.builtin.command:
    argv:
      - docker
      - compose
      - --env-file
      - "{{ docker_compose.files.env }}"
      - exec
      - -T
      - -e
      - "TARGET_NAME={{ users.administrator.username | upper }}"
      - -e
      - "NEW_NAME={{ users.administrator.username | upper }}"
      - -e
      - "NEW_EMAIL={{ users.administrator.email }}"
      - -e
      - "NEW_PASSWORD_B64={{ users.administrator.password | b64encode }}"
      - greenlight
      - bash
      - -lc
      - "bundle exec rails runner -"
    stdin: "{{ lookup('ansible.builtin.file', role_path ~ '/files/greenlight_ensure_admin.rb') }}"
  args:
    chdir: "{{ docker_compose.directories.instance }}"
  register: greenlight_admin_map
  changed_when: "'CHANGED' in (greenlight_admin_map.stdout | default(''))"
  failed_when: greenlight_admin_map.rc != 0
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"
