---
- name: "Wait until PostgreSQL is ready"
  ansible.builtin.shell: >
    compose exec -T postgres
    pg_isready -U postgres
  args:
    chdir: "{{ lookup('docker', application_id, 'directories.instance') }}"
  register: pg_ready
  retries: 20
  delay: 3
  until: pg_ready.rc == 0
  changed_when: false

- name: "Ensure PostgreSQL password matches POSTGRESQL_SECRET"
  ansible.builtin.shell: >
    compose exec -T postgres
    psql -U postgres -d postgres
    -c "ALTER USER postgres WITH PASSWORD '{{ BBB_POSTGRESQL_SECRET }}';"
  args:
    chdir: "{{ lookup('docker', application_id, 'directories.instance') }}"
  changed_when: false
