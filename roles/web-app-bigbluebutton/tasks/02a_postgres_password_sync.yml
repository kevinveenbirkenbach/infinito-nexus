---
- name: "Wait until PostgreSQL is ready"
  ansible.builtin.shell: >
    docker compose
    --env-file {{ docker_compose.files.env }}
    exec -T postgres
    pg_isready -U postgres
  args:
    chdir: "{{ docker_compose.directories.instance }}"
  register: pg_ready
  retries: 20
  delay: 3
  until: pg_ready.rc == 0
  changed_when: false

- name: "Ensure PostgreSQL password matches POSTGRESQL_SECRET"
  ansible.builtin.shell: >
    docker compose
    --env-file {{ docker_compose.files.env }}
    exec -T postgres
    psql -U postgres -d postgres
    -c "ALTER USER postgres WITH PASSWORD '{{ BBB_POSTGRESQL_SECRET }}';"
  args:
    chdir: "{{ docker_compose.directories.instance }}"
  changed_when: false
