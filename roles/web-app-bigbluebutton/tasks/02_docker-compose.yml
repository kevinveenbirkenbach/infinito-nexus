- name: "create docker-compose.yml for bigbluebutton"
  command:
    cmd: bash ./scripts/generate-compose
    chdir: "{{ docker_repository_path }}"
  environment:
    COMPOSE_HTTP_TIMEOUT: "600"
    DOCKER_CLIENT_TIMEOUT: "600"

- name: Slurp docker-compose.yml from remote host
  slurp:
    src: "{{ BBB_COMPOSE_FILE_ORIGINE }}"
  register: compose_slurp

- name: Transform docker-compose.yml with compose_mods
  copy:
    content: "{{ compose_slurp.content | b64decode | compose_mods(docker_repository_path, lookup('docker', application_id, 'files.env')) }}"
    dest: "{{ BBB_COMPOSE_FILE_FINAL }}"
  notify:
    - compose up

- name: Prebuild etherpad image
  # On local testing environment errors exist if you don't prebuild
  # @see https://chatgpt.com/share/6971f56e-bdf0-800f-8582-d1b59d6c67db
  command:
    cmd: docker compose build etherpad
    chdir: "{{ lookup('docker', application_id, 'directories.instance') }}"
  when: RUNTIME == 'dev'
