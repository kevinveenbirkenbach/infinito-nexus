# run_once_sys_stk_back_stateful: disabled

- block:
  - name: Compute LDAP load flag (enabled && shared)
    ansible.builtin.set_fact:
      SYS_STK_BACK_STATEFULL_LOAD_LDAP: "{{ (SYS_STK_BACK_STATEFULL_LDAP_ENABLED | bool) and (SYS_STK_BACK_STATEFULL_LDAP_SHARED | bool) }}"

  - name: "Load OpenLDAP (Once)"
    include_tasks: "utils/load_app.yml"
    vars:
      load_app_id: 'svc-db-openldap'
    when:
      - SYS_STK_BACK_STATEFULL_LOAD_LDAP | bool
  when:
    - run_once_svc_db_openldap is not defined # pass test_run_once_suffix_matches_role   

- name: "For '{{ application_id }}': Set database_application_id (Needed due to lazzy loading issue)"
  set_fact:
    database_application_id:    "{{ application_id }}"

- name: "For '{{ application_id }}': Load database variables"
  include_vars: "{{ item }}"
  loop:
    - "{{ DOCKER_VARS_FILE }}"    # Important to load docker variables first so that database can use them
    - "{{ DATABASE_VARS_FILE }}"  # Important to load them before docker role so that backup can use them

- name: "For '{{ application_id }}': Load central RDBMS"
  include_role:
    name: sys-svc-rdbms

- name: "For '{{ application_id }}': Load sys-stk-back-stateless"
  include_role:
    name: sys-stk-back-stateless
