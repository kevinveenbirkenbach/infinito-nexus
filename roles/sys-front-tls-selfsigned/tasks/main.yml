---
# run_once_sys_front_tls_selfsigned: deactivated"

- name: "TLS | (self_signed) compute target paths"
  ansible.builtin.set_fact:
    _ss_dir:  "{{ [tls_selfsigned_base, tls_app_id, tls_domain] | path_join }}"
    _ss_cert: "{{ [tls_selfsigned_base, tls_app_id, tls_domain, 'fullchain.pem'] | path_join }}"
    _ss_key:  "{{ [tls_selfsigned_base, tls_app_id, tls_domain, 'privkey.pem'] | path_join }}"
    _ss_conf: "{{ [tls_selfsigned_base, tls_app_id, tls_domain, 'openssl.cnf'] | path_join }}"
    _ss_cn:   "{{ (tls_selfsigned_subject.CN | default('') | length > 0) | ternary(tls_selfsigned_subject.CN, tls_domain) }}"
  changed_when: false

- name: "TLS | (self_signed) ensure directory exists"
  ansible.builtin.file:
    path: "{{ _ss_dir }}"
    state: directory
    mode: "0750"

- name: "TLS | (self_signed) render openssl config (SAN aware)"
  ansible.builtin.copy:
    dest: "{{ _ss_conf }}"
    mode: "0640"
    content: |
      [ req ]
      default_bits       = {{ tls_selfsigned_key_bits }}
      default_md         = sha256
      prompt             = no
      distinguished_name = dn
      req_extensions     = req_ext

      [ dn ]
      C  = {{ tls_selfsigned_subject.C }}
      O  = {{ tls_selfsigned_subject.O }}
      OU = {{ tls_selfsigned_subject.OU }}
      CN = {{ _ss_cn }}

      [ req_ext ]
      subjectAltName = @alt_names

      [ alt_names ]
      {% for d in (tls_domains_san | default([])) %}
      DNS.{{ loop.index }} = {{ d }}
      {% endfor %}

- name: "TLS | (self_signed) check if cert already exists"
  ansible.builtin.stat:
    path: "{{ _ss_cert }}"
  register: _ss_cert_stat
  changed_when: false

- name: "TLS | (self_signed) generate key+cert if missing"
  ansible.builtin.command: >
    openssl req -x509 -nodes
    -days {{ tls_selfsigned_days }}
    -newkey rsa:{{ tls_selfsigned_key_bits }}
    -keyout {{ _ss_key }}
    -out {{ _ss_cert }}
    -config {{ _ss_conf }}
    -extensions req_ext
  args:
    creates: "{{ _ss_cert }}"
  when: not (_ss_cert_stat.stat.exists | default(false))

- name: "TLS | (self_signed) set cert paths"
  ansible.builtin.set_fact:
    TLS_CERT_FILE: "{{ _ss_cert }}"
    TLS_KEY_FILE:  "{{ _ss_key }}"
    TLS_CA_FILE:   ""
  changed_when: false
