---
# run_once_sys_front_tls_selfsigned: deactivate

# Self-signed TLS provider (strict).
# Requires correct Infinito.Nexus context (domains/applications/TLS_* vars).
# No fallbacks; everything is derived from tls_resolve.

- name: "TLS | (self_signed) resolve via tls_resolve (strict)"
  ansible.builtin.set_fact:
    _tls: "{{ lookup('tls_resolve', application_id) }}"
  changed_when: false

- name: "TLS | (self_signed) assert mode is self_signed"
  ansible.builtin.assert:
    that:
      - _tls.mode == 'self_signed'
      - _tls.enabled | bool
    fail_msg: >-
      sys-front-tls-selfsigned called for '{{ application_id }}' but resolver returned
      enabled={{ _tls.enabled }}, mode={{ _tls.mode }}. Expected enabled=true, mode=self_signed.

- name: "TLS | (self_signed) compute target paths"
  ansible.builtin.set_fact:
    _ss_domain: "{{ _tls.domains.primary }}"
    _ss_san:    "{{ _tls.domains.san }}"
    _ss_cert:   "{{ _tls.files.cert }}"
    _ss_key:    "{{ _tls.files.key }}"
    _ss_dir:    "{{ _tls.files.cert | dirname }}"
    _ss_conf:   "{{ (_tls.files.cert | dirname) ~ '/openssl.cnf' }}"
    _ss_cn:     "{{ (tls_selfsigned_subject.CN | default('') | length > 0) | ternary(tls_selfsigned_subject.CN, _tls.domains.primary) }}"
  changed_when: false

- name: "TLS | (self_signed) ensure directory exists"
  ansible.builtin.file:
    path: "{{ _ss_dir }}"
    state: directory
    mode: "0750"

- name: "TLS | (self_signed) render openssl config (SAN aware)"
  ansible.builtin.copy:
    dest: "{{ _ss_conf }}"
    mode: "0640"
    content: |
      [ req ]
      default_bits       = {{ tls_selfsigned_key_bits }}
      default_md         = sha256
      prompt             = no
      distinguished_name = dn
      req_extensions     = req_ext

      [ dn ]
      C  = {{ tls_selfsigned_subject.C }}
      O  = {{ tls_selfsigned_subject.O }}
      OU = {{ tls_selfsigned_subject.OU }}
      CN = {{ _ss_cn }}

      [ req_ext ]
      subjectAltName = @alt_names

      [ alt_names ]
      {% for d in _ss_san %}
      DNS.{{ loop.index }} = {{ d }}
      {% endfor %}

- name: "TLS | (self_signed) check if cert already exists"
  ansible.builtin.stat:
    path: "{{ _ss_cert }}"
  register: _ss_cert_stat
  changed_when: false

- name: "TLS | (self_signed) generate key+cert if missing"
  ansible.builtin.command: >
    openssl req -x509 -nodes
    -days {{ tls_selfsigned_days }}
    -newkey rsa:{{ tls_selfsigned_key_bits }}
    -keyout {{ _ss_key }}
    -out {{ _ss_cert }}
    -config {{ _ss_conf }}
    -extensions req_ext
  args:
    creates: "{{ _ss_cert }}"
  when: not (_ss_cert_stat.stat.exists | default(false))
