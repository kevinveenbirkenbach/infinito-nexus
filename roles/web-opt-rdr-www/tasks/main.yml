- block:
  - name: Include dependency 'srv-web-7-4-core'
    include_role:
      name: srv-web-7-4-core
    when: run_once_srv_web_7_4_core is not defined
  - include_tasks: utils/run_once.yml
  when: run_once_web_opt_rdr_www is not defined

- name: Filter www-prefixed domains from current_play_domains_all
  set_fact:
    www_domains: "{{ current_play_domains_all | select('match', '^www\\.') | list }}"

- name: Include web-opt-rdr-domains role for www-to-bare redirects
  include_role:
    name: web-opt-rdr-domains
  vars:
    domain_mappings: "{{ www_domains | map('regex_replace', '^www\\.(.+)$', '{ source: \"www.\\1\", target: \"\\1\" }') | map('from_yaml') | list }}"

- name: Include DNS role to set redirects
  include_role:
    name: srv-web-7-7-dns-records
  vars:
    CLOUDFLARE_API_TOKEN: "{{ CLOUDFLARE_API_TOKEN }}"
    cloudflare_domains: "{{ www_domains }}"
    cloudflare_target_ip: "{{ networks.internet.ip4 }}"
    cloudflare_proxied: false
  when: DNS_PROVIDER == 'cloudflare'
