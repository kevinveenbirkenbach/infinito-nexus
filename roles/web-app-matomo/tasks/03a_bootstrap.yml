- block:
    - name: "Matomo bootstrap | Run one-shot bootstrap via compose profile"
      ansible.builtin.command:
        argv:
          - "{{ BIN_COMPOSE }}"
          - --chdir
          - "{{ lookup('container', application_id, 'directories.instance') }}"
          - --project
          - "{{ (lookup('container', application_id, 'directories.instance') | regex_replace('/+$', '')) | basename }}"
          - --
          - --profile
          - "{{ MATOMO_BOOTSTRAP_PROFILE }}"
          - run
          - --rm
          - "{{ MATOMO_BOOTSTRAP_SERVICE }}"
      register: matomo_bootstrap_run
      no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"
      changed_when: true
      retries: "{{ MATOMO_BOOTSTRAP_RETRIES | int }}"
      delay: "{{ MATOMO_BOOTSTRAP_RETRY_DELAY_S | int }}"
      until: matomo_bootstrap_run.rc == 0

  rescue:
    - name: "Load Boostrap Debug Info"
      include_tasks: 03b_bootstrap_debug.yml
      when:
        - MASK_CREDENTIALS_IN_LOGS | bool
        - MODE_DEBUG | bool

- name: "Matomo bootstrap | Set effective token (prefer existing, else parse bootstrap stdout)"
  ansible.builtin.set_fact:
    matomo_token_value: >-
      {{
        (matomo_token_value | default('') | string | trim)
        if (matomo_token_value is defined and (matomo_token_value | string | trim) != '')
        else (
          (matomo_bootstrap_run.stdout | default('') | string)
          | regex_search('(?m)^[a-f0-9]{32,64}$')
          | default('', true)
          | trim
        )
      }}

- name: "Matomo bootstrap | Assert we have a token now"
  ansible.builtin.assert:
    that:
      - matomo_token_value is defined
      - matomo_token_value | length > 0
      - matomo_token_value is match("^[a-f0-9]{32,64}$")
    fail_msg: >-
      Matomo bootstrap did not yield a valid token.
      stdout={{ matomo_bootstrap_run.stdout | default('') | trim }}
  when: MODE_ASSERT | bool


- name: "Matomo | Persist + inject token via sys-token-store (store + runtime users)"
  ansible.builtin.include_role:
    name: sys-token-store
    tasks_from: write.yml
  vars:
    sys_token_store_user_key: "{{ MATOMO_ADMIN_USER_KEY }}"
    sys_token_store_app: "{{ application_id }}"
    sys_token_store_token: "{{ matomo_token_value }}"
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"
