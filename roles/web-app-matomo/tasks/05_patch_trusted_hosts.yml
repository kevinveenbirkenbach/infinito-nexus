- name: "Matomo | Set trusted hosts (domain + service + docker reach host)"
  ansible.builtin.command:
    argv:
      - docker
      - exec
      - --user
      - root
      - "{{ MATOMO_NAME }}"
      - sh
      - -lc
      - |
        set -eu
        CFG="{{ MATOMO_CONFIG }}"
        DOMAIN="{{ domain }}"
        SERVICE="{{ MATOMO_SERVICE }}"
        LOCAL="{{ DOCKER_REACH_HOST }}:{{ http_port }}"

        ensure_host() {
          host="$1"
          if ! grep -qE "^trusted_hosts\\[\\][[:space:]]*= \"${host}\"$" "$CFG"; then
            awk -v host="$host" '
              BEGIN{added=0}
              /^\[General\]$/ { print; next }
              /^trusted_hosts\[\][[:space:]]*=/ && !added {
                print
                print "trusted_hosts[] = \""host"\""
                added=1
                next
              }
              { print }
              END{
                if (!added) {
                  print "[General]"
                  print "trusted_hosts[] = \""host"\""
                }
              }
            ' "$CFG" > "$CFG.tmp" && mv "$CFG.tmp" "$CFG"
          fi
        }

        # Keep your "first trusted_hosts[] = DOMAIN" behavior
        sed -i "0,/^trusted_hosts\\[\\].*/s//trusted_hosts[] = \"${DOMAIN}\"/" "$CFG"

        # Ensure additional trusted hosts exist
        ensure_host "$SERVICE"
        ensure_host "$LOCAL"
  notify: compose up
