# IMPORTANT: Avoid shell-inlining stdout/stderr because it can contain quotes and break bash parsing.
- name: "DEBUG | bootstrap result (sanitized/minimal when masked)"
  ansible.builtin.debug:
    msg:
      - "=== compose bootstrap FAILED ==="
      - "attempts={{ matomo_bootstrap_run.attempts | default(1) }}/{{ MATOMO_BOOTSTRAP_RETRIES }}"
      - "rc={{ matomo_bootstrap_run.rc | default('n/a') }}"
      - "stdout_len={{ (matomo_bootstrap_run.stdout | default('') | string) | length }}"
      - "stderr_len={{ (matomo_bootstrap_run.stderr | default('') | string) | length }}"

- name: "DEBUG | bootstrap result (full when not masked)"
  ansible.builtin.debug:
    msg:
      - "=== compose bootstrap FAILED ==="
      - "attempts={{ matomo_bootstrap_run.attempts | default(1) }}/{{ MATOMO_BOOTSTRAP_RETRIES }}"
      - "rc={{ matomo_bootstrap_run.rc | default('n/a') }}"
      - "--- stdout ---"
      - "{{ matomo_bootstrap_run.stdout | default('') }}"
      - "--- stderr ---"
      - "{{ matomo_bootstrap_run.stderr | default('') }}"

- name: "DEBUG | compose ps -a"
  ansible.builtin.command:
    argv:
      - "{{ BIN_COMPOSE }}"
      - --chdir
      - "{{ lookup('container', application_id, 'directories.instance') }}"
      - --project
      - "{{ (lookup('container', application_id, 'directories.instance') | regex_replace('/+$', '')) | basename }}"
      - --
      - ps
      - -a
  register: matomo_bootstrap_ps
  changed_when: false
  failed_when: false

- name: "DEBUG | compose ps output (full when not masked)"
  ansible.builtin.debug:
    msg:
      - "--- compose ps -a stdout ---"
      - "{{ matomo_bootstrap_ps.stdout | default('') }}"
      - "--- compose ps -a stderr ---"
      - "{{ matomo_bootstrap_ps.stderr | default('') }}"

- name: "DEBUG | compose logs matomo (tail)"
  ansible.builtin.command:
    argv:
      - "{{ BIN_COMPOSE }}"
      - --chdir
      - "{{ lookup('container', application_id, 'directories.instance') }}"
      - --project
      - "{{ (lookup('container', application_id, 'directories.instance') | regex_replace('/+$', '')) | basename }}"
      - --
      - logs
      - --no-color
      - --timestamps
      - --tail
      - "{{ MATOMO_BOOTSTRAP_DEBUG_LOG_TAIL | string }}"
      - "{{ MATOMO_SERVICE }}"
  register: matomo_bootstrap_matomo_logs
  changed_when: false
  failed_when: false

- name: "DEBUG | compose logs matomo output (full when not masked)"
  ansible.builtin.debug:
    msg:
      - "--- compose logs {{ MATOMO_SERVICE }} stdout ---"
      - "{{ matomo_bootstrap_matomo_logs.stdout | default('') }}"
      - "--- compose logs {{ MATOMO_SERVICE }} stderr ---"
      - "{{ matomo_bootstrap_matomo_logs.stderr | default('') }}"

- name: "DEBUG | compose logs bootstrap service (tail)"
  ansible.builtin.command:
    argv:
      - "{{ BIN_COMPOSE }}"
      - --chdir
      - "{{ lookup('container', application_id, 'directories.instance') }}"
      - --project
      - "{{ (lookup('container', application_id, 'directories.instance') | regex_replace('/+$', '')) | basename }}"
      - --
      - logs
      - --no-color
      - --timestamps
      - --tail
      - "{{ MATOMO_BOOTSTRAP_DEBUG_LOG_TAIL | string }}"
      - "{{ MATOMO_BOOTSTRAP_SERVICE }}"
  register: matomo_bootstrap_service_logs
  changed_when: false
  failed_when: false

- name: "DEBUG | compose logs bootstrap output (full when not masked)"
  ansible.builtin.debug:
    msg:
      - "--- compose logs {{ MATOMO_BOOTSTRAP_SERVICE }} stdout ---"
      - "{{ matomo_bootstrap_service_logs.stdout | default('') }}"
      - "--- compose logs {{ MATOMO_BOOTSTRAP_SERVICE }} stderr ---"
      - "{{ matomo_bootstrap_service_logs.stderr | default('') }}"

- name: "DEBUG | show compose file"
  ansible.builtin.command:
    argv:
      - bash
      - -lc
      - "sed -n '1,240p' {{ lookup('container', application_id, 'files.compose') }} || true"
  changed_when: false

- name: "DEBUG | show env files (only when not masked)"
  ansible.builtin.command:
    argv:
      - bash
      - -lc
      - |
        set -euo pipefail
        echo "===== FILE: {{ MATOMO_BOOTSTRAP_ENV_FILE }} (bootstrap env) ====="
        cat "{{ MATOMO_BOOTSTRAP_ENV_FILE }}" || true
        echo
        echo "===== FILE: {{ lookup('container', application_id, 'files.env') }} (default env) ====="
        cat "{{ lookup('container', application_id, 'files.env') }}" || true
  changed_when: false

- name: "DEBUG | compose config (effective)"
  ansible.builtin.command:
    argv:
      - "{{ BIN_COMPOSE }}"
      - --debug
      - --chdir
      - "{{ lookup('container', application_id, 'directories.instance') }}"
      - --project
      - "{{ (lookup('container', application_id, 'directories.instance') | regex_replace('/+$', '')) | basename }}"
      - --
      - --profile
      - "{{ MATOMO_BOOTSTRAP_PROFILE }}"
      - config
  register: matomo_bootstrap_config
  changed_when: false
  failed_when: false

- name: "DEBUG | effective config output"
  ansible.builtin.debug:
    msg:
      - "{{ matomo_bootstrap_config.stdout | default('') }}"
      - "{{ matomo_bootstrap_config.stderr | default('') }}"
  when: not (MASK_CREDENTIALS_IN_LOGS | bool)

- name: "FAIL | abort after debug dump"
  ansible.builtin.fail:
    msg: "Matomo bootstrap failed â€“ see debug output above"
