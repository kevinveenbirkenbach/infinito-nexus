# roles/web-app-matomo/tasks/03_bootstrap.yml

- block:

    - name: "Matomo bootstrap | Run one-shot bootstrap via compose profile"
      ansible.builtin.command:
        argv:
          - "{{ BIN_COMPOSE }}"
          - --chdir
          - "{{ lookup('container', application_id, 'directories.instance') }}"
          - --project
          - "{{ (lookup('container', application_id, 'directories.instance') | regex_replace('/+$', '')) | basename }}"
          - --
          - --profile
          - "{{ MATOMO_BOOTSTRAP_PROFILE }}"
          - run
          - --rm
          - "{{ MATOMO_BOOTSTRAP_SERVICE }}"
      register: matomo_bootstrap_run
      changed_when: true
      no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

  rescue:

    # IMPORTANT: Avoid shell-inlining stdout/stderr because it can contain quotes and break bash parsing.
    - name: "DEBUG | bootstrap result (sanitized/minimal when masked)"
      ansible.builtin.debug:
        msg:
          - "=== compose bootstrap FAILED ==="
          - "rc={{ matomo_bootstrap_run.rc | default('n/a') }}"
          - "stdout_len={{ (matomo_bootstrap_run.stdout | default('') | string) | length }}"
          - "stderr_len={{ (matomo_bootstrap_run.stderr | default('') | string) | length }}"
      when: MASK_CREDENTIALS_IN_LOGS | bool

    - name: "DEBUG | bootstrap result (full when not masked)"
      ansible.builtin.debug:
        msg:
          - "=== compose bootstrap FAILED ==="
          - "rc={{ matomo_bootstrap_run.rc | default('n/a') }}"
          - "--- stdout ---"
          - "{{ matomo_bootstrap_run.stdout | default('') }}"
          - "--- stderr ---"
          - "{{ matomo_bootstrap_run.stderr | default('') }}"
      when: not (MASK_CREDENTIALS_IN_LOGS | bool)

    - name: "DEBUG | show compose file"
      ansible.builtin.command:
        argv:
          - bash
          - -lc
          - "sed -n '1,240p' {{ lookup('container', application_id, 'files.compose') }} || true"
      changed_when: false
      no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

    - name: "DEBUG | show env files (only when not masked)"
      ansible.builtin.command:
        argv:
          - bash
          - -lc
          - |
            set -euo pipefail
            echo "===== FILE: {{ MATOMO_BOOTSTRAP_ENV_FILE }} (bootstrap env) ====="
            cat "{{ MATOMO_BOOTSTRAP_ENV_FILE }}" || true
            echo
            echo "===== FILE: {{ lookup('container', application_id, 'files.env') }} (default env) ====="
            cat "{{ lookup('container', application_id, 'files.env') }}" || true
      changed_when: false
      when: not (MASK_CREDENTIALS_IN_LOGS | bool)

    - name: "DEBUG | compose config (effective)"
      ansible.builtin.command:
        argv:
          - "{{ BIN_COMPOSE }}"
          - --debug
          - --chdir
          - "{{ lookup('container', application_id, 'directories.instance') }}"
          - --project
          - "{{ (lookup('container', application_id, 'directories.instance') | regex_replace('/+$', '')) | basename }}"
          - --
          - --profile
          - "{{ MATOMO_BOOTSTRAP_PROFILE }}"
          - config
      register: matomo_bootstrap_config
      changed_when: false
      failed_when: false
      no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

    - name: "DEBUG | effective config output"
      ansible.builtin.debug:
        msg:
          - "{{ matomo_bootstrap_config.stdout | default('') }}"
          - "{{ matomo_bootstrap_config.stderr | default('') }}"
      when: not (MASK_CREDENTIALS_IN_LOGS | bool)

    - name: "FAIL | abort after debug dump"
      ansible.builtin.fail:
        msg: "Matomo bootstrap failed â€“ see debug output above"


- name: "Matomo bootstrap | Set effective token (prefer existing, else parse bootstrap stdout)"
  ansible.builtin.set_fact:
    matomo_token_value: >-
      {{
        (matomo_token_value | default('') | string | trim)
        if (matomo_token_value is defined and (matomo_token_value | string | trim) != '')
        else (
          (matomo_bootstrap_run.stdout | default('') | string)
          | regex_search('(?m)^[a-f0-9]{32,64}$')
          | default('', true)
          | trim
        )
      }}

- name: "Matomo bootstrap | Assert we have a token now"
  ansible.builtin.assert:
    that:
      - matomo_token_value is defined
      - matomo_token_value | length > 0
      - matomo_token_value is match("^[a-f0-9]{32,64}$")
    fail_msg: >-
      Matomo bootstrap did not yield a valid token.
      stdout={{ matomo_bootstrap_run.stdout | default('') | trim }}
  when: MODE_ASSERT | bool


- name: "Matomo | Persist + inject token via sys-token-store (store + runtime users)"
  ansible.builtin.include_role:
    name: sys-token-store
    tasks_from: write.yml
  vars:
    sys_token_store_user_key: "{{ MATOMO_ADMIN_USER_KEY }}"
    sys_token_store_app: "{{ application_id }}"
    sys_token_store_token: "{{ matomo_token_value }}"
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"
