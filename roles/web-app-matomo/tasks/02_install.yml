---
# Installs Matomo non-interactively by driving the web installer via Playwright
# using the Nix flake "matomo-bootstrap".
#
# Idempotent: caller skips this file when config.ini.php already exists.

- name: "Matomo install | Check whether Playwright browsers are already installed"
  ansible.builtin.stat:
    path: "{{ ansible_env.HOME }}/.cache/ms-playwright"
  register: playwright_cache

- name: "Matomo install | Install Playwright Chromium via Nix (one-time)"
  ansible.builtin.command:
    argv:
      - nix
      - run
      - --no-write-lock-file
      - github:kevinveenbirkenbach/matomo-bootstrap#matomo-bootstrap-playwright-install
  environment:
    # Avoid "TERM environment variable not set." in CI / non-tty contexts
    TERM: "xterm"
  when: not playwright_cache.stat.exists
  register: nix_playwright_install
  changed_when: true
  retries: 3
  delay: 10
  until: (nix_playwright_install.rc | default(1)) == 0

- name: "Matomo install | Run matomo-bootstrap via Nix (installs if needed)"
  ansible.builtin.command:
    argv:
      - nix
      - run
      - --no-write-lock-file
      - github:kevinveenbirkenbach/matomo-bootstrap#matomo-bootstrap
      - --
      - --base-url
      - "http://127.0.0.1:{{ ports.localhost.http[application_id] }}"
      - --admin-user
      - "{{ MATOMO_ADMIN_USER }}"
      - --admin-password
      - "{{ MATOMO_ADMIN_PASSWORD }}"
      - --admin-email
      - "{{ MATOMO_ADMIN_EMAIL }}"
      - --token-description
      - "ansible-bootstrap"
      - --timeout
      - "30"
  environment:
    TERM: "xterm"

    # Keep token stable for the role: matomo-bootstrap will just return this instead of creating a new one.
    MATOMO_BOOTSTRAP_TOKEN_AUTH: "{{ matomo_auth_token }}"

    # Values used by the recorded installer flow
    MATOMO_SITE_NAME: "{{ MATOMO_SITE_NAME }}"
    MATOMO_SITE_URL: "{{ domains | get_url(application_id, WEB_PROTOCOL) }}"
    MATOMO_TIMEZONE: "Germany - Berlin"

    # Optional knobs (CI / slower hosts)
    MATOMO_PLAYWRIGHT_HEADLESS: "1"
    MATOMO_PLAYWRIGHT_NAV_TIMEOUT_MS: "60000"
    MATOMO_PLAYWRIGHT_SLOWMO_MS: "0"
  register: matomo_bootstrap_run
  changed_when: true
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

- name: "Matomo install | Verify config.ini.php now exists"
  ansible.builtin.command:
    argv:
      - docker
      - exec
      - "{{ MATOMO_NAME }}"
      - sh
      - -lc
      - 'test -f "{{ MATOMO_CONFIG }}"'
  register: matomo_config_exists_after
  changed_when: false
  retries: 30
  delay: 2
  until: matomo_config_exists_after.rc == 0
  when: MODE_ASSERT | bool
