---
# Installs Matomo non-interactively via Matomo CLI (php console core:install).
# Idempotent: installation is skipped if config.ini.php already exists.

- name: "Matomo install | Install Matomo via CLI (creates config.ini.php)"
  command:
    argv:
      - docker
      - exec
      - "{{ MATOMO_NAME }}"
      - php
      - console
      - core:install
      - "--db-host={{ database_host }}"
      - "--db-port={{ database_port }}"
      - "--db-name={{ database_name }}"
      - "--db-user={{ database_username }}"
      - "--db-pass={{ database_password }}"
      - "--admin-login={{ MATOMO_ADMIN_USER }}"
      - "--admin-password={{ MATOMO_ADMIN_PASSWORD }}"
      - "--admin-email={{ MATOMO_ADMIN_EMAIL }}"
      - "--site-name={{ MATOMO_SITE_NAME }}"
  register: matomo_install
  changed_when: true
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

- name: "Matomo install | Verify config.ini.php now exists"
  command:
    argv:
      - docker
      - exec
      - "{{ MATOMO_NAME }}"
      - sh
      - -lc
      - 'test -f "{{ MATOMO_CONFIG }}"'
  register: matomo_config_exists_after
  changed_when: false
  retries: 20
  delay: 2
  until:  matomo_config_exists_after.rc == 0
