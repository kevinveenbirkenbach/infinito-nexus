- include_tasks: utils/once/flag.yml

- name: Compute average allowed connections per Postgres app (once)
  set_fact:
    POSTGRES_ALLOWED_AVG_CONNECTIONS: "{{ (POSTGRES_MAX_CONNECTIONS | split_postgres_connections(playbook_dir ~ '/roles')) | int }}"
  run_once: true

- name: "Setup docker network for {{ application_id }}"
  include_tasks: "{{ [playbook_dir, 'roles/sys-svc-compose/tasks/utils/network.yml' ] | path_join }}"
  vars:
    docker_network_name:            "{{ POSTGRES_NETWORK_NAME }}"
    docker_network_subnet:          "{{ POSTGRES_SUBNET }}"
    docker_compose_flush_handlers:  true
    # Explicit overwritting to be sure that there isn't a scope leak by another variable
    application_id:                 "svc-db-postgres"
    database_consumer_id:           "svc-db-postgres"

- name: Install 'psycopg2-binary'
  include_role:
    name: sys-pip-install
  vars:
    package_name: 'psycopg2-binary'
    global_install: true

- name: "POSTGRES | Wait until container is running (not restarting)"
  ansible.builtin.shell: >
    {{ BIN_CONTAINER }} inspect --format '{{ "{{.State.Status}}" }} {{ "{{.State.Restarting}}" }}' {{ POSTGRES_CONTAINER }}
  register: pg_state
  retries: 120
  delay: 2
  until: >
    (pg_state.stdout is search('running')) and
    (pg_state.stdout is not search('true'))
  changed_when: false

- name: "POSTGRES | Confirm SQL works (socket)"
  ansible.builtin.shell: >
    {{ BIN_CONTAINER }} exec --user postgres {{ POSTGRES_CONTAINER }} sh -lc
    'psql -U postgres -d postgres -Atc "SELECT 1" >/dev/null'
  register: pg_sql_ready
  retries: 30
  delay: 2
  until: pg_sql_ready.rc == 0
  changed_when: false

- name: "POSTGRES | Ensure postgres superuser password matches inventory"
  ansible.builtin.script: >
    set_postgres_superuser_password.sh
    {{ POSTGRES_CONTAINER | quote }}
    {{ POSTGRES_PASSWORD | quote }}
  register: postgres_pw_result
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"
  changed_when: >
    postgres_pw_result.stdout is search('\\[CHANGED\\]')
  failed_when: >
    postgres_pw_result.rc != 0 or
    postgres_pw_result.stdout is search('\\[FAIL\\]')
