---
- name: "Assert correct context"
  ansible.builtin.assert:
    that:
      - application_id == 'svc-db-postgres'
      - database_consumer_id != 'svc-db-postgres'

- name: Wait until postgres TCP auth works
  block:

    - name: Wait for Postgres TCP auth
      ansible.builtin.shell: >
        {{ POSTGRES_EXEC_SHELL }}
        'psql -h "{{ POSTGRES_LOCAL_HOST }}" -p "{{ POSTGRES_PORT }}"
        -U postgres -d postgres -c "SELECT 1"'
      register: pg_ready
      until: pg_ready.rc == 0
      retries: 30
      delay: 5
      changed_when: false

  rescue:

    - name: "POSTGRES | docker logs (last 200 lines)"
      ansible.builtin.command: "docker logs --tail 200 {{ POSTGRES_CONTAINER }}"
      register: dbg_docker_logs
      changed_when: false
      failed_when: false

    - name: "POSTGRES | Failure report"
      ansible.builtin.debug:
        msg:
          postgres_container: "{{ POSTGRES_CONTAINER }}"
          postgres_host: "{{ POSTGRES_LOCAL_HOST }}"
          postgres_port: "{{ POSTGRES_PORT }}"
          last_logs: "{{ dbg_docker_logs.stdout | default('') }}"

    - name: "POSTGRES | Fail explicitly after logs"
      ansible.builtin.fail:
        msg: >-
          Postgres did not become ready for TCP authentication.
          Last 200 container log lines were printed above.

# 1) Create the database
- name: "Create database: {{ database_name }}"
  community.postgresql.postgresql_db:
    name: "{{ database_name }}"
    state: present
    login_user: postgres
    login_password: "{{ POSTGRES_PASSWORD }}"
    login_host: "{{ POSTGRES_LOCAL_HOST }}"
    login_port: "{{ POSTGRES_PORT }}"
  register: postgresql_result
  until: postgresql_result is succeeded
  retries: "{{ POSTGRES_RETRIES }}"
  delay: "{{ POSTGRES_DELAY }}"

# 2) Create the database user (with password)
- name: "Create database user: {{ database_username }}"
  community.postgresql.postgresql_user:
    name:           "{{ database_username }}"
    password:       "{{ database_password }}"
    db:             "{{ database_name }}"
    state:          present
    login_user:     postgres
    login_password: "{{ POSTGRES_PASSWORD }}"
    login_host:     "{{ POSTGRES_LOCAL_HOST }}"
    login_port:     "{{ POSTGRES_PORT }}"
  register: postgresql_result
  until: postgresql_result is succeeded
  retries: "{{ POSTGRES_RETRIES }}"
  delay: "{{ POSTGRES_DELAY }}"

# 3) Enable LOGIN for the role (removes NOLOGIN)
- name: "POSTGRES | Ensure LOGIN for role {{ database_username }} (with debug on failure)"
  block:

    - name: "POSTGRES | Enable login for role {{ database_username }}"
      community.postgresql.postgresql_query:
        db: postgres
        login_user: postgres
        login_password: "{{ POSTGRES_PASSWORD }}"
        login_host: "{{ POSTGRES_LOCAL_HOST }}"
        login_port: "{{ POSTGRES_PORT }}"
        query: |
          ALTER ROLE "{{ database_username }}"
            WITH LOGIN;
      register: postgres_enable_login
      until: postgres_enable_login is succeeded
      retries: "{{ POSTGRES_RETRIES }}"
      delay: "{{ POSTGRES_DELAY }}"
      no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

  rescue:

    # --- High-signal Ansible context -----------------------------------------
    - name: "POSTGRES | Debug context (vars, without secrets)"
      ansible.builtin.debug:
        msg:
          application_id: "{{ application_id }}"
          database_name: "{{ database_name }}"
          database_username: "{{ database_username }}"
          POSTGRES_CONTAINER: "{{ POSTGRES_CONTAINER }}"
          POSTGRES_LOCAL_HOST: "{{ POSTGRES_LOCAL_HOST }}"
          POSTGRES_PORT: "{{ POSTGRES_PORT }}"
          POSTGRES_NETWORK_NAME: "{{ POSTGRES_NETWORK_NAME | default('n/a') }}"
          POSTGRES_VERSION: "{{ POSTGRES_VERSION | default('n/a') }}"
          POSTGRES_IMAGE: "{{ POSTGRES_IMAGE | default('n/a') }}"
      changed_when: false

    - name: "POSTGRES | docker info (DockerRootDir)"
      ansible.builtin.shell: |
        set -e
        {% raw %}
        docker info -f '{{.DockerRootDir}}' 2>/dev/null || true
        {% endraw %}
      register: dbg_docker_root_dir
      changed_when: false
      failed_when: false

    # --- Container existence & status ----------------------------------------
    - name: "POSTGRES | docker ps (postgres)"
      ansible.builtin.command: "docker ps -a --no-trunc --filter name=^/{{ POSTGRES_CONTAINER }}$"
      register: dbg_docker_ps
      changed_when: false
      failed_when: false

    - name: "POSTGRES | docker inspect (escaped go-templates)"
      ansible.builtin.shell: |
        set -e

        echo "== Container state =="
        {% raw %}
        docker inspect --format 'Name={{.Name}} State={{.State.Status}} ExitCode={{.State.ExitCode}} StartedAt={{.State.StartedAt}} Restarting={{.State.Restarting}}'
        {% endraw %} {{ POSTGRES_CONTAINER }}

        echo
        echo "== Image =="
        {% raw %}
        docker inspect --format 'Image={{.Config.Image}}'
        {% endraw %} {{ POSTGRES_CONTAINER }}

        echo
        echo "== Mounts =="
        {% raw %}
        docker inspect --format '{{range .Mounts}}{{.Type}}:{{.Source}}->{{.Destination}}{{"\n"}}{{end}}'
        {% endraw %} {{ POSTGRES_CONTAINER }}

        echo
        echo "== Env (redacted) =="
        {% raw %}
        docker inspect --format '{{range .Config.Env}}{{println .}}{{end}}'
        {% endraw %} {{ POSTGRES_CONTAINER }} | sed -E 's/=.*/=***REDACTED***/'
      register: dbg_docker_inspect
      changed_when: false
      failed_when: false

    - name: "POSTGRES | docker logs (last 250 lines)"
      ansible.builtin.command: "docker logs --tail 250 {{ POSTGRES_CONTAINER }}"
      register: dbg_docker_logs
      changed_when: false
      failed_when: false

    # --- Port / connectivity checks ------------------------------------------
    - name: "POSTGRES | Check port listening on host (ss)"
      ansible.builtin.shell: "ss -lntp | grep -E '(:{{ POSTGRES_PORT }}\\s)' || true"
      register: dbg_ss
      changed_when: false
      failed_when: false

    - name: "POSTGRES | pg_isready inside container"
      ansible.builtin.shell: "docker exec {{ POSTGRES_CONTAINER }} pg_isready -U postgres || true"
      register: dbg_pg_isready
      changed_when: false
      failed_when: false

    # Password auth test
    - name: "POSTGRES | psql auth test (SELECT 1) using PGPASSWORD"
      ansible.builtin.shell: >
        {{ POSTGRES_EXEC_SHELL }}
        'psql -U postgres -d postgres -c "SELECT 1"'
      register: dbg_psql_select1
      changed_when: false
      failed_when: false
      no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

    # --- Server-side details (best effort) -----------------------------------
    - name: "POSTGRES | Show hba_file + config_file"
      ansible.builtin.shell: >
        {{ POSTGRES_EXEC_SHELL }}
        'psql -U postgres -d postgres -Atc
        "SHOW hba_file; SHOW config_file;"'
      register: dbg_psql_show_files
      changed_when: false
      failed_when: false
      no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

    - name: "POSTGRES | Dump pg_hba.conf (best effort)"
      ansible.builtin.shell: |
        set -e
        hba="$(docker exec {{ POSTGRES_CONTAINER }} sh -lc 'PGPASSWORD={{ POSTGRES_PASSWORD | quote }} psql -U postgres -d postgres -Atc "SHOW hba_file;" 2>/dev/null' || true)"
        if [ -n "$hba" ]; then
          echo "hba_file=$hba"
          docker exec {{ POSTGRES_CONTAINER }} sh -lc "sed -n '1,200p' \"$hba\" 2>/dev/null || true"
        else
          echo "hba_file could not be determined"
        fi
      register: dbg_pg_hba
      changed_when: false
      failed_when: false
      no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

    - name: "POSTGRES | Active connections / roles snapshot (best effort)"
      ansible.builtin.shell: >
        {{ POSTGRES_EXEC_SHELL }}
        'psql -U postgres -d postgres -c
        "SELECT now(), usename, client_addr, state, wait_event_type, wait_event, query FROM pg_stat_activity ORDER BY state, usename LIMIT 30;
         \\du+"'
      register: dbg_psql_activity_roles
      changed_when: false
      failed_when: false
      no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

    # --- Final consolidated output -------------------------------------------
    - name: "POSTGRES | Failure report (sanitized)"
      ansible.builtin.debug:
        msg:
          original_error: "{{ ansible_failed_result | default({}) }}"
          docker_root_dir: "{{ dbg_docker_root_dir.stdout | default('') }}"
          docker_ps: "{{ dbg_docker_ps.stdout | default('') }}"
          docker_inspect: "{{ dbg_docker_inspect.stdout | default('') }}"
          docker_logs: "{{ dbg_docker_logs.stdout | default('') }}"
          ss: "{{ dbg_ss.stdout | default('') }}"
          pg_isready: "{{ dbg_pg_isready.stdout | default('') }}"
          psql_select1_rc: "{{ dbg_psql_select1.rc | default('n/a') }}"
          psql_select1_out: "{{ (dbg_psql_select1.stdout | default(''))[:4000] }}"
          psql_select1_err: "{{ (dbg_psql_select1.stderr | default(''))[:4000] }}"
          psql_show_files_rc: "{{ dbg_psql_show_files.rc | default('n/a') }}"
          psql_show_files_out: "{{ (dbg_psql_show_files.stdout | default(''))[:4000] }}"
          pg_hba_head: "{{ (dbg_pg_hba.stdout | default(''))[:4000] }}"
          psql_activity_roles_rc: "{{ dbg_psql_activity_roles.rc | default('n/a') }}"
          psql_activity_roles_out: "{{ (dbg_psql_activity_roles.stdout | default(''))[:4000] }}"
          psql_activity_roles_err: "{{ (dbg_psql_activity_roles.stderr | default(''))[:4000] }}"
          postgres_enable_login: "{{ postgres_enable_login | default({}) }}"
      changed_when: false

    - name: "POSTGRES | Fail explicitly after debug"
      ansible.builtin.fail:
        msg: >-
          Failed to ALTER ROLE "{{ database_username }}" WITH LOGIN.
          See debug output above (docker logs, inspect, pg_isready, psql auth test, hba/config).

# 4) Grant ALL privileges on all tables in the public schema
- name: "Grant ALL privileges on tables in public schema to {{ database_username }}"
  community.postgresql.postgresql_privs:
    db:     "{{ database_name }}"
    roles:   "{{ database_username }}"
    objs:   ALL_IN_SCHEMA
    privs:  ALL
    type:   table
    schema: public
    state:  present
    login_user:     postgres
    login_password: "{{ POSTGRES_PASSWORD }}"
    login_host:     "{{ POSTGRES_LOCAL_HOST }}"
    login_port:     "{{ POSTGRES_PORT }}"
  register: postgresql_result
  until: postgresql_result is succeeded
  retries: "{{ POSTGRES_RETRIES }}"
  delay: "{{ POSTGRES_DELAY }}"

# 5) Grant ALL privileges at the database level
- name: "Grant all privileges on database {{ database_name }} to {{ database_username }}"
  community.postgresql.postgresql_privs:
    db:    "{{ database_name }}"
    roles:  "{{ database_username }}"
    type:  database
    privs: ALL
    state: present
    login_user:     postgres
    login_password: "{{ POSTGRES_PASSWORD }}"
    login_host:     "{{ POSTGRES_LOCAL_HOST }}"
    login_port:     "{{ POSTGRES_PORT }}"
  register: postgresql_result
  until: postgresql_result is succeeded
  retries: "{{ POSTGRES_RETRIES }}"
  delay: "{{ POSTGRES_DELAY }}"

# 6) Grant USAGE/CREATE on schema and set default privileges
- name: "Set comprehensive schema privileges for {{ database_username }}"
  community.postgresql.postgresql_query:
    db: "{{ database_name }}"
    login_user: postgres
    login_password: "{{ POSTGRES_PASSWORD }}"
    login_host: "{{ POSTGRES_LOCAL_HOST }}"
    login_port: "{{ POSTGRES_PORT }}"
    query: |
      GRANT USAGE ON SCHEMA public TO "{{ database_username }}";
      GRANT CREATE ON SCHEMA public TO "{{ database_username }}";
      ALTER DEFAULT PRIVILEGES IN SCHEMA public
        GRANT ALL PRIVILEGES ON TABLES TO "{{ database_username }}";
  register: postgresql_result
  until: postgresql_result is succeeded
  retries: "{{ POSTGRES_RETRIES }}"
  delay: "{{ POSTGRES_DELAY }}"

# 7) Ensure PostGIS and related extensions are installed (if enabled)
- name: "Ensure PostGIS-related extensions are installed"
  community.postgresql.postgresql_ext:
    db:         "{{ database_name }}"
    ext:        "{{ item }}"
    state:      present
    login_user:     postgres
    login_password: "{{ POSTGRES_PASSWORD }}"
    login_host:     "{{ POSTGRES_LOCAL_HOST }}"
    login_port:     "{{ POSTGRES_PORT }}"
  loop:
    - postgis
    - pg_trgm
    - unaccent
  when: postgres_gis_enabled | bool
  register: postgresql_result
  until: postgresql_result is succeeded
  retries: "{{ POSTGRES_RETRIES }}"
  delay: "{{ POSTGRES_DELAY }}"

# 8) Ensure pgvector (vector) extension is installed
- name: "Ensure pgvector (vector) extension is installed"
  community.postgresql.postgresql_ext:
    db:           "{{ database_name }}"
    ext:          vector
    state:        present
    login_user:   postgres
    login_password: "{{ POSTGRES_PASSWORD }}"
    login_host:   "{{ POSTGRES_LOCAL_HOST }}"
    login_port:   "{{ POSTGRES_PORT }}"
  register: postgresql_result
  until: postgresql_result is succeeded
  retries: "{{ POSTGRES_RETRIES }}"
  delay: "{{ POSTGRES_DELAY }}"
