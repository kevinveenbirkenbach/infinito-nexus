---
- name: Check if current RootDN/RootPW already work
  ansible.builtin.shell: >
    docker exec {{ OPENLDAP_CONTAINER }}
    ldapwhoami -x -H ldap://127.0.0.1:389 -D "{{ OPENLDAP_BIND_DN }}" -w "{{ OPENLDAP_BIND_PW }}"
  register: openldap_bind_check
  changed_when: false
  failed_when: false

- name: Query data backend DN (cn=config)
  ansible.builtin.shell: >
    docker exec {{ OPENLDAP_CONTAINER }}
    ldapsearch -Q -Y EXTERNAL -H ldapi:/// -LLL -b cn=config "(olcDatabase=*)" dn
  register: ldap_databases
  changed_when: false
  when: openldap_bind_check.rc != 0

- name: Determine data backend DN (prefer mdb, fallback hdb)
  ansible.builtin.set_fact:
    openldap_data_backend_dn: >-
      {{
        (
          ldap_databases.stdout_lines
          | select('search', '^dn: olcDatabase=.*mdb,cn=config$')
          | map('regex_replace', '^dn: ', '')
          | list
          | first
          | default('')
        )
        | default(
          (
            ldap_databases.stdout_lines
            | select('search', '^dn: olcDatabase=.*hdb,cn=config$')
            | map('regex_replace', '^dn: ', '')
            | list
            | first
            | default('')
          )
        )
      }}
  when: openldap_bind_check.rc != 0

- name: Fail if backend DN could not be detected
  ansible.builtin.fail:
    msg: "Could not detect OpenLDAP data backend DN from cn=config."
  when:
    - openldap_bind_check.rc != 0
    - openldap_data_backend_dn | default('') | length == 0

- name: Generate hash for desired RootPW
  ansible.builtin.shell: >
    docker exec {{ OPENLDAP_CONTAINER }}
    slappasswd -s "{{ OPENLDAP_BIND_PW }}"
  register: openldap_rootpw_hash
  changed_when: false
  when: openldap_bind_check.rc != 0

- name: Set RootDN and RootPW only if bind check failed
  ansible.builtin.shell: |
    docker exec -i {{ OPENLDAP_CONTAINER }} ldapmodify -Q -Y EXTERNAL -H ldapi:/// <<EOF
    dn: {{ openldap_data_backend_dn }}
    changetype: modify
    replace: olcRootDN
    olcRootDN: {{ OPENLDAP_BIND_DN }}
    -
    replace: olcRootPW
    olcRootPW: {{ openldap_rootpw_hash.stdout }}
    EOF
  when: openldap_bind_check.rc != 0
  changed_when: true
