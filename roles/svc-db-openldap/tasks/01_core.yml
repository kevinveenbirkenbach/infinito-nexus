---
- name: Initialize docker
  include_tasks: 02_docker.yml
  vars:
    docker_network_name: "{{ OPENLDAP_NETWORK }}"
    docker_network_subnet: "{{ networks.local[application_id].subnet }}"

- name: Create {{ domains | get_domain(application_id) }}.conf if LDAP is exposed to internet
  template:
    src: "nginx.stream.conf.j2"
    dest: "{{ NGINX.DIRECTORIES.STREAMS }}{{ domains | get_domain(application_id) }}.conf"
  notify: restart openresty
  when: OPENLDAP_NETWORK_SWITCH_PUBLIC | bool

- name: Remove {{ domains | get_domain(application_id) }}.conf if LDAP is not exposed to internet
  file:
    path: "{{ NGINX.DIRECTORIES.STREAMS }}{{ domains | get_domain(application_id) }}.conf"
    state: absent
  when: not OPENLDAP_NETWORK_SWITCH_PUBLIC | bool

- name: "Wait for LDAP to be available"
  wait_for:
    host: "{{ DOCKER_REACH_HOST }}"
    port: "{{ ports.localhost.ldap[application_id] }}"
    delay: 5
    timeout: 120
    state: started

- name: Check if current RootDN/RootPW already work
  ansible.builtin.shell: >
    docker exec {{ OPENLDAP_CONTAINER }}
    ldapwhoami -x -H ldap://127.0.0.1:389 -D "{{ OPENLDAP_BIND_DN }}" -w "{{ OPENLDAP_BIND_PW }}"
  register: openldap_bind_check
  changed_when: false
  failed_when: false

- name: Ensure LDAP RootPW is set on every deploy
  include_tasks: 02_credentials.yml
  when:
    - OPENLDAP_NETWORK_SWITCH_LOCAL | bool
    - OPENLDAP_PROVISION_CREDENTIALS | bool
    - openldap_bind_check.rc != 0

# NOTE: Credentials reset removed (Bitnami-specific). RootDN/RootPW are bootstrapped via container env.

- name: "Create LDIF directories under {{ OPENLDAP_LDIF_PATH_HOST }}"
  file:
    path: "{{ OPENLDAP_LDIF_PATH_HOST }}{{ item }}"
    state: directory
    mode: "0755"
  loop: "{{ OPENLDAP_LDIF_TYPES }}"

- name: Query cn=config module lists
  shell: >
    docker exec {{ OPENLDAP_CONTAINER }}
    ldapsearch -Q -Y EXTERNAL -H {{ OPENLDAP_CONFIG_URI }} -LLL -b cn=config "(objectClass=olcModuleList)" dn
  register: ldap_modules_dns
  changed_when: false

- name: Set OPENLDAP_MODULE_DN (prefer cn=module{0}, fallback first module list)
  set_fact:
    OPENLDAP_MODULE_DN: >-
      {{
        (
          ldap_modules_dns.stdout_lines
          | select('match', '^dn: ')
          | map('regex_replace', '^dn: ', '')
          | list
        )
        | select('search', 'cn=module\\{0\\},cn=config')
        | list
        | first
        | default(
            (
              ldap_modules_dns.stdout_lines
              | select('match', '^dn: ')
              | map('regex_replace', '^dn: ', '')
              | list
              | first
            )
          )
      }}

- name: Query available LDAP databases
  shell: >
    docker exec {{ OPENLDAP_CONTAINER }}
    ldapsearch -Q -Y EXTERNAL -H {{ OPENLDAP_CONFIG_URI }} -LLL -b cn=config "(olcDatabase=*)" dn
  register: ldap_databases
  changed_when: false

- name: Set OPENLDAP_DATA_BACKEND_DN (mdb preferred, hdb fallback)
  set_fact:
    OPENLDAP_DATA_BACKEND_DN: >-
      {{
        (
          ldap_databases.stdout_lines
          | select('search', '^dn: olcDatabase=.*mdb')
          | map('regex_replace', '^dn: ', '')
          | list
          | first
        )
        | default(
          (
            ldap_databases.stdout_lines
            | select('search', '^dn: olcDatabase=.*hdb')
            | map('regex_replace', '^dn: ', '')
            | list
            | first
          )
        )
      }}

- name: "Import LDIF Configuration"
  include_tasks: _ldifs_creation.yml
  loop:
    - configuration
  loop_control:
    loop_var: folder
  when: OPENLDAP_PROVISION_CONFIGURATION | bool

- name: flush LDIF handlers
  meta: flush_handlers

- name: Install python-ldap via OS package manager
  ansible.builtin.package:
    name: "{{ python_ldap_pkg }}"
    state: present
  vars:
    python_ldap_pkg: >-
      {{
        (ansible_facts.distribution == 'Archlinux')
        | ternary('python-ldap', 'python3-ldap')
      }}

- name: Sanity check python-ldap import (verbose)
  ansible.builtin.shell: |
    set -euo pipefail
    {{ ansible_python_interpreter }} - <<'EOF'
    import traceback
    try:
        import ldap
        print("python-ldap version:", ldap.__version__)
        print("ldap module:", ldap.__file__)
    except Exception:
        traceback.print_exc()
        raise
    EOF
  changed_when: false
  when: MODE_DEBUG | bool

- name: "Include Schemas (if enabled)"
  include_tasks: 03_schemas.yml
  when: OPENLDAP_PROVISION_SCHEMAS | bool

- name: "Import LDAP Entries (if enabled)"
  include_tasks: 04_users.yml
  when: OPENLDAP_PROVISION_USERS | bool

- name: "Import LDIF Data (if enabled)"
  include_tasks: _ldifs_creation.yml
  loop:
    - groups
  loop_control:
    loop_var: folder
  when: OPENLDAP_PROVISION_GROUPS | bool

- meta: flush_handlers

- name: "Add Objects to all users"
  include_tasks: 05_update.yml
  when: OPENLDAP_PROVISION_UPDATE | bool

- include_tasks: utils/once/flag.yml
