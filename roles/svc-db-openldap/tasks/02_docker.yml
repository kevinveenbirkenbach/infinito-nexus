- name: "include docker-compose role"
  include_role:
    name: docker-compose
  vars:
    docker_compose_flush_handlers:  false
    docker_git_repository_pull:     false
    application_id:                 'svc-db-openldap'

- name: Create docker network
  community.docker.docker_network:
    name: "{{ docker_network_name }}"
    state: present
    ipam_config:
      - subnet: "{{ docker_network_subnet }}"
  vars:
    docker_network_name: "{{ OPENLDAP_NETWORK }}"
    docker_network_subnet: "{{ networks.local[application_id].subnet }}"

- name: Copy OpenLDAP image files to instance dir
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "{{ [ lookup('docker', application_id, 'directories.instance'), item.dest ] | path_join }}"
    mode: "{{ item.mode }}"
  loop:
    - { src: "entrypoint.sh",  dest: "entrypoint.sh",  mode: "0755" }
    - { src: "healthcheck.sh", dest: "healthcheck.sh", mode: "0755" }
  loop_control:
    label: "{{ item.dest }}"

- name: "Flush docker compose handlers"
  meta: flush_handlers
