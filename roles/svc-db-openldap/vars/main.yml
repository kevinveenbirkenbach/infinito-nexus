application_id:                 "svc-db-openldap"
entity_name:                    "{{ application_id | get_entity_name }}"

# LDAP Variables
OPENLDAP_DOCKER_PORT_OPEN:      389
OPENLDAP_SERVER_URI:            "ldap://{{ DOCKER_REACH_HOST }}:{{ ports.localhost.ldap[application_id] }}"

# cn=config is managed via LDAPI + SASL EXTERNAL (no bind DN/PW needed)
OPENLDAP_CONFIG_URI:            "ldapi:///"

# LDIF Variables
OPENLDAP_LDIF_PATH_HOST:        "{{ lookup('docker', application_id, want='directories.volumes') }}ldif/"
OPENLDAP_LDIF_PATH_DOCKER:      "/tmp/ldif/"
OPENLDAP_LDIF_TYPES:
  - configuration
  - groups

# Container
OPENLDAP_CONTAINER:             "{{ applications | get_app_conf(application_id, 'docker.services.' ~ entity_name ~ '.name') }}"
OPENLDAP_IMAGE:                 "{{ applications | get_app_conf(application_id, 'docker.services.' ~ entity_name ~ '.image') }}"
OPENLDAP_VERSION:               "{{ applications | get_app_conf(application_id, 'docker.services.' ~ entity_name ~ '.version') }}"
OPENLDAP_VOLUME:                "{{ applications | get_app_conf(application_id, 'docker.volumes.data') }}"
OPENLDAP_NETWORK:               "{{ applications | get_app_conf(application_id, 'docker.network') }}"
OPENLDAP_SERVICE:               "{{ entity_name }}"
OPENLDAP_IMAGE_CUSTOM:          "infinito/openldap:local"
OPENLDAP_BIND_DN:               "{{ LDAP.DN.ADMINISTRATOR.DATA }}"
OPENLDAP_BIND_PW:               "{{ LDAP.BIND_CREDENTIAL }}"

# Network
OPENLDAP_NETWORK_SWITCH_PUBLIC: "{{ applications | get_app_conf(application_id, 'network.public') }}"
OPENLDAP_NETWORK_SWITCH_LOCAL:  "{{ applications | get_app_conf(application_id, 'network.local') }}"
OPENLDAP_NETWORK_EXPOSE_LOCAL:  "{{ OPENLDAP_NETWORK_SWITCH_PUBLIC | bool or OPENLDAP_NETWORK_SWITCH_LOCAL | bool }}"

# Provision
OPENLDAP_PROVISION_CONFIGURATION: "{{ applications | get_app_conf(application_id, 'provision.configuration') }}"
OPENLDAP_PROVISION_CREDENTIALS:   "{{ applications | get_app_conf(application_id, 'provision.credentials') }}"
OPENLDAP_PROVISION_SCHEMAS:       "{{ applications | get_app_conf(application_id, 'provision.schemas') }}"
OPENLDAP_PROVISION_USERS:         "{{ applications | get_app_conf(application_id, 'provision.users') }}"
OPENLDAP_PROVISION_GROUPS:        "{{ applications | get_app_conf(application_id, 'provision.groups') }}"
OPENLDAP_PROVISION_UPDATE:        "{{ applications | get_app_conf(application_id, 'provision.update') }}"
OPENLDAP_PROVISION_RESERVED:      "{{ applications | get_app_conf(application_id, 'provision.reserved') }}"

# Users to be processed by LDAP
OPENLDAP_USERS:                   "{{ users if OPENLDAP_PROVISION_RESERVED else users | non_reserved_users }}"
