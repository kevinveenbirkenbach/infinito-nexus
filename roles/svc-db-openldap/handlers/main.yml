- name: Load memberof module in OpenLDAP
  ansible.builtin.shell: >-
    docker exec -i {{ OPENLDAP_CONTAINER }} ldapmodify -Y EXTERNAL -H ldapi:///
    -f "{{ [OPENLDAP_LDIF_PATH_DOCKER, 'configuration/01_member_of_configuration.ldif'] | path_join }}"
  listen:
    - "Import configuration LDIF files"
  register: r
  failed_when: >-
    r.rc != 0 and (
      "Type or value exists" not in (r.stderr | default('')) and
      "already exists" not in (r.stderr | default('')) and
      "Duplicate value" not in (r.stderr | default('')) and
      "Duplicate attribute value" not in (r.stderr | default(''))
    )

- name: Load refint module in OpenLDAP
  ansible.builtin.shell: >-
    docker exec -i {{ OPENLDAP_CONTAINER }} ldapmodify -Y EXTERNAL -H ldapi:///
    -f "{{ [OPENLDAP_LDIF_PATH_DOCKER, 'configuration/04_refint_module.ldif'] | path_join }}"
  listen:
    - "Import configuration LDIF files"
  register: r
  failed_when: >-
    r.rc != 0 and (
      "Type or value exists" not in (r.stderr | default('')) and
      "already exists" not in (r.stderr | default('')) and
      "Duplicate value" not in (r.stderr | default('')) and
      "Duplicate attribute value" not in (r.stderr | default(''))
    )

- name: Add memberof overlay
  ansible.builtin.shell: >-
    docker exec -i {{ OPENLDAP_CONTAINER }} ldapadd -Y EXTERNAL -H ldapi:///
    -f "{{ [OPENLDAP_LDIF_PATH_DOCKER, 'configuration/02_member_of_configuration.ldif'] | path_join }}"
  listen:
    - "Import configuration LDIF files"
  register: r
  failed_when: r.rc not in [0, 68]

- name: Add refint overlay
  ansible.builtin.shell: >-
    docker exec -i {{ OPENLDAP_CONTAINER }} ldapadd -Y EXTERNAL -H ldapi:///
    -f "{{ [OPENLDAP_LDIF_PATH_DOCKER, 'configuration/03_member_of_configuration.ldif'] | path_join }}"
  listen:
    - "Import configuration LDIF files"
  register: r
  failed_when: r.rc not in [0, 68]

- name: Import users, groups, etc. to LDAP
  ansible.builtin.shell: >-
    docker exec -i {{ OPENLDAP_CONTAINER }} ldapadd -x
    -D "{{ LDAP.DN.ADMINISTRATOR.DATA }}"
    -w "{{ LDAP.BIND_CREDENTIAL }}"
    -c
    -f "{{ [OPENLDAP_LDIF_PATH_DOCKER, 'groups', (item | basename | regex_replace('\.j2$', ''))] | path_join }}"
  listen:
    - "Import groups LDIF files"
  register: ldapadd_result
  changed_when: "'adding new entry' in (ldapadd_result.stdout | default(''))"
  failed_when: ldapadd_result.rc not in [0, 20, 68, 65]
  loop: "{{ query('fileglob', role_path ~ '/templates/ldif/groups/*.j2') | sort }}"
  loop_control:
    label: "{{ item | basename }}"
