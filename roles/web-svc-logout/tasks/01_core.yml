- include_tasks: utils/once/flag.yml

- name: "Add logout domains to CSP connect-src"
  set_fact:
    applications: >-
      {{
        applications | combine(
          {
            application_id: {
              'server': {
                'csp': {
                  'whitelist': {
                    'connect-src': LOGOUT_CONNECT_SRC_NEW
                  }
                }
              }
            }
          },
          recursive=True
        )
      }}

- name: "load docker, proxy for '{{ application_id }}'"
  include_role:
    name: sys-stk-full
  vars:
    application_id:                 'web-svc-logout'
    webserver_client_max_body_size: "10M" # Necessary to overwrite parent values
    webserver_websocket_location:   ""
    webserver_vhost_flavour:        "basic"
    webserver_extra_configuration:  ""
    docker_git_repository_address:  "https://github.com/kevinveenbirkenbach/universal-logout"
    docker_git_repository_pull:     true
    docker_git_repository_branch:   "main"
    docker_compose_flush_handlers:  true

- name: Create symbolic link from .env file to repository
  file:
    src:    "{{ docker_compose.files.env }}"
    dest:   "{{ [ docker_repository_path, '.env' ] | path_join  }}"
    state:  link
