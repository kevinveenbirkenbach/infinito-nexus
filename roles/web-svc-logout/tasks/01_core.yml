- include_tasks: utils/once/flag.yml

- name: "Add logout domains to CSP connect-src"
  set_fact:
    applications: >-
      {{
        applications | combine(
          {
            application_id: {
              'server': {
                'csp': {
                  'whitelist': {
                    'connect-src': LOGOUT_CONNECT_SRC_NEW
                  }
                }
              }
            }
          },
          recursive=True
        )
      }}

- name: "load docker, proxy for '{{ application_id }}'"
  include_role:
    name: sys-stk-full-stateless
  vars:
    client_max_body_size:         "10M" # Necessary to overwrite parent values
    location_ws:                  ""
    docker_repository_address:    "https://github.com/kevinveenbirkenbach/universal-logout"
    docker_pull_git_repository:   true

- name: Create symbolic link from .env file to repository
  file:
    src:    "{{ docker_compose.files.env }}"
    dest:   "{{ [ docker_repository_path, '.env' ] | path_join  }}"
    state:  link

- include_tasks: "{{ [playbook_dir, 'roles/docker-compose/tasks/utils/up.yml' ] | path_join }}"