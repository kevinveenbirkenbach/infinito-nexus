- name: Include dependencies
  include_role:
    name: '{{ item }}'
  loop:
  - sys-pip
  - sys-ctl-alm-compose

- name: Install required Python modules
  package:
    name: python-requests
    state: present

- name: "Flush webserver handlers"
  meta: flush_handlers

- include_role:
    name: sys-service
  vars:
    system_service_on_calendar:           "{{ SYS_SCHEDULE_HEALTH_NGINX }}"
    system_service_timer_enabled:         true
    system_service_tpl_on_failure:        "{{ SYS_SERVICE_ON_FAILURE_COMPOSE }}"
    system_service_tpl_timeout_start_sec: "{{ CURRENT_PLAY_DOMAINS_ALL | timeout_start_sec_for_domains }}"
    system_service_tpl_exec_start: > 
      {{ system_service_script_exec }}
      --web-protocol {{ WEB_PROTOCOL }}
      --expectations '{{ applications | web_health_expectations(www_enabled=WWW_REDIRECT_ENABLED | bool, group_names=group_names) | to_json }}'
    system_service_force_flush_final:             true # The healthcheck will just work after all routines passed

- include_tasks: utils/once/flag.yml
