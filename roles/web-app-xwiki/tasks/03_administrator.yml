# Ensure an admin user exists (when SSO is disabled) and can administer XWiki.

- name: "XWIKI | Fetch REST session + form token (admin write ops)"
  include_tasks: _rest_session.yml

# 1) Create page XWiki.<userid> (PUT is idempotent)
- name: "XWIKI | Ensure user page exists: XWiki.{{ XWIKI_ADMIN_USER }}"
  uri:
    url: "{{ [XWIKI_REST_XWIKI_PAGES, XWIKI_ADMIN_USER | urlencode] | url_join }}"
    method: PUT
    url_username: "{{ XWIKI_SUPERADMIN_USERNAME }}"
    url_password: "{{ XWIKI_SUPERADMIN_PASSWORD }}"
    force_basic_auth: true
    status_code: [201, 202, 204, 200]
    headers: "{{ xwiki_rest_headers_write }}"
    body: |
      <page xmlns="http://www.xwiki.org">
        <title>{{ XWIKI_ADMIN_USER }}</title>
      </page>
  register: _user_page

# 2) Add XWiki.XWikiUsers object (only if it does not already exist)
- name: "XWIKI | Check if XWikiUsers object exists"
  uri:
    url: "{{ [XWIKI_REST_XWIKI_PAGES, XWIKI_ADMIN_USER | urlencode, 'objects'] | url_join }}?classname=XWiki.XWikiUsers"
    method: GET
    url_username: "{{ XWIKI_SUPERADMIN_USERNAME }}"
    url_password: "{{ XWIKI_SUPERADMIN_PASSWORD }}"
    force_basic_auth: true
    status_code: [200, 404]
  register: _users_obj_list

- name: "XWIKI | Add XWiki.XWikiUsers object"
  uri:
    url: "{{ [XWIKI_REST_XWIKI_PAGES, XWIKI_ADMIN_USER | urlencode, 'objects'] | url_join }}"
    method: POST
    url_username: "{{ XWIKI_SUPERADMIN_USERNAME }}"
    url_password: "{{ XWIKI_SUPERADMIN_PASSWORD }}"
    force_basic_auth: true
    status_code: [201, 200]
    headers: "{{ xwiki_rest_headers_write }}"
    body: |
      <object xmlns="http://www.xwiki.org">
        <className>XWiki.XWikiUsers</className>
        <properties>
          <property name="first_name">{{ users.administrator.firstname | default('Admin') }}</property>
          <property name="last_name">{{ users.administrator.lastname  | default('User') }}</property>
          <property name="email">{{ users.administrator.email }}</property>
          <property name="active">1</property>
        </properties>
      </object>
  when: _users_obj_list.status == 404 or ('<object' not in (_users_obj_list.content | default('')))
  register: _user_obj_created

# 3) Assign admin rights by adding the user to XWikiAdminGroup (only when no SSO)
- name: "XWIKI | Ensure user is in XWikiAdminGroup"
  uri:
    url: "{{ [XWIKI_REST_XWIKI_PAGES, 'XWikiAdminGroup/objects'] | url_join }}"
    method: POST
    url_username: "{{ XWIKI_SUPERADMIN_USERNAME }}"
    url_password: "{{ XWIKI_SUPERADMIN_PASSWORD }}"
    force_basic_auth: true
    status_code: [201, 200]
    headers: "{{ xwiki_rest_headers_write }}"
    body: |
      <object xmlns="http://www.xwiki.org">
        <className>XWiki.XWikiGroups</className>
        <properties>
          <property name="member">XWiki.{{ XWIKI_ADMIN_USER }}</property>
        </properties>
      </object>
  when: XWIKI_LDAP_ENABLED | bool == false and XWIKI_OIDC_ENABLED | bool == false
