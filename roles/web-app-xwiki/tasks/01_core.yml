- name: Validate XWiki variables
  include_tasks: 02_validation.yml

- block:
    - name: "load docker, db and proxy for {{ application_id }}"
      include_role:
        name: sys-stk-full
      vars:
        docker_compose_flush_handlers: false

    - name: Deploy Bootstrap Config
      include_tasks: _flush_config.yml
  vars:
    xwiki_oidc_enabled_switch:        false
    xwiki_ldap_enabled_switch:        false

- name: "ASSERT | superadmin can authenticate (needed for installer)"
  uri:
    url: "{{ [XWIKI_REST_XWIKI, 'spaces'] | url_join }}"
    method: GET
    url_username: "{{ XWIKI_SUPERADMIN_USERNAME }}"
    url_password: "{{ XWIKI_SUPERADMIN_PASSWORD }}"
    force_basic_auth: true
    status_code: [200, 401, 403, 500, 503]
    return_content: yes
  register: _super_check_ext
  changed_when: false
  failed_when: false

- block:
    - name: "DEBUG | superadmin check details"
      debug:
        msg: |
          status={{ _super_check_ext.status }}
          redirected={{ _super_check_ext.redirected | default('n/a') }}
          url={{ _super_check_ext.url | default('n/a') }}
          www_authenticate={{
            _super_check_ext.www_authenticate
            | default(_super_check_ext.headers['www-authenticate'] | default('n/a'))
          }}
          content_type={{ _super_check_ext.content_type | default(_super_check_ext.headers['content-type'] | default('n/a')) }}
          content={{ (_super_check_ext.content | default(''))[:600] }}
      changed_when: false

    - name: "DEBUG | Compare superadminpassword (hash only)"
      shell: |
        set -euo pipefail

        echo -n "container_hash="
        docker exec "{{ XWIKI_CONTAINER }}" sh -lc '
          cfg="/usr/local/tomcat/webapps/ROOT/WEB-INF/xwiki.cfg";
          if [ ! -f "$cfg" ]; then
            echo "<missing-xwiki.cfg>"
            exit 0
          fi
          grep -E "^xwiki\.superadminpassword=" "$cfg" \
            | sed "s/^xwiki\.superadminpassword=//" \
            | sha256sum | awk "{print \$1}"
        ' || true

        echo -n "ansible_hash="
        printf "%s" "{{ XWIKI_SUPERADMIN_PASSWORD }}" | sha256sum | awk '{print $1}'
      register: _dbg_pw_hash
      changed_when: false
      failed_when: false

    - name: "DEBUG | Password hash outputs"
      debug:
        var: _dbg_pw_hash.stdout_lines
      changed_when: false

    - name: "FAIL | superadmin authentication failed (extensions phase)"
      fail:
        msg: |
          superadmin authentication failed (extensions phase)

          superadmin check status={{ _super_check_ext.status }}
          www_authenticate={{
            _super_check_ext.www_authenticate
            | default(_super_check_ext.headers['www-authenticate'] | default('n/a'))
          }}

          hashes:
          {{ _dbg_pw_hash.stdout_lines | default([]) | join('\n') }}

          hint: check xwiki.cfg in image / password / Dockerfile build
  when: _super_check_ext.status != 200


- name: Load setup procedures for admin
  include_tasks: 03_administrator.yml
  when: not (XWIKI_SSO_ENABLED | bool)

- name: Load setup procedures for extensions
  include_tasks: 04_extensions.yml

- block:
    - name:           "Create Final Docker Compose File"
      template:
        src:          "docker-compose.yml.j2"
        dest:         "{{ docker_compose.files.docker_compose }}"
      notify:         docker compose up
    
    - name: Deploy Final Config
      include_tasks: _flush_config.yml
  vars:
    xwiki_oidc_enabled_switch:        "{{ XWIKI_OIDC_ENABLED | bool }}"
    xwiki_ldap_enabled_switch:        "{{ XWIKI_LDAP_ENABLED | bool }}"

- include_tasks: utils/once/flag.yml
