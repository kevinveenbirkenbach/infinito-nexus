- name: Validate XWiki variables
  include_tasks: 02_validation.yml

- block:
    - name: "load docker, db and proxy for {{ application_id }}"
      include_role:
        name: sys-stk-full-stateful
      vars:
        docker_compose_flush_handlers: false

    - name: Deploy Bootstrap Config
      include_tasks: _flush_config.yml
  vars:
    xwiki_oidc_enabled_switch:        false
    xwiki_ldap_enabled_switch:        false

- name: "ASSERT | superadmin can authenticate (needed for installer)"
  uri:
    url: "{{ [XWIKI_REST_XWIKI, 'spaces'] | url_join }}"
    method: GET
    user: "{{ XWIKI_SUPERADMIN_USERNAME }}"
    password: "{{ XWIKI_SUPERADMIN_PASSWORD }}"
    force_basic_auth: true
    status_code: [200]
  register: _super_check_ext

- name: "FAIL | superadmin authentication failed (extensions phase)"
  fail:
    msg: "superadmin authentication failed (check xwiki.cfg in image / password / Dockerfile build)"
  when: _super_check_ext.status != 200

- name: Load setup procedures for admin
  include_tasks: 03_administrator.yml
  when: not (XWIKI_SSO_ENABLED | bool)

- name: Load setup procedures for extensions
  include_tasks: 04_extensions.yml

- name: "Set authentication service according to feature toggles"
  include_tasks: 05_set_authservice.yml

- name: "Run AuthDiag (temporary)"
  include_tasks: _auth_diag.yml

- block:
    - name:           "Create Final Docker Compose File"
      template:
        src:          "docker-compose.yml.j2"
        dest:         "{{ docker_compose.files.docker_compose }}"
      notify:         docker compose up
    
    - name: Deploy Final Config
      include_tasks: _flush_config.yml
  vars:
    xwiki_oidc_enabled_switch:        "{{ XWIKI_OIDC_ENABLED | bool }}"
    xwiki_ldap_enabled_switch:        "{{ XWIKI_LDAP_ENABLED | bool }}"

- include_tasks: utils/run_once.yml
