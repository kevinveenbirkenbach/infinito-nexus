# General
application_id:                       "web-app-xwiki"
domain:                               "{{ lookup('domain',application_id) }}"

container_port:                       8080
container_hostname:                   "{{ domain }}"

# XWiki

XWIKI_HOST_PORT:                      "{{ ports.localhost.http[application_id] }}"

## URLs
XWIKI_HOSTNAME:                       "{{ container_hostname }}"

## Paths
XWIKI_HOST_PROPERTIES_PATH:           "{{ [lookup('docker', application_id, 'directories.config'), 'xwiki.properties'] | path_join }}"
XWIKI_DOCK_DATA_DIR:                  "/usr/local/xwiki"

## Docker
XWIKI_IMAGE_CUSTOM:                   "xwiki_custom"
XWIKI_IMAGE:                          "{{ lookup('config',application_id, 'docker.services.xwiki.image') }}"
XWIKI_VERSION:                        "{{ lookup('config',application_id, 'docker.services.xwiki.version') }}"
XWIKI_CONTAINER:                      "{{ lookup('config',application_id, 'docker.services.xwiki.name') }}"
XWIKI_DATA_VOLUME:                    "{{ lookup('config',application_id, 'docker.volumes.data') }}"

# Feature toggles (must be set in config/main.yml -> features)
XWIKI_LDAP_ENABLED:                   "{{ lookup('config',application_id, 'docker.services.ldap.enabled') }}"
XWIKI_OIDC_ENABLED:                   "{{ lookup('config',application_id, 'docker.services.oidc.enabled') }}"
XWIKI_SSO_ENABLED:                    "{{ (XWIKI_OIDC_ENABLED | bool) or (XWIKI_LDAP_ENABLED | bool) }}"

# Admin credentials (must be provided via inventory/vault)
XWIKI_ADMIN_USER:                     "{{ users.administrator.username }}"
XWIKI_ADMIN_GROUP:                    "{{ application_id }}-administrator"

# Superadministrator
XWIKI_SUPERADMIN_PASSWORD:            "{{ lookup('config',application_id, 'credentials.superadminpassword') }}"
XWIKI_SUPERADMIN_USERNAME:            "superadmin"

XWIKI_DOCKER_REACH_URL:               "http://{{ DOCKER_REACH_HOST }}:{{ XWIKI_HOST_PORT }}"

# REST endpoint (local inside container)
XWIKI_REST_BASE:                      "{{ [XWIKI_DOCKER_REACH_URL, '/rest/'] | url_join  }}"
XWIKI_REST_XWIKI:                     "{{ [XWIKI_REST_BASE, 'wikis/xwiki'] | url_join  }}"
XWIKI_REST_XWIKI_PAGES:               "{{ [XWIKI_REST_BASE, 'wikis/xwiki/spaces/XWiki/pages'] | url_join }}"

# LDAP configuration (mapped to LDAP.* context)
XWIKI_LDAP_SERVER:                    "{{ LDAP.SERVER.DOMAIN }}"
XWIKI_LDAP_PORT:                      "{{ LDAP.SERVER.PORT }}"
XWIKI_LDAP_BASE_DN:                   "{{ LDAP.DN.ROOT }}"
XWIKI_LDAP_BIND_DN:                   "{{ LDAP.DN.ADMINISTRATOR.DATA }}"
XWIKI_LDAP_BIND_PASS:                 "{{ LDAP.BIND_CREDENTIAL }}"
XWIKI_LDAP_TRYLOCAL:                  "{{ lookup('config',application_id, 'docker.services.ldap.trylocal') }}"
XWIKI_LDAP_FIELDS_MAPPING:            "last_name={{ LDAP.USER.ATTRIBUTES.SURNAME }},first_name={{ LDAP.USER.ATTRIBUTES.FIRSTNAME }},email={{ LDAP.USER.ATTRIBUTES.MAIL }}"
XWIKI_LDAP_ADMIN_GROUP_DN:            "cn={{ XWIKI_ADMIN_GROUP ~ ',' ~ LDAP.DN.OU.GROUPS }}"

# OIDC configuration (must exist in OIDC.* context)
XWIKI_OIDC_PROVIDER:                  "{{ OIDC.CLIENT.ISSUER_URL }}"
XWIKI_OIDC_AUTHORIZATION:             "{{ OIDC.CLIENT.AUTHORIZE_URL }}"
XWIKI_OIDC_TOKEN:                     "{{ OIDC.CLIENT.TOKEN_URL }}"
XWIKI_OIDC_USERINFO:                  "{{ OIDC.CLIENT.USER_INFO_URL }}"
XWIKI_OIDC_LOGOUT:                    "{{ OIDC.CLIENT.LOGOUT_URL }}"
XWIKI_OIDC_CLIENT_ID:                 "{{ OIDC.CLIENT.ID }}"
XWIKI_OIDC_CLIENT_SECRET:             "{{ OIDC.CLIENT.SECRET }}"
XWIKI_OIDC_SCOPES:                    "openid,email,profile,{{ RBAC.GROUP.CLAIM }}"
XWIKI_OIDC_GROUPS_CLAIM:              "{{ RBAC.GROUP.CLAIM }}"
XWIKI_OIDC_ADMIN_PROVIDER_GROUP:      "{{ [RBAC.GROUP.NAME, XWIKI_ADMIN_GROUP] | path_join }}"

# Collect enabled plugin items from config/main.yml
XWIKI_PLUGINS: >-
  {{
    (lookup('config',application_id, 'plugins'))
    | dict2items | selectattr('value.enabled','equalto', true)
    | map(attribute='value.items') | list | sum(start=[])
  }}
