- name: Check health status of '{{ item }}' container
  shell: |
    cid=$({{ BIN_COMPOSE }} ps -q {{ item }})
    container inspect \
      --format '{{ "{{.State.Health.Status}}" }}' \
      $cid
  args:
    chdir: "{{ lookup('container', application_id, 'directories.instance') }}"
  register: healthcheck
  retries: 60
  delay: 5
  until: healthcheck.stdout == "healthy"
  loop:
    - "{{ MASTODON_SERVICE_NAME }}"
    - "{{ MASTODON_STREAMING_SERVICE_NAME }}"
    - "{{ MASTODON_SIDEKIQ_SERVICE_NAME }}"
  loop_control:
    label: "{{ item }}"
  changed_when: false
