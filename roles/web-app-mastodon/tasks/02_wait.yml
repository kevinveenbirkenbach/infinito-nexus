- name: Check health status of '{{ item }}' container
  shell: |
    cid=$(docker compose ps -q {{ item }})
    docker inspect \
      --format '{{ "{{.State.Health.Status}}" }}' \
      $cid
  args:
    chdir: "{{ lookup('docker', application_id, want='directories.instance') }}"
  register: healthcheck
  retries: 60
  delay: 5
  until: healthcheck.stdout == "healthy"
  loop:
    - "{{ MASTODON_SERVICE_NAME }}"
    - "{{ MASTODON_STREAMING_SERVICE_NAME }}"
    - "{{ MASTODON_SIDEKIQ_SERVICE_NAME }}"
  loop_control:
    label: "{{ item }}"
  changed_when: false
