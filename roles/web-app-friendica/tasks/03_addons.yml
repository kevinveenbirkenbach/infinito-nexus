- name: flush handlers to ensure that friendica is up before friendica addon configuration
  meta: flush_handlers

- name: Build friendica_addons based on features
  set_fact:
    friendica_addons: >-
      {{
        friendica_addons | default([])
        + [{
            'name': item.key,
            'enabled': (
              FRIENDICA_OIDC_ENABLED
                if item.key == 'keycloakpassword'
              else FRIENDICA_LDAP_ENABLED
                if item.key == 'ldapauth'
              else (item.value.enabled if item.value is mapping and 'enabled' in item.value else False)
            )
          }]
      }}
  loop: "{{ FRIENDICA_ADDONS | dict2items }}"
  loop_control:
    label: "{{ item.key }}"

- name: Ensure Friendica addons are in sync
  command: >
    {{ PATH_COMPOSE }} exec --user {{ FRIENDICA_USER }}
    {{ FRIENDICA_SERVICE }}
    bin/console addon
    {{ 'enable' if item.enabled else 'disable' }}
    {{ item.name }}
  args:
    chdir: "{{ lookup('docker', application_id, 'directories.instance') }}"
  loop: "{{ friendica_addons }}"
  loop_control:
    label: "{{ item.name }}"
