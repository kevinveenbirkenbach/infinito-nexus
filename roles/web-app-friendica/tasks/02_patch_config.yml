- name: Patch Friendica local.config.php (DB + system.url) in one pass
  command: >
    {{ BIN_CONTAINER }} exec --user {{ FRIENDICA_USER }} {{ FRIENDICA_CONTAINER }}
    sed -ri
    -e "s/('hostname'\s*=>\s*')[^']*(',)/\1{{ lookup('database', application_id, 'host') | sed_escape('/') }}:{{ lookup('database', application_id, 'port') | sed_escape('/') }}\2/"
    -e "s/('database'\s*=>\s*')[^']*(',)/\1{{ lookup('database', application_id, 'name') | sed_escape('/') }}\2/"
    -e "s/('username'\s*=>\s*')[^']*(',)/\1{{ lookup('database', application_id, 'username') | sed_escape('/') }}\2/"
    -e "s/('password'\s*=>\s*')[^']*(',)/\1{{ lookup('database', application_id, 'password') | sed_escape('/') }}\2/"
    -e "s#('url'\s*=>\s*')[^']*(',)#\1{{ lookup('tls', application_id, 'url.base') | sed_escape('#') }}\2#"
    {{ FRIENDICA_CONFIG_FILE }}
  notify: docker compose up
