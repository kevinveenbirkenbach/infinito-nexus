- name: Cleanup all NGINX cache directories
  become: true
  ansible.builtin.file:
    path: "{{ item.value }}"
    state: absent
  when:
    - MODE_CLEANUP | bool
  loop: "{{ nginx.directories.cache | dict2items }}"
  loop_control:
    label: "{{ item.key }}"

- name: Ensure all NGINX cache directories exist
  become: true
  ansible.builtin.file:
    path: "{{ item.value }}"
    state: directory
    owner: "{{ nginx.user }}"
    group: "{{ nginx.user }}"
    mode: '0700'
  loop: "{{ nginx.directories.cache | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  async: "{{ ASYNC_TIME if ASYNC_ENABLED | bool else omit }}"
  poll:  "{{ ASYNC_POLL if ASYNC_ENABLED | bool else omit }}"

- name: run the nginx_reverse_proxy tasks once
  set_fact:
    run_once_nginx_reverse_proxy: true