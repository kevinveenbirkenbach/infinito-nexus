---
# Install Nix differently depending on the target platform:
# - Arch-based systems: install via package manager
# - Non-Arch systems: use the official installer with SHA256 verification

# 1) Arch-based systems: just install the distro package
- name: Install Nix via package manager on Arch-based systems
  package:
    name: nix
    state: present
  become: true
  when:
    - ansible_facts.os_family == "Archlinux"
    - ansible_facts.distribution == "Archlinux"
    - ansible_facts.architecture == "x86_64"

# 2) Non-Arch systems: delegate installer logic to a separate task file
- name: Include non-Arch installer logic
  ansible.builtin.include_tasks: 02_non_arch_installer.yml
  when: not (
      ansible_facts.os_family == "Archlinux"
      and ansible_facts.distribution == "Archlinux"
      and ansible_facts.architecture == "x86_64"
    )

# 3) Configure Nix experimental features (common for all platforms)
- name: Ensure Nix config directory exists
  ansible.builtin.file:
    path: /etc/nix
    state: directory
    mode: "0755"
  become: true

- name: Deploy Nix configuration (nix.conf)
  ansible.builtin.template:
    src: "nix.conf.j2"
    dest: "/etc/nix/nix.conf"
    mode: "0644"
  become: true

# 4) Mark this role as "run once" in your global once-flag system
- include_tasks: utils/once/flag.yml
