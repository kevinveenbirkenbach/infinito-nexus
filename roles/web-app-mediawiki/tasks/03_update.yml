- name: "MEDIAWIKI | Wait for DB and run update"
  shell: |
    set -euo pipefail
    docker exec -u {{ MEDIAWIKI_USER }} {{ MEDIAWIKI_CONTAINER }} bash -lc '
      set -euo pipefail

      for i in $(seq 1 30); do
        if php {{ MEDIAWIKI_HTML_DIR }}/maintenance/run.php sql --query "SELECT 1" >/dev/null 2>&1; then
          break
        fi
        sleep 2
      done

      php {{ MEDIAWIKI_HTML_DIR }}/maintenance/run.php sql --query "SELECT 1" >/dev/null

      php {{ MEDIAWIKI_HTML_DIR }}/maintenance/run.php update --quick
    '
  args:
    executable: /bin/bash
  changed_when: false
