---
- name: "load docker, db and proxy for '{{ application_id }}'"
  include_role:
    name: sys-stk-full-stateful
  vars:
    docker_compose_flush_handlers: false

- name: "Prepare host files for '{{ application_id }}'"
  include_tasks: 01_prep.yml

- name: "flush handlers for '{{ application_id }}' after preparation finished"
  meta: flush_handlers

- name: "Load install procedures for '{{ application_id }}''"
  include_tasks: 02_install.yml


- name: "DEBUG | Ensure require_once(debug.php) matches MODE_DEBUG"
  include_tasks: _ensure_require.yml
  vars:
    ensure_present: "{{ MODE_DEBUG | bool }}"
    require_path: "{{ MEDIAWIKI_LOCAL_PATH }}/debug.php"
  when: MODE_DEBUG | bool

- name: "MEDIAWIKI | Sync LocalSettings.php with Ansible vars"
  include_tasks: 03_patch_settings.yml

- name: "Load admin setup procedures for '{{ application_id }}''"
  include_tasks: 04_admin.yml

- name: "Load extensions procedures for '{{ application_id }}''"
  include_tasks: "05_extensions.yml"
  when: MEDIAWIKI_OIDC_ENABLED | bool

- name: "OIDC | Ensure require_once(oidc.php) present"
  include_tasks: _ensure_require.yml
  vars:
    ensure_present: true
    require_path: "{{ MEDIAWIKI_LOCAL_PATH }}/oidc.php"
  when: MEDIAWIKI_OIDC_ENABLED | bool
