---
- name: Install setup-hibernate via pip (system-wide)
  include_role:
    name: sys-pip-install
  vars:
    package_name: setup-hibernate
    global_install: true

- name: Setup hibernate
  ansible.builtin.command:
    argv:
      - "{{ lookup('command_path', 'setup-hibernate') }}"
      - --non-interactive
  become: true

- name: Configure systemd lid switch behavior to hibernate on lid close (battery), lock on AC and docked
  become: true
  lineinfile:
    path: /etc/systemd/logind.conf
    regexp: '^#?HandleLidSwitch='
    line: 'HandleLidSwitch=hibernate'
    backup: yes
  notify: Restart systemd-logind

- name: Configure systemd to lock session when lid is closed on external power
  lineinfile:
    path: /etc/systemd/logind.conf
    regexp: '^#?HandleLidSwitchExternalPower='
    line: 'HandleLidSwitchExternalPower=lock'
    backup: yes
  notify: Restart systemd-logind
  become: true

- name: Configure systemd to lock session when lid is closed while docked
  lineinfile:
    path: /etc/systemd/logind.conf
    regexp: '^#?HandleLidSwitchDocked='
    line: 'HandleLidSwitchDocked=lock'
    backup: yes
  notify: Restart systemd-logind
  become: true

- include_tasks: utils/once/flag.yml
