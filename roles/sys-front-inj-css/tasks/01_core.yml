- name: Generate color palette with colorscheme-generator
  set_fact:
    CSS_COLOR_PALETTE: "{{ lookup('colorscheme', CSS_BASE_COLOR, count=CSS_COUNT, shades=CSS_SHADES) }}"

- name: Generate inverted color palette with colorscheme-generator
  set_fact:
    CSS_COLOR_PALETTE_INVERTED: "{{ lookup('colorscheme', CSS_BASE_COLOR, count=CSS_COUNT, shades=CSS_SHADES, invert_lightness=True) }}"

- name: "Compute deterministic gradient angle from default.css template mtime"
  set_fact:
    CSS_GRADIENT_ANGLE: >-
      {{
        (
          lookup(
            'local_mtime_qs',
            [playbook_dir, 'roles', 'sys-front-inj-css', 'templates', 'css', 'default.css.j2'] | path_join
          )
          | regex_replace('^.*=', '')
          | int
        ) % 360
      }}

- name: Deploy default CSS files
  template:
    src:    "{{ ['css', css_file ~ '.j2'] | path_join }}"
    dest:   "{{ [cdn_paths_all.shared.css, css_file] | path_join }}"
    owner:  "{{ lookup('nginx_paths', want='user') }}"
    group:  "{{ lookup('nginx_paths', want='user') }}"
    mode:   '0644'
  loop: "{{ CSS_FILES }}"
  loop_control:
    loop_var: css_file

- include_tasks: utils/once/flag.yml