- name: "Add LDAP Authentication Source"
  shell: |
    docker exec -i --user {{ GITEA_USER }} {{ GITEA_CONTAINER }} \
      gitea admin auth add-ldap \
      {{ GITEA_LDAP_AUTH_ARGS | join(' ') }}
  args:
    chdir: "{{ lookup('docker', application_id, want='directories.instance') }}"
  register: ldap_manage
  failed_when: ldap_manage.rc != 0 and "login source already exists" not in ldap_manage.stderr

- name: "Lookup existing LDAP auth source ID"
  shell: |
    docker exec -i --user {{ GITEA_USER }} {{ GITEA_CONTAINER }} \
      gitea admin auth list \
      | tail -n +2 \
      | grep -F "LDAP ({{ DOMAIN_PRIMARY }})" \
      | awk '{print $1; exit}'
  args:
    chdir: "{{ lookup('docker', application_id, want='directories.instance') }}"
  register: ldap_source_id_raw
  failed_when:
    - ldap_source_id_raw.rc != 0
    - ldap_source_id_raw.stdout == ""
  changed_when: false

- name: "Set LDAP source ID fact"
  set_fact:
    ldap_source_id: "{{ ldap_source_id_raw.stdout }}"

- name: "Update LDAP Authentication Source"
  shell: |
    docker exec -i --user {{ GITEA_USER }} {{ GITEA_CONTAINER }} \
      gitea admin auth update-ldap \
      --id {{ ldap_source_id }} \
      {{ GITEA_LDAP_AUTH_ARGS | join(' ') }}
  args:
    chdir: "{{ lookup('docker', application_id, want='directories.instance') }}"
  register: ldap_manage
  failed_when: ldap_manage.rc != 0
