---
- name: Flush handlers to ensure Gitea is up before DB patch
  meta: flush_handlers

- name: Patch Gitea DB host in app.ini
  command: >
    docker exec -i --user {{ GITEA_USER }} {{ GITEA_CONTAINER }}
    sed -ri "s|^(HOST\s*=\s*).*$|\1{{ lookup('database', application_id, want='host') | sed_escape('|') }}:{{ lookup('database', application_id, want='port') | sed_escape('|') }}|" {{ GITEA_CONFIG }}
  notify: docker compose up

- name: Patch Gitea DB name in app.ini
  command: >
    docker exec -i --user {{ GITEA_USER }} {{ GITEA_CONTAINER }}
    sed -ri "s|^(NAME\s*=\s*).*$|\1{{ lookup('database', application_id, want='name') | sed_escape('|') }}|" {{ GITEA_CONFIG }}
  notify: docker compose up

- name: Patch Gitea DB user in app.ini
  command: >
    docker exec -i --user {{ GITEA_USER }} {{ GITEA_CONTAINER }}
    sed -ri "s|^(USER\s*=\s*).*$|\1{{ lookup('database', application_id, want='username') | sed_escape('|') }}|" {{ GITEA_CONFIG }}
  notify: docker compose up

- name: Patch Gitea DB password in app.ini
  command: >
    docker exec -i --user {{ GITEA_USER }} {{ GITEA_CONTAINER }}
    sed -ri "s|^(PASSWD\s*=\s*).*$|\1{{ lookup('database', application_id, want='password') | sed_escape('|') }}|" {{ GITEA_CONFIG }}
  notify: docker compose up

- name: "Flush database patches"
  meta: flush_handlers