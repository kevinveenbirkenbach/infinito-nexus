# Replace INFX_LDAP_PLUGIN with the actual plugin name you use
- name: "Install LDAP admin plugin & activate"
  shell: |
    {{ BIN_CONTAINER }} exec -i --user {{ SHOPWARE_USER }} {{ SHOPWARE_WEB_CONTAINER }} sh -lc '
      set -e
      cd {{ SHOPWARE_ROOT }}
      php bin/console plugin:refresh
      php bin/console plugin:install --activate INFX_LDAP_PLUGIN || true
      php bin/console cache:clear
    '
  args:
    chdir: "{{ lookup('docker', application_id, 'directories.instance') }}"

- name: "Configure LDAP connection"
  shell: |
    {{ BIN_CONTAINER }} exec -i --user {{ SHOPWARE_USER }} {{ SHOPWARE_WEB_CONTAINER }} sh -lc '
      set -e
      cd {{ SHOPWARE_ROOT }}
      php bin/console system:config:set "InfxLdap.config.host"     "{{ LDAP.SERVER.DOMAIN }}"
      php bin/console system:config:set "InfxLdap.config.port"     "{{ LDAP.SERVER.PORT }}"
      php bin/console system:config:set "InfxLdap.config.bindDn"   "{{ LDAP.DN.ADMINISTRATOR.DATA }}"
      php bin/console system:config:set "InfxLdap.config.password" "{{ LDAP.BIND_CREDENTIAL }}"
      php bin/console system:config:set "InfxLdap.config.userBase" "{{ LDAP.DN.OU.USERS }}"
      php bin/console cache:clear
    '
  args:
    chdir: "{{ lookup('docker', application_id, 'directories.instance') }}"
