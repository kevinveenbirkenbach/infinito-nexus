- name: "Rename default Shopware admin user to {{ users.administrator.username }}"
  shell: |
    {{ BIN_CONTAINER }} exec -i --user {{ SHOPWARE_USER }} {{ SHOPWARE_WEB_CONTAINER }} sh -lc '
      set -e
      cd {{ SHOPWARE_ROOT }}
      old_user="admin"
      new_user="{{ users.administrator.username }}"
      if php bin/console user:list | grep -q "^$old_user "; then
        echo "[INFO] Renaming Shopware user: $old_user -> $new_user"
        php bin/console user:update "$old_user" --username="$new_user" || true
      else
        echo "[INFO] No user named $old_user found (already renamed or custom setup)"
      fi
    '
  args:
    chdir: "{{ lookup('docker', application_id, 'directories.instance') }}"
  changed_when: false
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

- name: "Ensure Shopware admin exists and has the desired password"
  shell: |
    {{ BIN_CONTAINER }} exec -i --user {{ SHOPWARE_USER }} {{ SHOPWARE_WEB_CONTAINER }} sh -lc '
      set -e
      cd {{ SHOPWARE_ROOT }}
      php bin/console user:create "{{ users.administrator.username }}" \
        --admin \
        --password={{ users.administrator.password | quote }} \
        --firstName="{{ users.administrator.username }}" \
        --lastName="{{ DOMAIN_PRIMARY | lower }}" \
        --email="{{ users.administrator.email }}" || true
      php bin/console user:change-password "{{ users.administrator.username }}" \
        --password={{ users.administrator.password | quote }} || true
      php bin/console user:update "{{ users.administrator.username }}" \
        --email="{{ users.administrator.email }}" 2>/dev/null || true
    '
  args:
    chdir: "{{ lookup('docker', application_id, 'directories.instance') }}"
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"
