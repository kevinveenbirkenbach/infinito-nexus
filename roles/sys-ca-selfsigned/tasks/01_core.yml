---
# Root CA (self-signed) provisioning.
# Creates a CA:TRUE certificate which can be used as a trust anchor in containers/hosts.

- name: "CA | ensure base directory exists"
  become: true
  ansible.builtin.file:
    path: "{{ CA_ROOT.base_dir }}"
    state: directory
    mode: "0750"
    owner: root
    group: root

- name: "CA | check openssl availability"
  ansible.builtin.command: "openssl version"
  register: _openssl_version
  changed_when: false

- name: "CA | check if key exists"
  become: true
  ansible.builtin.stat:
    path: "{{ CA_ROOT.key_host }}"
  register: _ca_key_stat
  changed_when: false

- name: "CA | check if cert exists"
  become: true
  ansible.builtin.stat:
    path: "{{ CA_ROOT.cert_host }}"
  register: _ca_cert_stat
  changed_when: false

- name: "CA | decide whether regeneration is needed"
  ansible.builtin.set_fact:
    _ca_regen_needed: >-
      {{
        (CA_ROOT.force_regen | bool) or
        (not (_ca_key_stat.stat.exists | default(false))) or
        (not (_ca_cert_stat.stat.exists | default(false)))
      }}
  changed_when: false

- name: "CA | remove outdated key/cert if regeneration requested/needed"
  become: true
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ CA_ROOT.key_host }}"
    - "{{ CA_ROOT.cert_host }}"
  when: _ca_regen_needed | bool

- name: "CA | render openssl config (v3_ca)"
  become: true
  ansible.builtin.copy:
    dest: "{{ CA_ROOT.openssl_conf_host }}"
    owner: root
    group: root
    mode: "0640"
    content: |
      [ req ]
      default_bits       = {{ CA_ROOT.key_bits }}
      default_md         = sha256
      prompt             = no
      distinguished_name = dn
      x509_extensions    = v3_ca

      [ dn ]
      C  = {{ CA_ROOT.subject.C }}
      O  = {{ CA_ROOT.subject.O }}
      OU = {{ CA_ROOT.subject.OU }}
      CN = {{ CA_ROOT.subject.CN }}

      [ v3_ca ]
      # Root CA constraints
      basicConstraints       = critical,CA:TRUE,pathlen:1
      keyUsage               = critical,keyCertSign,cRLSign
      subjectKeyIdentifier   = hash
      authorityKeyIdentifier = keyid:always,issuer

- name: "CA | generate root CA key + cert (self-signed)"
  become: true
  ansible.builtin.command:
    argv:
      - openssl
      - req
      - -x509
      - -new
      - -nodes
      - -days
      - "{{ CA_ROOT.days | string }}"
      - -newkey
      - "rsa:{{ CA_ROOT.key_bits }}"
      - -keyout
      - "{{ CA_ROOT.key_host }}"
      - -out
      - "{{ CA_ROOT.cert_host }}"
      - -config
      - "{{ CA_ROOT.openssl_conf_host }}"
      - -extensions
      - v3_ca
  args:
    creates: "{{ CA_ROOT.cert_host }}"
  when: _ca_regen_needed | bool

- name: "CA | enforce permissions (private key)"
  become: true
  ansible.builtin.file:
    path: "{{ CA_ROOT.key_host }}"
    owner: root
    group: root
    mode: "0600"

- name: "CA | enforce permissions (certificate)"
  become: true
  ansible.builtin.file:
    path: "{{ CA_ROOT.cert_host }}"
    owner: root
    group: root
    mode: "0644"

- name: "CA | sanity check: verify certificate is CA:TRUE"
  become: true
  ansible.builtin.command: "openssl x509 -in {{ CA_ROOT.cert_host }} -noout -text"
  register: _ca_cert_text
  changed_when: false

- name: "CA | assert certificate contains CA:TRUE"
  ansible.builtin.assert:
    that:
      - (_ca_cert_text.stdout | default('')) is search('CA:TRUE')
    fail_msg: >-
      Generated certificate does not appear to be a CA certificate (CA:TRUE missing).
      Please inspect {{ CA_ROOT.cert_host }}.

- name: "CA | install trust helper script (SPOT) on host"
  become: true
  ansible.builtin.copy:
    src: "with-ca-trust.sh"
    dest: "{{ PATH_CA_TRUST }}"
    owner: root
    group: root
    mode: "0755"

- name: "CA | Install Root CA into host trust store"
  become: true
  ansible.builtin.command:
    argv:
      - "{{ PATH_CA_TRUST }}"
  environment:
    CA_TRUST_CERT: "{{ CA_ROOT.cert_host }}"
    CA_TRUST_NAME: "{{ DOMAIN_PRIMARY | lower }}"
  changed_when: true

- include_tasks: utils/once/flag.yml
