# run_once_sys_svc_rdbms: deactivated
- name: "For '{{ application_id }}': Set database_consumer_id (Needed due to lazzy loading issue)"
  set_fact:
    database_consumer_id_passed: "{{ application_id }}"

- block:
  - name: "Ensure env dir exists: {{ lookup('docker', application_id, want='directories.env') }}"
    ansible.builtin.file:
      path: "{{ lookup('docker', application_id, want='directories.env') }}"
      state: directory
      mode: "0755"
  - name: "For '{{ application_id }}/{{ database_consumer_id_passed }}': Create {{ lookup('database', application_id, want='env') }}"
    template:
      src: "env/{{ lookup('database', application_id, want='type') }}.env.j2"
      dest: "{{ lookup('database', application_id, want='env') }}"
    notify: docker compose up
  when: not (SYS_SVC_RDBMS_CENTRAL_DB_ENABLED | bool)

- name: Central Database Logic
  block:
    - name: "For '{{ application_id }}': Create central database"
      include_tasks: "utils/load_app.yml"
      vars:
        load_app_id:                "{{ lookup('database', application_id, want='id') }}"
        database_init:              true  # Initialize a custom database for the application
        docker_git_repository_pull: false # Deactivated here to don't inhire the variable

    - name: "For '{{ application_id }}': Add Entry for Backup Procedure"
      include_tasks: "{{ playbook_dir }}/roles/sys-ctl-bkp-docker-2-loc/tasks/04_seed-database-to-backup.yml"
  vars:
    database_consumer_id: "{{ database_consumer_id_passed }}"
    database_type:        "{{ lookup('database', database_consumer_id_passed | default(application_id), want='type') }}"
    database_instance:    "{{ lookup('database', database_consumer_id_passed | default(application_id), want='instance') }}"
    database_host:        "{{ lookup('database', database_consumer_id_passed | default(application_id), want='host') }}"
    database_port:        "{{ lookup('database', database_consumer_id_passed | default(application_id), want='port') }}"
    database_name:        "{{ lookup('database', database_consumer_id_passed | default(application_id), want='name') }}"
    database_username:    "{{ lookup('database', database_consumer_id_passed | default(application_id), want='username') }}"
    database_password:    "{{ lookup('database', database_consumer_id_passed | default(application_id), want='password') }}"
  when: SYS_SVC_RDBMS_CENTRAL_DB_ENABLED | bool
