{# This template needs to be included in docker-compose.yml, which depend on a mariadb database #}
{% if not lookup('database', application_id, 'shared') %}

  {{ lookup('database', application_id, 'host') }}:
    container_name: {{ application_id | get_entity_name }}-database
    logging:
      driver: journald
    image: {{ lookup('database', application_id, 'image') }}:{{ lookup('database', application_id, 'version') }}
    restart: {{ DOCKER_RESTART_POLICY }}
    env_file:
      - {{ lookup('database', application_id, 'env') }}
    command: "--transaction-isolation=READ-COMMITTED --binlog-format=ROW"
    volumes:
      - database:/var/lib/mysql
    healthcheck:
      test: [ "CMD", "sh", "-c", "/usr/bin/mariadb --user=$$MYSQL_USER --password=$$MYSQL_PASSWORD --execute 'SHOW DATABASES;'" ]
      interval: 10s
      timeout: 5s
      retries: 18
    networks:
      - default
{% endif %}
{{ "\n" }}