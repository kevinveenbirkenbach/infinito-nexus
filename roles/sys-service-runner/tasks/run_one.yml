- name: "sys-service-runner | Apply state for {{ system_service_run_unit }}"
  block:
    - name: "Apply state (retry up to {{ SYS_SERVICE_RUNNER_RETRIES }} times, {{ SYS_SERVICE_RUNNER_DELAY }}s delay)"
      ansible.builtin.systemd:
        name: "{{ system_service_run_unit }}"
        state: "{{ sys_service_runner_state }}"
      become: true
      register: result
      # Retries are required because a compose-managed service might not be ready yet
      # (e.g., container dependencies / health checks still settling).
      retries: "{{ SYS_SERVICE_RUNNER_RETRIES }}"
      delay: "{{ SYS_SERVICE_RUNNER_DELAY }}"
      until: result is not failed

  rescue:
    - name: "systemctl status (diagnostics)"
      ansible.builtin.command:
        cmd: "systemctl --no-pager --full status {{ system_service_run_unit }}"
      become: true
      register: sys_runner_status
      changed_when: false
      failed_when: false

    - name: "journalctl -xeu (diagnostics)"
      ansible.builtin.command:
        cmd: "journalctl --no-pager --no-hostname --full -xeu {{ system_service_run_unit }}"
      become: true
      register: sys_runner_journal
      changed_when: false
      failed_when: false

    - name: "Fail with diagnostics"
      ansible.builtin.fail:
        msg: |
          Final-run service failed: {{ system_service_run_unit }}

          === systemctl status ===
          {{ sys_runner_status.stdout | default('') }}
          {{ sys_runner_status.stderr | default('') }}

          === journalctl -xeu ===
          {{ sys_runner_journal.stdout | default('') }}
          {{ sys_runner_journal.stderr | default('') }}
