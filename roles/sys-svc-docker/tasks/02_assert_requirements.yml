- name: Gather service facts
  ansible.builtin.service_facts:

- name: Assert systemd is available
  ansible.builtin.assert:
    that:
      - ansible_service_mgr == "systemd"
    fail_msg: >
      systemd is not available. This role requires systemd (service manager = {{ ansible_service_mgr }}).

- name: Assert systemd is PID 1
  ansible.builtin.command: "ps -p 1 -o comm="
  register: pid1
  changed_when: false

- name: Fail if PID1 is not systemd
  ansible.builtin.assert:
    that:
      - pid1.stdout.strip() == "systemd"
    fail_msg: "PID 1 is not systemd (PID1={{ pid1.stdout.strip() }}). Docker service management will hang."

- name: Check docker socket
  ansible.builtin.stat:
    path: /var/run/docker.sock
  register: docker_sock

- name: Assert docker service exists
  ansible.builtin.assert:
    that:
      - "'docker.service' in ansible_facts.services"
    fail_msg: >
      docker.service is not registered in systemd.
      Docker engine does not appear to be installed.
