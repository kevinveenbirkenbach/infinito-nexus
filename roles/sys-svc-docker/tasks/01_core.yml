- include_tasks: utils/once/flag.yml

- name: "Install docker engine (host only)"
  ansible.builtin.package:
    name: >-
      {{
        ['docker'] if ansible_os_family == 'Archlinux' else
        ['docker.io'] if ansible_os_family == 'Debian' else
        ['docker'] if ansible_distribution in ['Fedora', 'CentOS', 'CentOS Stream'] else
        omit
      }}
    state: present
  notify: docker restart

- name: "Install docker compose"
  ansible.builtin.package:
    name: >-
      {{
        ['docker-compose'] if ansible_os_family == 'Archlinux' else
        ['docker-compose-plugin'] if ansible_os_family == 'Debian' else
        ['docker-compose-plugin'] if ansible_distribution in ['Fedora', 'CentOS', 'CentOS Stream'] else
        omit
      }}
    state: present
  notify: docker restart

- name: "Assert that required services are available"
  include_tasks: "02_assert_requirements.yml"
  when: MODE_ASSERT | bool

- name: "Load fuse-overlayfs (in container)"
  include_tasks: "03_fuse_overlayfs.yml"
  when: DOCKER_IN_CONTAINER | bool

- name: Restart and enable docker service
  meta: flush_handlers

- name: "Overwrite when DOCKER_IN_CONTAINER is true"
  block: 

    - name: Get docker bridge gateway
      docker_bridge_gateway:
      register: gw
      changed_when: false

    - name: "Set docker bridge gateway fact to '{{ gw.gateway }}'"
      set_fact:
        DOCKER_REACH_HOST: "{{ gw.gateway }}"
      changed_when: false
  when: DOCKER_IN_CONTAINER | bool

- name: Setup Swapfile to prevent OOM Failures
  # @ See https://en.wikipedia.org/wiki/Out_of_memory
  include_tasks: "utils/load_app.yml"
  vars:
    load_app_id: "svc-opt-swapfile"
  when: run_once_svc_opt_swapfile is not defined

- name: "Load reset tasks when MODE_RESET is enabled"
  include_tasks: "04_reset.yml"
  when: MODE_RESET | bool

- name: Include backup, repair and health services for docker
  include_role:
    name: "{{ item }}"
  loop:
    - sys-ctl-cln-docker
    - sys-ctl-bkp-docker-2-loc
    - sys-ctl-hlth-docker-container
    - sys-ctl-hlth-docker-volumes
    - sys-ctl-rpr-docker-hard
  when: SYS_SVC_DOCKER_LOAD_SERVICES | bool
