- name: Resolve Docker package list for current distribution
  ansible.builtin.set_fact:
    sys_svc_container_packages: >-
      {{
        SYS_SVC_CONTAINER_PACKAGES_BY_DISTRIBUTION[ansible_distribution]
        if ansible_distribution in SYS_SVC_CONTAINER_PACKAGES_BY_DISTRIBUTION
        else []
      }}

- name: Fail for unsupported distribution in Docker role
  ansible.builtin.assert:
    that:
      - (sys_svc_container_packages | length) > 0
    fail_msg: >-
      Unsupported distribution for Docker role: {{ ansible_distribution }}
      ({{ ansible_os_family }}).

- name: Setup Docker repository on Debian and Ubuntu
  include_tasks: 01a_debian_ubuntu.yml
  when: ansible_distribution in ['Debian', 'Ubuntu']

- name: Setup Docker repository and SDK prerequisites on RedHat family
  include_tasks: 01b_redhat.yml
  when: ansible_os_family == 'RedHat'

- name: Install Docker packages
  ansible.builtin.package:
    name: "{{ sys_svc_container_packages }}"
    state: present
  notify: container manager restart

- name: Install container wrapper (container)
  become: true
  ansible.builtin.copy:
    src: container.py
    dest: "{{ BIN_CONTAINER }}"
    mode: "0755"
    owner: root
    group: root

- name: "Assert that required services are available"
  include_tasks: "02_assert_requirements.yml"
  when: MODE_ASSERT | bool

- name: "Load docker in docker procedures"
  include_tasks: "03_docker_in_docker.yml"
  when: DOCKER_IN_CONTAINER | bool

- name: Restart and enable docker service
  meta: flush_handlers

- name: "Overwrite when DOCKER_IN_CONTAINER is true"
  block: 

    - name: Get docker bridge gateway
      docker_bridge_gateway:
      register: gw
      changed_when: false

    - name: "Set docker bridge gateway fact to '{{ gw.gateway }}'"
      set_fact:
        DOCKER_REACH_HOST: "{{ gw.gateway }}"
      changed_when: false
  when: DOCKER_IN_CONTAINER | bool

- name: Setup Swapfile to prevent OOM Failures
  # @ See https://en.wikipedia.org/wiki/Out_of_memory
  include_tasks: "utils/load_app.yml"
  vars:
    load_app_id: "svc-opt-swapfile"
  when: run_once_svc_opt_swapfile is not defined

- name: "Load reset tasks when MODE_RESET is enabled"
  include_tasks: "04_reset.yml"
  when: MODE_RESET | bool

- include_tasks: utils/once/flag.yml
