- name: Validate users.<user_key>.authorized_keys exists and is a list
  ansible.builtin.fail:
    msg: >-
      Missing or invalid SSH key configuration for user key '{{ user_key }}'.
      Define users.{{ user_key }}.authorized_keys as a LIST of SSH public keys
      (may be empty unless restricted by the calling role).
  when: >
    users is not defined
    or users[user_key] is not defined
    or users[user_key].authorized_keys is not defined
    or users[user_key].authorized_keys is string
    or users[user_key].authorized_keys is not iterable

- name: Ensure SSH directory exists for '{{ user_username }}'
  ansible.builtin.file:
    path: "{{ user_home }}/.ssh"
    state: directory
    owner: "{{ user_username }}"
    group: "{{ user_group }}"
    mode: "0700"

- name: Write authorized_keys for '{{ user_username }}'
  ansible.builtin.copy:
    dest: "{{ user_home }}/.ssh/authorized_keys"
    content: |
      {{
        users[user_key].authorized_keys
        | default([])
        | map('regex_replace', '\\\\n$', '')
        | map('regex_replace', '\\s+$', '')
        | join('\n')
      }}
    owner: "{{ user_username }}"
    group: "{{ user_group }}"
    mode: "0600"
