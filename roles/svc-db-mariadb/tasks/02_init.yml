- block:
    - name: "Create database: {{ database_name }} (host via mysql_db)"
      community.mysql.mysql_db:
        name:           "{{ database_name }}"
        state:          present
        login_user:     root
        login_password: "{{ MARIADB_ROOT_PWD }}"
        login_host:     "{{ MARIADB_HOST }}"
        login_port:     "{{ MARIADB_PORT }}"
        encoding:       "{{ MARIADB_ENCODING }}"
        collation:      "{{ MARIADB_COLLATION }}"
        config_file:    ""

    - name: "Create database user: {{ database_username }} (host via mysql_user)"
      community.mysql.mysql_user:
        name:           "{{ database_username }}"
        password:       "{{ database_password }}"
        host:           "%"
        priv:           "`{{ database_name }}`.*:ALL"
        state:          present
        login_user:     root
        login_password: "{{ MARIADB_ROOT_PWD }}"
        login_host:     "{{ MARIADB_HOST }}"
        login_port:     "{{ MARIADB_PORT }}"
        config_file:    ""
  when: MARIADB_EXPOSE_LOCAL | bool

# ---------------------------------------------------------------------------
# CI / Container path: no port publishing â†’ initialize via docker exec
# ---------------------------------------------------------------------------
- block:
    - name: "Create database: {{ database_name }} (container via mariadb CLI)"
      community.docker.docker_container_exec:
        container: "{{ MARIADB_NAME }}"
        command: >-
          mariadb -uroot -p'{{ MARIADB_ROOT_PWD }}'
          -e "CREATE DATABASE IF NOT EXISTS `{{ database_name }}`
              CHARACTER SET {{ MARIADB_ENCODING }}
              COLLATE {{ MARIADB_COLLATION }};"
      register: mariadb_create_db
      changed_when: false

    - name: "Create database user + grant privileges (container via mariadb CLI)"
      community.docker.docker_container_exec:
        container: "{{ MARIADB_NAME }}"
        command: >-
          mariadb -uroot -p'{{ MARIADB_ROOT_PWD }}'
          -e "CREATE USER IF NOT EXISTS '{{ database_username }}'@'%';
              ALTER USER '{{ database_username }}'@'%' IDENTIFIED BY '{{ database_password }}';
              GRANT ALL PRIVILEGES ON `{{ database_name }}`.* TO '{{ database_username }}'@'%';
              FLUSH PRIVILEGES;"
      register: mariadb_create_user
      changed_when: false
  when: not (MARIADB_EXPOSE_LOCAL | bool)
