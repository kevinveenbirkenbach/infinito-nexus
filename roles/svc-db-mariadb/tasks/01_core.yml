- name: "Setup container network for {{ application_id }}"
  include_tasks: "{{ [playbook_dir, 'roles/sys-svc-compose/tasks/utils/network.yml' ] | path_join }}"
  vars:
    docker_network_name:            "{{ MARIADB_NETWORK }}"
    docker_network_subnet:          "{{ MARIADB_SUBNET }}"
    docker_compose_flush_handlers:  true

- name: Install MySQL Python client library (distro-aware)
  package:
    name: >-
      {{
        'python-mysqlclient'   if ansible_os_family == 'Archlinux' else
        'python3-mysqldb'      if ansible_os_family == 'Debian'     else
        'python3-mysqlclient'  if ansible_os_family == 'RedHat'     else
        'py3-mysqlclient'      if ansible_os_family == 'Alpine'     else
        omit
      }}
    state: present
  when: MARIADB_EXPOSE_LOCAL | bool

- block: 

    - name: "Root password reset | Check login with desired password (inside container)"
      community.docker.docker_container_exec:
        container: "{{ MARIADB_NAME }}"
        command: >-
          mariadb {{ '-h127.0.0.1 -P3306' if MARIADB_EXPOSE_LOCAL else '' }}
          -uroot -p'{{ MARIADB_ROOT_PWD }}'
          -e 'SELECT 1;'
      register: mariadb_login_desired
      changed_when: false
      failed_when: false

    - name: "Ensure MariaDB root password matches desired value"
      include_tasks: 03_reset_root_password.yml
      when: mariadb_login_desired.rc != 0

  when: MARIADB_ALLOW_RESET_WITHOUT_PREVIOUS | bool

- name: "Wait until the MariaDB container with hostname '{{ MARIADB_NAME }}' is healthy"
  community.docker.docker_container_info:
    name: "{{ MARIADB_NAME }}"
  register: db_info
  until:
    - db_info.container is defined
    - db_info.container.State.Health.Status == "healthy"
  retries: 30
  delay: 5

- name: "Wait until MariaDB accepts root credentials (inside container)"
  community.docker.docker_container_exec:
    container: "{{ MARIADB_NAME }}"
    command: >
      mariadb
      {{ '-h127.0.0.1 -P3306' if MARIADB_EXPOSE_LOCAL else '' }}
      -uroot -p'{{ MARIADB_ROOT_PWD }}'
      -e 'SELECT 1;'
  register: mariadb_cli
  changed_when: false
  retries: 30
  delay: 5
  until: mariadb_cli.rc == 0

- name: "Wait until MariaDB accepts root credentials (via mysql_db)"
  community.mysql.mysql_db:
    name: "{{ MARIADB_HEALTHCHECK_DB }}"
    state: present
    login_user: root
    login_password: "{{ MARIADB_ROOT_PWD }}"
    login_host: "{{ MARIADB_HOST }}"
    login_port: "{{ MARIADB_PORT }}"
    config_file: ""
  register: mariadb_ready
  retries: 30
  delay: 5
  until: mariadb_ready is succeeded
  changed_when: false
  when: MARIADB_EXPOSE_LOCAL | bool

- include_tasks: utils/once/flag.yml
