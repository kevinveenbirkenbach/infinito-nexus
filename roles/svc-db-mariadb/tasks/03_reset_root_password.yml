- name: "Root password reset | Refuse reset unless explicitly enabled"
  assert:
    that:
      - MARIADB_ALLOW_RESET_WITHOUT_PREVIOUS | bool
    fail_msg: >-
      MariaDB root password does not match the desired value, but an automated reset is disabled.
      Set MARIADB_ALLOW_RESET_WITHOUT_PREVIOUS=true to perform a recovery reset (downtime),
      or reset the password manually.
  changed_when: false

- name: "Root password reset | Stop MariaDB container"
  community.docker.docker_container:
    name: "{{ MARIADB_NAME }}"
    state: stopped

- name: "Root password reset | Start recovery container (skip grants)"
  community.docker.docker_container:
    name: "{{ MARIADB_NAME }}-recovery"
    image: "{{ MARIADB_CUSTOM_IMAGE }}"
    state: started
    restart_policy: "no"
    network_mode: "none"
    command: >-
      mariadbd
      --skip-grant-tables
      --skip-networking
    volumes:
      - "{{ MARIADB_VOLUME }}:/var/lib/mysql"

- name: "Root password reset | Wait until recovery server is ready"
  community.docker.docker_container_exec:
    container: "{{ MARIADB_NAME }}-recovery"
    command: >-
      bash -lc "mariadb -uroot -e 'SELECT 1;'"
  register: mariadb_recovery_ready
  changed_when: false
  retries: 30
  delay: 2
  until: (mariadb_recovery_ready['rc'] | default(1)) == 0

- name: "Root password reset | Set new root password in recovery mode"
  community.docker.docker_container_exec:
    container: "{{ MARIADB_NAME }}-recovery"
    command: >-
      bash -lc "mariadb -uroot -e \"
      FLUSH PRIVILEGES;
      ALTER USER IF EXISTS 'root'@'localhost' IDENTIFIED BY '{{ MARIADB_ROOT_PWD }}';
      ALTER USER IF EXISTS 'root'@'%'        IDENTIFIED BY '{{ MARIADB_ROOT_PWD }}';
      FLUSH PRIVILEGES;\""
  register: mariadb_reset_root
  changed_when: true
  failed_when: mariadb_reset_root.rc != 0

- name: "Root password reset | Stop and remove recovery container"
  community.docker.docker_container:
    name: "{{ MARIADB_NAME }}-recovery"
    state: absent
    force_kill: true

- name: "Root password reset | Start MariaDB container again"
  community.docker.docker_container:
    name: "{{ MARIADB_NAME }}"
    state: started
