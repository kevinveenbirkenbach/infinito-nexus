- name: "Ensure Mailu user '{{ mailu_user_key }};{{ mailu_user_name }}@{{ MAILU_DOMAIN }}' exists"
  command: >
    {{ docker_compose_command_exec }} admin flask mailu {{ mailu_action }}
      {{ mailu_user_name }} {{ MAILU_DOMAIN }} -- {{ mailu_password }}
  args:
    chdir: "{{ MAILU_DOCKER_DIR }}"
  register: mailu_user_result
  retries: 15
  delay: 20
  until: >
    mailu_user_result.rc == 0 or
    "exists, not created" in mailu_user_result.stderr or
    "Duplicate entry" in mailu_user_result.stderr
  failed_when: >
    mailu_user_result.rc != 0 and
    (
      "exists, not created" not in mailu_user_result.stderr and
      "Duplicate entry"   not in mailu_user_result.stderr
    )
  changed_when: mailu_user_result.rc == 0
  when: "'mail-bot' in mailu_user_roles or 'administrator' in mailu_user_roles"
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

- name: "Change password for user '{{ mailu_user_key }};{{ mailu_user_name }}@{{ MAILU_DOMAIN }}'"
  command: >
    {{ docker_compose_command_exec }} admin flask mailu password
      {{ mailu_user_name }} {{ MAILU_DOMAIN }} -- {{ mailu_password }}
  args:
    chdir: "{{ MAILU_DOCKER_DIR }}"
  register: mailu_password_change
  retries: 12
  delay: 10
  until: mailu_password_change.rc == 0
  when: "'mail-bot' in mailu_user_roles or 'administrator' in mailu_user_roles"
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

- name: "Create Mailu API Token for {{ mailu_user_name }}"
  include_tasks: 03a_manage_user_token.yml
  when: "'mail-bot' in mailu_user_roles"
