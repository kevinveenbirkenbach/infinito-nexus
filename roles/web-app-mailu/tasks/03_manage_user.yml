---
- name: "Ensure Mailu user '{{ mailu_user_key }};{{ mailu_user_name }}@{{ MAILU_DOMAIN }}' exists"
  ansible.builtin.shell: >
    {{ PATH_COMPOSE }} exec admin flask mailu {{ mailu_action }}
    {{ mailu_user_name | quote }} {{ MAILU_DOMAIN | quote }} -- {{ mailu_user_password | quote }}
  args:
    chdir: "{{ MAILU_DOCKER_DIR }}"
  register: mailu_user_result
  changed_when: mailu_user_result.rc == 0
  failed_when: >
    mailu_user_result.rc != 0 and
    (
      ('exists' not in (mailu_user_result.stderr | lower)) and
      ('already' not in (mailu_user_result.stderr | lower)) and
      ('duplicate' not in (mailu_user_result.stderr | lower))
    )
  when: "'mail-bot' in mailu_user_roles or 'administrator' in mailu_user_roles"
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

- name: "Change password for user '{{ mailu_user_key }};{{ mailu_user_name }}@{{ MAILU_DOMAIN }}'"
  ansible.builtin.shell: >
    {{ PATH_COMPOSE }} exec admin flask mailu password
    {{ mailu_user_name | quote }} {{ MAILU_DOMAIN | quote }} -- {{ mailu_user_password | quote }}
  args:
    chdir: "{{ MAILU_DOCKER_DIR }}"
  register: mailu_user_password_change
  changed_when: mailu_user_password_change.rc == 0
  failed_when: mailu_user_password_change.rc != 0
  when: "'mail-bot' in mailu_user_roles or 'administrator' in mailu_user_roles"
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

- name: "Create Mailu API Token for {{ mailu_user_name }}"
  include_tasks: 03a_manage_user_token.yml
  when: "'mail-bot' in mailu_user_roles"
