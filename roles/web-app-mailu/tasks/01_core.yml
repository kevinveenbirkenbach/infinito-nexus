- include_tasks: utils/once/flag.yml

- name: Ensure Rspamd overrides directory exists (host)
  file:
    path: "{{ MAILU_RSPAMD_HOST_DIR }}"
    state: directory
    mode: "0755"

- name: Render ratelimit.conf
  template:
    src: ratelimit.conf.j2
    dest: "{{ MAILU_RSPAMD_HOST_FILE }}"
    mode: "0644"

- name: "load docker, db and proxy for {{ application_id }}"
  include_role:
    name: sys-stk-full
  vars:
    docker_compose_flush_handlers:  true
    webserver_vhost_flavour:        "basic"
    domain:                         "{{ MAILU_HOSTNAME }}"

- name: "Include Cert deploy service for '{{ role_name }}'"
  include_role:
    name: sys-ctl-mtn-cert-deploy
  when: lookup('tls_resolve', application_id, want='enabled') | bool

- name: "Flush Docker Compose handlers"
  meta: flush_handlers

- name: Wait for Mailu Database
  include_tasks: 02_wait_for_database.yml

- name: "Create Mailu accounts"
  include_tasks: 03_manage_user.yml
  vars:
    MAILU_DOCKER_DIR:      "{{ lookup('docker', application_id, 'directories.instance') }}"
    mailu_action: >-
      {{
        (
          'administrator' in (user_item.value.get('roles', []))
        )
        | ternary('admin','user')
      }}
    mailu_user_key:       "{{ user_item.key }}"
    mailu_user_name:      "{{ user_item.value.username }}"
    mailu_user_password:  "{{ user_item.value.password }}"
    mailu_token_ip:       "{{ user_item.value.ip | default(networks.internet.ip4) }}"
    mailu_token_name:     "{{ SOFTWARE_NAME ~ ' Token for ' ~ user_item.value.username }}"
    mailu_user_roles:     "{{ user_item.value.roles | default([]) }}"
  loop: "{{ users | dict2items }}"
  loop_control:
    loop_var: user_item
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

- name: Generate DKIM public key
  include_tasks: 04_generate-and-read-dkim.yml

- name: Set Mailu DNS records
  include_tasks: 05_dns-records.yml
