- block:
    - name: "CLEANUP | Gather existing apex TXT/MX (and DMARC/DKIM) records"
      community.general.cloudflare_dns_info:
        api_token: "{{ CLOUDFLARE_API_TOKEN }}"
        zone: "{{ MAILU_DOMAIN_DNS_ZONE }}"
      register: cf_info
  
    - name: "CLEANUP | Build deletion list"
      set_fact:
        cf_records_to_delete: >-
          {{
            cf_info.records
            | selectattr('type','in',['MX','TXT'])
            | selectattr('name','in', [
                MAILU_DOMAIN,
                '_dmarc.' ~ MAILU_DOMAIN_DNS_ZONE,
                'dkim._domainkey.' ~ MAILU_DOMAIN_DNS_ZONE
              ])
            | list
          }}
  
    - name: "CLEANUP | Remove matched records (exact Value match)"
      community.general.cloudflare_dns:
        api_token: "{{ CLOUDFLARE_API_TOKEN }}"
        zone: "{{ MAILU_DOMAIN_DNS_ZONE }}"
        type: "{{ item.type }}"
        name: "{{ item.name }}"
        value: "{{ item.value | default(item.content) }}"
        state: absent
      loop: "{{ cf_records_to_delete }}"
      loop_control:
        label: "{{ item.type }} {{ item.name }} -> {{ item.value | default(item.content) }}"
  when:
    - DNS_PROVIDER | lower == 'cloudflare'
    - MODE_CLEANUP | bool

- name: "DNS (Cloudflare) for Mailu"
  include_role:
    name: sys-dns-cloudflare-records
  when: DNS_PROVIDER | lower == 'cloudflare'
  vars:
    cloudflare_async_enabled: "{{ ASYNC_ENABLED |  bool }}"
    cloudflare_async_time: "{{ ASYNC_TIME }}"
    cloudflare_async_poll: "{{ ASYNC_POLL }}"
    cloudflare_no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"
    cloudflare_records:
      - { type: A,     zone: "{{ MAILU_HOSTNAME_DNS_ZONE }}", name: "{{ MAILU_HOSTNAME }}", content: "{{ MAILU_IP4_PUBLIC }}", proxied: false }
#      - { type: AAAA,  zone: "{{ MAILU_HOSTNAME_DNS_ZONE }}", name: "{{ MAILU_HOSTNAME }}", content: "{{ MAILU_IP6_PUBLIC }}", proxied: false }
      - { type: CNAME, zone: "{{ MAILU_DOMAIN_DNS_ZONE }}",   name: "autoconfig.{{ MAILU_DOMAIN_DNS_ZONE }}",       value: "{{ MAILU_HOSTNAME }}" }
      - { type: MX,    zone: "{{ MAILU_DOMAIN_DNS_ZONE }}",   name: "{{ MAILU_DOMAIN }}",                           value: "{{ MAILU_HOSTNAME }}", priority: 10 }
      - { type: TXT,   zone: "{{ MAILU_DOMAIN_DNS_ZONE }}",   name: "{{ MAILU_DOMAIN }}",                           value: '"v=spf1 mx a:{{ MAILU_HOSTNAME }} ~all"' }
      - { type: TXT,   zone: "{{ MAILU_DOMAIN_DNS_ZONE }}",   name: "_dmarc.{{ MAILU_DOMAIN_DNS_ZONE }}",           value: '"v=DMARC1; p=reject; ruf=mailto:{{ MAILU_DMARC_RUF }}; adkim=s; aspf=s"' }
      - { type: TXT,   zone: "{{ MAILU_DOMAIN_DNS_ZONE }}",   name: "dkim._domainkey.{{ MAILU_DOMAIN_DNS_ZONE }}",  value: '"{{ mailu_dkim_public_key }}"' }
      - { type: SRV,   zone: "{{ MAILU_DOMAIN_DNS_ZONE }}", service: "_submission",  proto: "_tcp",name: "{{ MAILU_DOMAIN }}", priority: 20, weight: 1, port: 587, value: "{{ MAILU_HOSTNAME }}" }
      - { type: SRV,   zone: "{{ MAILU_DOMAIN_DNS_ZONE }}", service: "_submissions", proto: "_tcp",name: "{{ MAILU_DOMAIN }}", priority: 20, weight: 1, port: 465, value: "{{ MAILU_HOSTNAME }}" }
      - { type: SRV,   zone: "{{ MAILU_DOMAIN_DNS_ZONE }}", service: "_imaps",      proto: "_tcp", name: "{{ MAILU_DOMAIN }}", priority: 20, weight: 1, port: 993, value: "{{ MAILU_HOSTNAME }}" }
      - { type: SRV,   zone: "{{ MAILU_DOMAIN_DNS_ZONE }}", service: "_imap",       proto: "_tcp", name: "{{ MAILU_DOMAIN }}", priority: 20, weight: 1, port: 143, value: "{{ MAILU_HOSTNAME }}" }
      - { type: SRV,   zone: "{{ MAILU_DOMAIN_DNS_ZONE }}", service: "_pop3s",      proto: "_tcp", name: "{{ MAILU_DOMAIN }}", priority: 20, weight: 1, port: 995, value: "{{ MAILU_HOSTNAME }}" }
      - { type: SRV,   zone: "{{ MAILU_DOMAIN_DNS_ZONE }}", service: "_pop3",       proto: "_tcp", name: "{{ MAILU_DOMAIN }}", priority: 20, weight: 1, port: 110, value: "{{ MAILU_HOSTNAME }}" }
      - { type: SRV,   zone: "{{ MAILU_DOMAIN_DNS_ZONE }}", service: "_autodiscover", proto: "_tcp", name: "{{ MAILU_DOMAIN }}", priority: 20, weight: 1, port: 443, value: "{{ MAILU_HOSTNAME }}" }

- name: "rDNS (Hetzner Cloud) for Mailu"
  include_role:
    name: sys-dns-hetzner-rdns
  when: HOSTING_PROVIDER | lower == 'hetzner'
  vars:
    rdns_records:
      - { resource: "server", ip_address: "{{ MAILU_IP4_PUBLIC }}", dns_ptr: "{{ MAILU_HOSTNAME }}" }
#      - { resource: "server", ip_address: "{{ MAILU_IP6_PUBLIC | default('') }}", dns_ptr: "{{ MAILU_HOSTNAME }}" }