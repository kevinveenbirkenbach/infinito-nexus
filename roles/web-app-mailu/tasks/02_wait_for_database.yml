- name: "Wait until Mailu database schema is initialized (domain table exists)"
  block:

    - name: "Check for Mailu DB domain table"
      ansible.builtin.command: >
        {{ BIN_CONTAINER }} exec {{ lookup('database', application_id, 'container') }} mariadb -u {{ lookup('database', application_id, 'username') }} -p{{ lookup('database', application_id, 'password') }}
        -e "SHOW TABLES FROM {{ lookup('database', application_id, 'name') }} LIKE 'domain';"
      args:
        chdir: "{{ lookup('docker', application_id, 'directories.instance') }}"
      register: mailu_db_schema_check
      retries: 30
      delay: 5
      until: mailu_db_schema_check.stdout | length > 0
      changed_when: false
      no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

  rescue:

    - name: "Collect Mailu admin container logs (last 300 lines)"
      ansible.builtin.command: >
        {{ BIN_COMPOSE }} logs --tail=300 admin
      args:
        chdir: "{{ lookup('docker', application_id, 'directories.instance') }}"
      register: mailu_admin_logs
      changed_when: false

    - name: "Fail: Mailu database schema not initialized"
      ansible.builtin.fail:
        msg: |
          Mailu database schema was not initialized in time.

          Expected table: {{ lookup('database', application_id, 'name') }}.domain

          --- Mailu admin container logs (last 300 lines) ---
          {{ mailu_admin_logs.stdout | default('No logs available') }}
