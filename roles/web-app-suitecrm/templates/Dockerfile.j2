FROM "{{ SUITECRM_BASE_IMAGE }}:{{ SUITECRM_BASE_VERSION }}"

# Install required system packages and PHP extensions
RUN apt-get update && apt-get install -y \
      git \
      wget \
      unzip \
      libpng-dev \
      libzip-dev \
      libicu-dev \
      libonig-dev \
      libxml2-dev \
      libldap2-dev \
  && docker-php-ext-configure ldap --with-libdir=lib/x86_64-linux-gnu \
  && docker-php-ext-install \
      mysqli \
      gd \
      zip \
      intl \
      mbstring \
      soap \
      opcache \
      ldap \
  && rm -rf /var/lib/apt/lists/*

# Install Apache modules
RUN a2enmod rewrite headers

WORKDIR /var/www/html

# Adjust Apache DocumentRoot for SuiteCRM 8 (Symfony public/ dir)
RUN sed -ri 's!/var/www/html!/var/www/html/public!g' \
      /etc/apache2/sites-available/000-default.conf \
      /etc/apache2/apache2.conf

# Install Composer
COPY --from=composer:2 /usr/bin/composer /usr/bin/composer

# Download SuiteCRM 8 source from GitHub
RUN set -eux; \
    SUITECRM_TAG="v{{ SUITECRM_APP_VERSION }}"; \
    wget -qO /tmp/suitecrm.tar.gz \
      "https://github.com/SuiteCRM/SuiteCRM-Core/archive/refs/tags/${SUITECRM_TAG}.tar.gz"; \
    tar --strip-components=1 -xzf /tmp/suitecrm.tar.gz -C /var/www/html; \
    rm /tmp/suitecrm.tar.gz; \
    chmod +x bin/console

# Install PHP dependencies via Composer (critical!)
RUN set -eux; \
    composer install \
      --no-dev \
      --prefer-dist \
      --no-interaction \
      --optimize-autoloader \
      --no-scripts

# Copy entrypoint
COPY {{ SUITECRM_ENTRYPOINT_SCRIPT_HOST_REL }} {{ SUITECRM_ENTRYPOINT_SCRIPT_DOCKER }}
RUN chmod +x {{ SUITECRM_ENTRYPOINT_SCRIPT_DOCKER }}

ENTRYPOINT ["{{ SUITECRM_ENTRYPOINT_SCRIPT_DOCKER }}"]
CMD ["apache2-foreground"]
