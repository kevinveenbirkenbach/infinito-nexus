- include_tasks: utils/once/flag.yml

- name: Include dependencies
  include_role:
    name: "{{ item }}"
  loop:
    - dev-fakeroot
    - dev-git
    - dev-base-devel

- name: Install yay build prerequisites
  become: true
  package:
    name:
      - base-devel
      - patch
      - git
    state: present

- name: Create the AUR builder user
  become: true
  ansible.builtin.user:
    name: "{{ AUR_BUILDER_USER }}"
    create_home: yes
    group: "{{ AUR_BUILDER_GROUP }}"

- name: Allow AUR builder to run pacman without password
  become: true
  ansible.builtin.lineinfile:
    path: "{{ AUR_BUILDER_SUDOERS_PATH }}"
    line: "{{ AUR_BUILDER_USER }} ALL=(ALL) NOPASSWD: /usr/bin/pacman"
    create: yes
    validate: "visudo -cf %s"

- name: Clone yay from AUR
  become: true
  become_user: "{{ AUR_BUILDER_USER }}"
  git:
    repo: https://aur.archlinux.org/yay.git
    dest: "/home/{{ AUR_BUILDER_USER }}/yay"
    clone: yes
    update: yes
    depth: 1

- name: Check whether yay is present
  become: true
  ansible.builtin.stat:
    path: /usr/bin/yay
  register: yay_stat

- name: Check whether yay has missing shared libraries (broken)
  become: true
  ansible.builtin.command: bash -lc "ldd /usr/bin/yay 2>/dev/null | grep -q 'not found'"
  register: yay_ldd_missing
  failed_when: false
  changed_when: false
  when: yay_stat.stat.exists

- name: Remove broken yay binary so it can be rebuilt
  become: true
  ansible.builtin.file:
    path: /usr/bin/yay
    state: absent
  when:
    - yay_stat.stat.exists
    - yay_ldd_missing.rc == 0

- name: Build and install yay
  become: true
  become_user: "{{ AUR_BUILDER_USER }}"
  shell: |
    set -euo pipefail
    cd /home/{{ AUR_BUILDER_USER }}/yay
    makepkg -si --noconfirm
  args:
    creates: /usr/bin/yay

- name: upgrade the system using yay, only act on AUR packages.
  include_role:
    name: sys-aur-install
  vars:
    yay_install_packages: []
    yay_install_use: "{{ AUR_HELPER }}"
    yay_install_upgrade: true
    yay_install_aur_only: true
