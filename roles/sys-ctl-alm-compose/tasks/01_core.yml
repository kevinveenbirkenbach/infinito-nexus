- name: "Include dependent services for '{{ system_service_id  }}'"
  include_role:
    name: '{{ item }}'
  loop:
    - sys-ctl-alm-telegram
    - sys-ctl-alm-email
  vars:
    flush_handlers: true
    system_service_timer_enabled: false
    system_service_copy_files: true
    system_service_tpl_exec_start: "{{ system_service_script_exec }} %I"
    system_service_tpl_on_failure: ""

- name: "Include core service for '{{ system_service_id  }}'"
  include_role:
    name: sys-service
  vars:
    flush_handlers: true
    system_service_timer_enabled: false
    system_service_copy_files: true
    system_service_tpl_exec_start: "{{ system_service_script_exec }} %I"
    system_service_tpl_on_failure: "" # No on failure needed, because it's anyhow the default on failure procedure

- name: Assert '{{ system_service_id }}'
  block:
  
  - name: Escape instance name for systemctl call
    ansible.builtin.command:
      argv:
        - systemd-escape
        - "{{ SYSTEMCTL_ALARM_COMPOSER_DUMMY_MESSAGE }}"
    register: escaped_name
    changed_when: false

  - name: Start '{{ system_service_id }}' instance
    ansible.builtin.systemd:
      name: "{{ system_service_id | get_service_name(SOFTWARE_NAME, False) ~ escaped_name.stdout }}.service"
      state: started
  when: MODE_ASSERT | bool
