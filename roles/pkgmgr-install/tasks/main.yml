- include_tasks: 01_core.yml
  when: run_once_pkgmgr_install is not defined

- name: "Install '{{ package_name }}' via Kevin's Package Manager (pkgmgr)"
  ansible.builtin.shell: |
    source ~/.venvs/pkgmgr/bin/activate
    pkgmgr update {{ package_name }} --dependencies --clone-mode shallow
  args:
    executable: /bin/bash
  notify: "{{ package_notify | default(omit,true) }}"
  register: pkgmgr_update_result
  # Mark changed only if it's not "already up to date" and not "no command defined..."
  changed_when: >
    ('already up to date' not in ((pkgmgr_update_result.stdout | default('') | lower)
      ~ ' ' ~ (pkgmgr_update_result.stderr | default('') | lower)))
    and
    ('no command defined' not in ((pkgmgr_update_result.stdout | default('') | lower)
      ~ ' ' ~ (pkgmgr_update_result.stderr | default('') | lower)))

  # Fail only on real errors; allow the "no command defined..." case
  failed_when: >
    (pkgmgr_update_result.rc != 0)
    and
    ('no command defined' not in ((pkgmgr_update_result.stdout | default('') | lower)
      ~ ' ' ~ (pkgmgr_update_result.stderr | default('') | lower)))

- name: "update '{{ package_name }}' via pkgmgr (non-interactive)"
  shell: |
    set -euo pipefail
    export GIT_TERMINAL_PROMPT=0
    export GIT_SSH_COMMAND="ssh -o BatchMode=yes -o StrictHostKeyChecking=yes"
    export PYTHONUNBUFFERED=1
    timeout --signal=KILL 600s "{{ ansible_env.HOME }}/.venvs/pkgmgr/bin/pkgmgr" update "{{ package_name }}" --clone-mode shallow </dev/null
  args:
    executable: /bin/bash
  register: pkgmgr_update
  changed_when: "'already up to date' not in (pkgmgr_update.stdout | lower)"
  become: true
  when: MODE_UPDATE | bool
