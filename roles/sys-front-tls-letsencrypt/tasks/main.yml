# run_once_sys_front_tls_letsencrypt: deactivated

- name: "TLS | (letsencrypt) resolve via tls_resolve (strict)"
  ansible.builtin.set_fact:
    _tls: "{{ lookup('tls_resolve', application_id) }}"
  changed_when: false

- name: "TLS | (letsencrypt) assert mode is letsencrypt"
  ansible.builtin.assert:
    that:
      - _tls.enabled | bool
      - _tls.mode == 'letsencrypt'
    fail_msg: >-
      sys-front-tls-letsencrypt called for '{{ application_id }}'
      but resolver returned enabled={{ _tls.enabled }}, mode={{ _tls.mode }}.
  changed_when: false

- name: "TLS | (letsencrypt) check cert files exist"
  ansible.builtin.stat:
    path: "{{ item }}"
  register: _le_stat
  loop:
    - "{{ _tls.files.cert }}"
    - "{{ _tls.files.key }}"
  changed_when: false

- name: "TLS | (letsencrypt) issue cert if missing"
  ansible.builtin.include_role:
    name: sys-svc-certs
  vars:
    domain: "{{ _tls.domains.primary }}"
  when: >
    (not _le_stat.results[0].stat.exists | default(false)) or
    (not _le_stat.results[1].stat.exists | default(false))

- name: "TLS | (letsencrypt) re-check cert files exist"
  ansible.builtin.stat:
    path: "{{ item }}"
  register: _le_stat2
  loop:
    - "{{ _tls.files.cert }}"
    - "{{ _tls.files.key }}"
  changed_when: false

- name: "TLS | (letsencrypt) fail if still missing"
  ansible.builtin.fail:
    msg: >-
      Let's Encrypt certificate files not found after issuance:
      cert={{ _tls.files.cert }} key={{ _tls.files.key }}
  when: >
    (not _le_stat2.results[0].stat.exists | default(false)) or
    (not _le_stat2.results[1].stat.exists | default(false))
