---
- name: Check if listmonk database is already initialized
  command: '{{ LISTMONK_EXEC_DATABASE }} -c "\dt"'
  register: db_tables
  changed_when: false
  failed_when: false

- name: Determine Listmonk database state
  set_fact:
    listmonk_db_reachable: "{{ db_tables.rc == 0 }}"
    listmonk_db_empty: >-
      {{
        ('No relations found.' in (db_tables.stdout | default(''))) or
        ('No relations found.' in (db_tables.stderr | default(''))) or
        ('Did not find any relations.' in (db_tables.stderr | default(''))) or
        ('Did not find any relations.' in (db_tables.stdout | default('')))
      }}

- name: Abort if Listmonk database is not reachable
  fail:
    msg: |
      Listmonk database is not reachable.

      Container: {{ lookup('database', application_id, 'container') }}
      Database:  {{ lookup('database', application_id, 'name') }}

      Please ensure the shared PostgreSQL stack is running.
  when: not listmonk_db_reachable

- name: Run Listmonk initial database setup
  shell: |
    set -euo pipefail
    yes | {{ LISTMONK_RUN }} ./listmonk --install
  args:
    chdir: "{{ lookup('docker', application_id, 'directories.instance') }}"
  register: listmonk_install
  notify: compose up
  changed_when: true
  failed_when: listmonk_install.rc not in [0, 141]
  when: listmonk_db_empty

- name: Run Listmonk DB/schema upgrade (non-interactive)
  shell: |
    set -euo pipefail
    echo y | {{ LISTMONK_RUN }} ./listmonk --upgrade
  args:
    chdir: "{{ lookup('docker', application_id, 'directories.instance') }}"
  register: listmonk_upgrade
  changed_when: true
  failed_when: listmonk_upgrade.rc not in [0, 141]
  when:
    - listmonk_db_reachable
    - not listmonk_db_empty
