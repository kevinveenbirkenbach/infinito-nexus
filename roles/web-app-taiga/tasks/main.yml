---
- name: "load docker, db and proxy for {{ application_id }}"
  include_role:
    name: sys-stk-full
  vars:
    docker_compose_flush_handlers:  false
    docker_git_repository_address:  "https://github.com/taigaio/taiga-docker"
    docker_git_repository_pull:     true

- name: "copy templates {{ TAIGA_SETTING_FILES }} for taiga-contrib-oidc-auth"
  template:
    src:  "taiga/{{ item }}.py.j2"
    dest: "{{ [ lookup('docker', application_id, 'directories.config'), 'taiga-' ~ item ~ '.py'] | path_join }}"
  when:   TAIGA_TAIGAIO_ENABLED | bool
  notify: docker compose up
  loop:   "{{ TAIGA_SETTING_FILES }}"

- name: "create {{ TAIGA_COMPOSE_INIT_PATH }}"
  template:
    src:  "docker-compose-inits.yml.j2"
    dest:  "{{ TAIGA_COMPOSE_INIT_PATH }}"
  notify: docker compose up

- name: "Include Taiga administrator routines"
  include_tasks: 01_administrator.yml

- name: "Flush Taiga handlers"
  meta: flush_handlers
