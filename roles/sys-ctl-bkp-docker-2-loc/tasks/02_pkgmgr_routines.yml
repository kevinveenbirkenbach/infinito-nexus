- block:
    - name: "Install/update {{ BKP_DOCKER_2_LOC_PKG }} via pkgmgr (nix run)"
      become: true
      ansible.builtin.command:
        argv:
          - nix
          - run
          - --no-write-lock-file
          - "github:kevinveenbirkenbach/package-manager#pkgmgr"
          - --
          - update
          - "{{ BKP_DOCKER_2_LOC_PKG }}"
          - --dependencies
          - --clone-mode
          - shallow
      register: pkgmgr_update_result
      changed_when: >
        ('already up to date' not in ((pkgmgr_update_result.stdout | default('') | lower)
          ~ ' ' ~ (pkgmgr_update_result.stderr | default('') | lower)))
        and
        ('no command defined' not in ((pkgmgr_update_result.stdout | default('') | lower)
          ~ ' ' ~ (pkgmgr_update_result.stderr | default('') | lower)))
      failed_when: >
        (pkgmgr_update_result.rc != 0)
        and
        ('no command defined' not in ((pkgmgr_update_result.stdout | default('') | lower)
          ~ ' ' ~ (pkgmgr_update_result.stderr | default('') | lower)))

    - name: "Retrieve {{ BKP_DOCKER_2_LOC_PKG }} path via pkgmgr (nix run)"
      become: true
      ansible.builtin.command:
        argv:
          - nix
          - run
          - --no-write-lock-file
          - "github:kevinveenbirkenbach/package-manager#pkgmgr"
          - --
          - path
          - "{{ BKP_DOCKER_2_LOC_PKG }}"
      register: pkgmgr_output
      changed_when: false

    - name: Set fact for backup_docker_to_local_folder
      ansible.builtin.set_fact:
        backup_docker_to_local_folder: "{{ (pkgmgr_output.stdout | trim) ~ '/' }}"
      changed_when: false

  when: backup_docker_to_local_folder is not defined
  vars:
    BKP_DOCKER_2_LOC_PKG: backup-docker-to-local
