- include_tasks: utils/once/flag.yml

- name: Include dependencies
  include_role:
    name: '{{ item }}'
  loop:
  - user-backup
  - sys-bkp-provider
  - sys-ctl-alm-compose
  - sys-lock

- include_tasks: 02_install_routines.yml
  when: backup_docker_to_local_folder is not defined

- name: "reset (if enabled) for {{ role_name}}"
  include_tasks: 03_reset.yml
  when: MODE_RESET | bool

- name: Ensure secrets directory exists (root only)
  ansible.builtin.file:
    path: "{{ DIR_SECRETS }}"
    state: directory
    owner: root
    group: root
    mode: "0700"

- name: Ensure databases.csv exists (root only)
  ansible.builtin.file:
    path: "{{ FILE_DATABASE_SECRETS }}"
    state: touch
    owner: root
    group: root
    mode: "0600"

- name: Check if databases.csv has content
  file_has_content:
    path: "{{ FILE_DATABASE_SECRETS }}"
  register: db_csv

- name: Compute backup force-flush flag
  ansible.builtin.set_fact:
    _backup_force_flush_instant: "{{ MODE_BACKUP | bool and db_csv.exists and db_csv.has_content }}"

- name: "Execute system service setup for '{{ system_service_id }}'"
  include_role:
    name: sys-service
  vars:
    system_service_copy_files:          false
    system_service_timer_enabled:       true
    system_service_force_linear_sync:   true
    system_service_force_flush_instant: "{{ _backup_force_flush_instant }}"
    # Force final flush during ci runs to guaranty that it works:
    system_service_force_flush_final:   "{{ (RUNTIME in ['act','github']) and (MODE_BACKUP | bool) }}"
    system_service_suppress_flush:      "{{ not _backup_force_flush_instant }}"
    system_service_on_calendar:         "{{ SYS_SCHEDULE_BACKUP_DOCKER_TO_LOCAL }}"
    system_service_tpl_exec_start_pre:  '/usr/bin/python {{ BIN_LOCK }} {{ SYS_SERVICE_GROUP_MANIPULATION | join(" ")  }} --ignore {{ SYS_SERVICE_BACKUP_DOCKER_2_LOC }} --timeout "{{ SYS_TIMEOUT_BACKUP_SERVICES }}"'
    system_service_tpl_exec_start:      "/bin/sh -c '{{ BKP_DOCKER_2_LOC_EXEC }}'"
    system_service_tpl_on_failure:      "{{ SYS_SERVICE_ON_FAILURE_COMPOSE }}"
    # system_service_tpl_exec_start_post: "/usr/bin/systemctl start {{ SYS_SERVICE_CLEANUP_BACKUPS }}" # Not possible to use it because it's a deathlock. Keep this line for documentation purposes
