---
- include_tasks: 02_install.yml

- name: "Ensure /etc/baudolo exists"
  ansible.builtin.file:
    path: "{{ DIR_SECRETS }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: "BKP | Debug seed context (sanitized)"
  ansible.builtin.debug:
    msg: |
      database_consumer_id: "{{ database_consumer_id | default('undefined') }}"
      database_instance: "{{ database_instance | default('undefined') }}"
      database_name: "{{ database_name | default('undefined') }}"
      database_type: "{{ database_type | default('undefined') }}"
      database_host: "{{ database_host | default('undefined') }}"
      database_port: "{{ database_port | default('undefined') }}"
      database_username: "{{ database_username | default('undefined') }}"
  when: MODE_DEBUG | bool
  changed_when: false

- name: "BKP | Assert required database variables are explicitly passed"
  ansible.builtin.assert:
    that:
      - database_instance is defined
      - (database_instance | string | trim) != ""

      - database_type is defined
      - (database_type | string | trim) != ""

      - database_host is defined
      - (database_host | string | trim) != ""

      - database_port is defined
      - (database_port | string | trim) != ""

      - database_username is defined
      - (database_username | string | trim) != ""

      - database_password is defined
      - (database_password | string | trim) != ""

      # database_name may be empty string to represent "all databases"
      - database_name is defined
    fail_msg: >-
      You must pass ALL database variables explicitly when including
      sys-ctl-bkp-docker-2-loc/tasks/04_seed-database-to-backup.yml:

        database_instance, database_type, database_host, database_port,
        database_username, database_password, database_name

      Note: database_name may be an empty string to represent "all databases".
  changed_when: false

- name: Seed database definition via baudolo-seed (system binary)
  ansible.builtin.command:
    argv:
      - "{{ lookup('command_path', 'baudolo-seed') }}"
      - "{{ FILE_DATABASE_SECRETS }}"
      - "{{ database_instance }}"
      - "{{ '*' if (database_name | string | length) == 0 else (database_name | string) }}"
      - "{{ database_username }}"
      - "{{ database_password }}"
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"
  async: "{{ ASYNC_TIME if ASYNC_ENABLED | bool else omit }}"
  poll: "{{ ASYNC_POLL if ASYNC_ENABLED | bool else omit }}"
