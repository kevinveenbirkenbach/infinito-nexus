- include_tasks: 02_install_routines.yml

- name: "Ensure /etc/baudolo exists"
  ansible.builtin.file:
    path: "{{ PATH_INFINITO_SECRETS_DIR }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: "Display all database variables"
  ansible.builtin.debug:
    msg: |
      database_consumer_id: "{{ database_consumer_id | default('undefined') }}"
      database_instance: "{{ database_instance | default('undefined') }}"
      database_name: "{{ database_name | default('undefined') }}"
      database_type: "{{ database_type | default('undefined') }}"
      database_host: "{{ database_host | default('undefined') }}"
      database_username: "{{ database_username | default('undefined') }}"
      database_password: "{{ database_password | default('undefined') }}"
  when: MODE_DEBUG | bool
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

- name: "Fail if not all required database variables are defined"
  ansible.builtin.fail:
    msg: "You must define all of the following variables: database_instance, database_name, database_username, database_password"
  when: >
    (database_instance is defined or
     database_name is defined or
     database_username is defined or
     database_password is defined) and not
    (database_instance is defined and
     database_name is defined and
     database_username is defined and
     database_password is defined)
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

- name: Seed database definition via baudolo-seed (system binary)
  ansible.builtin.command:
    argv:
      - /usr/bin/baudolo-seed
      - "{{ PATH_INFINITO_DATABASE_SECRETS }}"
      - "{{ database_instance }}"
      - "{{ '*' if database_name | length == 0 else database_name }}"
      - "{{ database_username }}"
      - "{{ database_password }}"
  when:
    - database_instance is defined
    - database_name is defined
    - database_username is defined
    - database_password is defined
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"
  async: "{{ ASYNC_TIME if ASYNC_ENABLED | bool else omit }}"
  poll:  "{{ ASYNC_POLL if ASYNC_ENABLED | bool else omit }}"
