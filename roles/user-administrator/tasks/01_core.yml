- name: Fail if administrator authorized_keys is empty
  ansible.builtin.fail:
    msg: >-
      users.administrator.authorized_keys must contain at least one SSH public key.
  when: users.administrator.authorized_keys | length == 0

- name: Include dependency 'sys-sudo'
  include_role:
    name: sys-sudo
  when: run_once_sys_sudo is not defined

- name: create administrator
  user:
    name: administrator
    update_password: on_create
    password: "{{ users.administrator.password | password_hash('sha512') }}"
    create_home: yes
    generate_ssh_key: yes
    ssh_key_type: rsa
    ssh_key_bits: 8192
  no_log: "{{ MASK_CREDENTIALS_IN_LOGS | bool }}"

- name: "set correct rights for {{ PATH_ADMINISTRATOR_HOME }}"
  file:
    path: "{{ PATH_ADMINISTRATOR_HOME }}"
    state: directory
    owner: administrator
    group: administrator
    mode: 0700

- name: grant administrator sudo rights with password
  copy:
    src: "administrator"
    dest: /etc/sudoers.d/administrator
    mode: '0644'
    owner: root
    group: root
  notify: sshd restart

- name: "embed user routines for {{ role_path | basename }}"
  include_role:
    name: user
  vars:
    user_name: "administrator"

- include_tasks: utils/once/flag.yml
