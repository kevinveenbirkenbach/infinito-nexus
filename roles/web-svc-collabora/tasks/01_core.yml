- name: "load docker, proxy for '{{ application_id }}'"
  include_role:
    name: sys-stk-full-stateless
    public: true
  vars:
    docker_compose_flush_handlers:        true
    docker_compose_file_creation_enabled: true
    docker_git_repository_pull:           false

- name: Update Collabora systemplate to include new fonts
  command: "{{ COLLABORA_DOCKER_CONF_EXEC }} update-system-template"
  register: collabora_fonts
  changed_when: >
    (not ASYNC_ENABLED | bool )
    and
    ('updated' in (collabora_fonts.stdout | default('')))
  async: "{{ ASYNC_TIME  if (ASYNC_ENABLED |  bool) else omit }}"
  poll:  "{{ ASYNC_POLL if (ASYNC_ENABLED |  bool) else omit }}"
  when: MODE_UPDATE | bool

- name: Allow Nextcloud host IP for Collabora preview conversion
  command: "{{ COLLABORA_DOCKER_CONF_EXEC }} set net.post_allow.host {{ networks.internet.ip4 }}"
  register: collabora_preview
  changed_when: >
    (not ASYNC_ENABLED | bool )
    and
    ('already present' not in (collabora_preview.stdout | default('')))
  async: "{{ ASYNC_TIME if ASYNC_ENABLED | bool else omit }}"
  poll:  "{{ ASYNC_POLL if ASYNC_ENABLED | bool else omit }}"

- include_tasks: utils/once/flag.yml