# run_once_sys_pip_install: disabled

- include_tasks: 01_core.yml
  when: run_once_sys_pip_install is not defined

- name: Resolve active Python executable for sys-pip-install
  ansible.builtin.set_fact:
    sys_pip_install_python_executable: "{{ ansible_facts.python.executable | default(ansible_playbook_python) }}"
  changed_when: false

- block:
    - name: Probe whether pip for ansible_python_interpreter accepts --break-system-packages
      ansible.builtin.command:
        argv:
          - "{{ sys_pip_install_python_executable }}"
          - -m
          - pip
          - install
          - --break-system-packages
          - --help
      register: sys_pip_install_break_system_packages_probe
      changed_when: false
      failed_when: false
      become: "{{ true if global_install | bool else false }}"

    - name: Set fact for --break-system-packages support
      ansible.builtin.set_fact:
        sys_pip_install_supports_break_system_packages: "{{ (sys_pip_install_break_system_packages_probe.rc | int) == 0 }}"
      changed_when: false

  when: global_install | bool

- name: Check whether selected Python interpreter has 'packaging'
  ansible.builtin.command:
    argv:
      - "{{ sys_pip_install_python_executable }}"
      - -c
      - import packaging
  register: sys_pip_install_python_packaging_check
  changed_when: false
  failed_when: false

- name: Bootstrap 'packaging' for selected Python interpreter
  ansible.builtin.command:
    argv: >-
      {{
        [sys_pip_install_python_executable, '-m', 'pip', 'install', '--upgrade', 'packaging']
        + (
            ['--break-system-packages']
            if (global_install | bool and sys_pip_install_supports_break_system_packages | default(false) | bool)
            else []
          )
      }}
  environment: >-
    {{
      (
        {'PIP_BREAK_SYSTEM_PACKAGES': '1'}
        if sys_pip_install_supports_break_system_packages | default(false) | bool
        else {}
      )
      if global_install | bool
      else omit
    }}
  become: "{{ true if global_install | bool else false }}"
  when: sys_pip_install_python_packaging_check.rc != 0

- name: Install or upgrade {{ package_name }} system-wide via pip
  ansible.builtin.pip:
    name: "{{ package_name }}"
    state: "{{ package_state }}"
    extra_args: "{{ '--break-system-packages' if (global_install | bool and sys_pip_install_supports_break_system_packages | bool) else omit }}"
    virtualenv: "{{ omit if global_install | bool else (sys_pip_install_python_executable | dirname | dirname) }}"
  environment: >-
    {{
      (
        {'PIP_BREAK_SYSTEM_PACKAGES': '1'}
        if sys_pip_install_supports_break_system_packages | bool
        else {}
      )
      if global_install | bool
      else omit
    }}
  become: "{{ true if global_install | bool else false }}"
