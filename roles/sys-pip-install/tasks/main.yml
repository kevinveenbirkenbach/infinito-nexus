# run_once_sys_pip_install: disabled

- name: Include dependency 'sys-pip'
  include_role:
    name: sys-pip
  when: run_once_sys_pip is not defined

- name: Probe whether pip3 accepts --break-system-packages
  ansible.builtin.command:
    argv:
      - pip3
      - install
      - --break-system-packages
      - --help
  register: sys_pip_install_break_system_packages_probe
  changed_when: false
  failed_when: false
  become: "{{ true if global_install | bool else false }}"
  environment:
    PATH: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
  when: global_install | bool

- name: Set fact for --break-system-packages support
  ansible.builtin.set_fact:
    sys_pip_install_supports_break_system_packages: "{{ (sys_pip_install_break_system_packages_probe.rc | int) == 0 }}"
  changed_when: false
  when: global_install | bool

- name: Install or upgrade {{ package_name }} system-wide via pip3
  ansible.builtin.pip:
    name: "{{ package_name }}"
    state: latest
    executable: "{{'pip3' if global_install | bool else omit }}"
    extra_args: "{{ '--break-system-packages' if (global_install | bool and sys_pip_install_supports_break_system_packages | bool) else omit }}"
    virtualenv: "{{ omit if global_install | bool else (ansible_python_interpreter | dirname | dirname) }}"
  environment: >-
    {{
      (
        {'PATH': '/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'}
        | combine(
            {'PIP_BREAK_SYSTEM_PACKAGES': '1'}
            if sys_pip_install_supports_break_system_packages | bool
            else {}
          )
      )
      if global_install | bool
      else omit
    }}
  become: "{{ true if global_install | bool else false }}"
