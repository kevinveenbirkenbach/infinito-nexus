---
# run_once_sys_stk_front_proxy: deactivated

- name: Bootstrap Frontend Base
  ansible.builtin.include_role:
    name: sys-stk-front-base

- name: "TLS | Apply tls layer"
  include_role:
    name: sys-front-tls
  when: lookup('tls', application_id, 'enabled') | bool

- name: "CSP/INJ | Apply global injections for {{ domain }}"
  ansible.builtin.include_role:
    name: sys-front-inj-all

- name: "Deploy NGINX config: '{{ domain }}' -> '{{ front_proxy_domain_conf_dst }}'"
  ansible.builtin.template:
    src: "{{ item }}"
    dest: "{{ front_proxy_domain_conf_dst }}"
  register: nginx_conf
  notify: restart openresty
  vars:
    nginx_template_candidates:
      - "{{ application_id | abs_role_path_by_application_id }}/templates/proxy.conf.j2"
      - "roles/sys-svc-proxy/templates/vhost/{{ webserver_vhost_flavour }}.conf.j2"
  with_first_found: "{{ nginx_template_candidates }}"

- block:
    - name: "Check if {{ domains | get_domain(application_id) }} is reachable (only if config unchanged)"
      ansible.builtin.uri:
        url: "{{ lookup('tls', application_id, 'url.base') }}"
      register: site_check
      failed_when: false
      changed_when: false

    - name: Restart NGINX if site is down
      ansible.builtin.command:
        cmd: "true"
      notify: restart openresty
      when:
        - site_check.status is defined
        - site_check.status not in [200, 301, 302]
  when: not nginx_conf.changed

- name: "Restart Webserver for '{{ front_proxy_domain_conf_dst }}'"
  ansible.builtin.meta: flush_handlers
