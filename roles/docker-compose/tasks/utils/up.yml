- name:           "Check if any container is running in {{ docker_compose.directories.instance }}"
  command:        docker compose ps -q --filter status=running
  args:
    chdir:        "{{ docker_compose.directories.instance }}"
  register:       docker_ps
  changed_when: >
    (docker_ps.stdout | trim) == ""
  # The failed when catches the condition when an docker compose file will be dynamicly build after the file routine
  # Also if an .env file isn't present
  failed_when: >
    docker_ps.rc != 0
    and (
      (docker_ps.stderr | default(''))
      | regex_search('(no configuration file provided|no such file or directory|env file .* not found)') is none
    )
  when: 
    - >
      not (
        docker_compose_template.changed | default(false)
        or
        env_template.changed          | default(false)
      )
    - docker_compose is defined # @todo remove in the future, non docker roles shouldn't include this file
    - (application_id | get_entity_name) == (docker_compose.directories.instance | basename)
  notify: docker compose up

- meta: flush_handlers
  when: flush_handlers | default(true) | bool