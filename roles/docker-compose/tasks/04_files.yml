- name: "Find optional Dockerfile for {{ application_id }}"
  set_fact:
    dockerfile_src: >-
      {{ lookup(
           'first_found',
           {
             'files': [
               application_id | abs_role_path_by_application_id ~ '/templates/Dockerfile.j2',
               application_id | abs_role_path_by_application_id ~ '/files/Dockerfile'
             ]
           },
           errors='ignore'
         ) | default('', true)
      }}

- name: "Create (optional) Dockerfile for {{ application_id }}"
  template:
    src:  "{{ dockerfile_src }}"
    dest: "{{ docker_compose.files.dockerfile }}"
    mode: '0640'
  notify:
    - docker compose build
    - docker compose up
  when:
    - dockerfile_src | default('') | length > 0

- name: "Create (optional) '{{ docker_compose.files.env }}'"
  template:
    src:  "{{ item }}"
    dest: "{{ docker_compose.files.env }}"
    mode: '0640'
    force: yes
  notify: docker compose up
  with_first_found:
    - files:
        - "{{ application_id | abs_role_path_by_application_id }}/templates/env.j2"
        - "{{ application_id | abs_role_path_by_application_id }}/files/env"
      skip: true

- name: "Create (optional) '{{ docker_compose.files.docker_compose_override }}'"
  template:
    src:  "{{ item }}"
    dest: "{{ docker_compose.files.docker_compose_override }}"
    mode: '0640'
    force: yes
  notify: docker compose up
  with_first_found:
    - files:
        - "{{ application_id | abs_role_path_by_application_id }}/templates/docker-compose.override.yml.j2"
        - "{{ application_id | abs_role_path_by_application_id }}/files/docker-compose.override.yml"
      skip: true

- name: "Create (optional) '{{ docker_compose.files.docker_compose }}'"
  ansible.builtin.template:
    src:  "{{ item }}"
    dest: "{{ docker_compose.files.docker_compose }}"
    mode: "0640"
    force: yes
  with_first_found:
    - files:
        - "docker-compose.yml.j2"
      skip: true
  register: docker_compose_template
  notify: docker compose up