---
- name: Validate Docker Compose configuration
  command:
    cmd: docker compose -f {{ docker_compose.files.docker_compose }} config --quiet
    chdir: "{{ docker_compose.directories.instance }}"
  register: dc_validate
  changed_when: false
  failed_when: dc_validate.rc != 0
  listen:
    - docker compose up
  when: MODE_ASSERT | bool

- name: docker compose pull
  ansible.builtin.script:
    cmd: >-
      compose_pull.py
      --chdir {{ docker_compose.directories.instance }}
      --lock-dir {{ PATH_DOCKER_COMPOSE_PULL_LOCK_DIR }}
      --lock-key {{ docker_compose.directories.instance | hash('sha1') }}
      --attempts 6
      --sleep 20
      --sleep-cap 240
      --ignore-buildable
  register: compose_pull
  changed_when: "'pulled' in compose_pull.stdout"
  environment:
    COMPOSE_HTTP_TIMEOUT: "600"
    DOCKER_CLIENT_TIMEOUT: "600"
  when: MODE_UPDATE | bool
  listen:
    - docker compose up

- name: Build docker compose
  shell: |
    set -euo pipefail
    docker compose build || { 
      echo "Retrying without cache and pulling bases...";
      docker compose build --no-cache{{ ' --pull' if MODE_UPDATE | bool else ''}}; 
    }
  args:
    chdir: "{{ docker_compose.directories.instance }}"
    executable: /bin/bash
  environment:
    COMPOSE_HTTP_TIMEOUT:   "600"
    DOCKER_CLIENT_TIMEOUT:  "600"
    # Faster build
    DOCKER_BUILDKIT: "1"
    COMPOSE_DOCKER_CLI_BUILD: "1"
  listen:
    - docker compose build

- name: docker compose up
  shell: |
    set -euo pipefail

    {% if MODE_DEBUG | bool %}
    echo ">>> [dc][DEBUG] docker compose config (FULL)" >&2
    if [ -f "{{ docker_compose.files.env }}" ]; then
      docker compose --env-file "{{ docker_compose.files.env }}" config >&2
    else
      docker compose config >&2
    fi

    {% if not MASK_CREDENTIALS_IN_LOGS | bool %}
    if [ -f "{{ docker_compose.files.env }}" ]; then
      echo ">>> [dc][DEBUG] .env (UNMASKED)" >&2
      cat "{{ docker_compose.files.env }}" >&2
    fi
    {% endif %}
    {% endif %}

    if [ -f "{{ docker_compose.files.env }}" ]; then
      docker compose -p {{ application_id | get_entity_name }} \
        --env-file "{{ docker_compose.files.env }}" \
        up -d --force-recreate --remove-orphans
    else
      docker compose -p {{ application_id | get_entity_name }} \
        up -d --force-recreate --remove-orphans
    fi
  args:
    chdir: "{{ docker_compose.directories.instance }}"
    executable: /bin/bash
  environment:
    COMPOSE_HTTP_TIMEOUT:   "600"
    DOCKER_CLIENT_TIMEOUT:  "600"
    COMPOSE_PARALLEL_LIMIT: "{{ '4' if (DOCKER_IN_CONTAINER | bool) else omit }}"
  listen:
    - docker compose up

- name: Aggressively prune Docker data (keep networks + keep in-use images)
  # Required, because otherwise the image grows too large for GitHub Actions (~14 GB).
  # Docker networks must be preserved, as they may be external and created shortly
  # before this task runs (e.g. by docker-compose or CI orchestration).
  become: true
  ansible.builtin.shell: |
    set -euo pipefail

    echo "Docker disk usage before cleanup:"
    docker system df || true

    # Keep running containers and their images -> only prune unused data
    docker container prune -f || true
    docker image prune -af || true
    docker volume prune -f || true

    # Build cache
    docker buildx prune -af || true
    docker builder prune -af || true

    echo "Docker disk usage after cleanup:"
    docker system df || true
  args:
    executable: /bin/bash
  changed_when: true
  when:
    - MODE_CLEANUP | bool
    - DOCKER_IN_CONTAINER | bool
  listen:
    - docker compose up
    - docker compose build
