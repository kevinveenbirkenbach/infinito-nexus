
- name: "Load docker service required for the 'run' command"
  include_role:
    name:   sys-svc-container
    public: false
  when: run_once_sys_svc_container is not defined

- name: Include dependency 'sys-ctl-alm-compose'
  include_role:
    name: sys-ctl-alm-compose
  when: run_once_sys_ctl_alm_compose is not defined

# Ensure the CA exists (docker-run-ca requires CA_TRUST_CERT_HOST to exist)
- name: Ensure Root CA exists
  ansible.builtin.include_role:
    name: sys-ca-selfsigned
  when: run_once_sys_ca_selfsigned is not defined

# Optional: pre-pull once at deploy time (recommended for reliability)
- name: Pull CSP checker image
  ansible.builtin.command:
    argv:
      - docker
      - pull
      - "{{ HEALTH_CSP_IMAGE }}"
  changed_when: false

- include_role:
    name: sys-service
  vars:
    system_service_force_flush_final:     true
    system_service_on_calendar:           "{{ SYS_SCHEDULE_HEALTH_CSP_CRAWLER }}"
    system_service_timer_enabled:         true
    system_service_tpl_on_failure:        "{{ SYS_SERVICE_ON_FAILURE_COMPOSE }}"
    system_service_tpl_timeout_start_sec: "{{ CURRENT_PLAY_DOMAINS_ALL | timeout_start_sec_for_domains }}"
    system_service_tpl_environment:
      - "CA_TRUST_CERT_HOST={{ CA_TRUST.cert_host }}"
      - "CA_TRUST_WRAPPER_HOST={{ BIN_CA_TRUST }}"
      - "CA_TRUST_NAME={{ CA_TRUST.trust_name }}"
    # Always run with CA trust injected via docker-run-ca (systemd env for wrapper)
    system_service_tpl_exec_start: >-
      {{
        [
          system_service_script_exec,
          '--nginx-config-dir=' ~ (
            [
              lookup('nginx','directories.configuration.servers'),
              lookup('tls', DOMAIN_PRIMARY, 'protocols.web')
            ] | path_join
          ),
          '--image=' ~ HEALTH_CSP_IMAGE,
          '--short',
          (HEALTH_CSP_ALWAYS_PULL | bool) | ternary('--always-pull', ''),
          (HEALTH_CSP_IGNORE_NETWORK_BLOCKS_FROM | length > 0) | ternary(
            '--ignore-network-blocks-from ' ~ (HEALTH_CSP_IGNORE_NETWORK_BLOCKS_FROM | join(' ')),
            ''
          )
        ]
        | reject('equalto','')
        | join(' ')
      }}

- include_tasks: utils/once/flag.yml
