- name: Include dependency 'sys-ctl-alm-compose'
  include_role:
    name: sys-ctl-alm-compose
  when: run_once_sys_ctl_alm_compose is not defined

# Optional: pre-pull once at deploy time (recommended for reliability)
- name: Pull CSP checker image
  ansible.builtin.command:
    argv:
      - docker
      - pull
      - "{{ HEALTH_CSP_IMAGE }}"
  changed_when: false
  when: MODE_UPDATE | bool

- include_role:
    name: sys-service
  vars:
    system_service_suppress_flush:        true
    system_service_on_calendar:           "{{ SYS_SCHEDULE_HEALTH_CSP_CRAWLER }}"
    system_service_timer_enabled:         true
    system_service_tpl_on_failure:        "{{ SYS_SERVICE_ON_FAILURE_COMPOSE }}"
    system_service_tpl_timeout_start_sec: "{{ CURRENT_PLAY_DOMAINS_ALL | timeout_start_sec_for_domains }}"
    system_service_tpl_exec_start: >-
      {{ system_service_script_exec }}
      --nginx-config-dir={{ NGINX.DIRECTORIES.HTTP.SERVERS }}
      --image={{ HEALTH_CSP_IMAGE }}
      --short
      {% if HEALTH_CSP_ALWAYS_PULL | bool %} --always-pull{% endif %}
      {% if (HEALTH_CSP_IGNORE_NETWORK_BLOCKS_FROM | length) > 0 %}
      --ignore-network-blocks-from {{ HEALTH_CSP_IGNORE_NETWORK_BLOCKS_FROM | join(' ') }}
      {% endif %}

- include_tasks: utils/once/flag.yml
