- include_tasks: utils/once/flag.yml

- name: Enable EPEL repository on EL distributions
  package:
    name: epel-release
    state: present
  when: ansible_distribution in SYS_SVC_MAIL_MSMTP_EPEL_DISTRIBUTIONS

- name: Install msmtp base package
  package:
    name: "{{ SYS_SVC_MAIL_MSMTP_PACKAGES.base }}"
    state: present

- name: "Disable SMTP to avoid port conflicts"
  include_tasks: "{{ [playbook_dir, 'roles/sys-svc-mail-smtp/tasks/disable.yml' ] | path_join }}"

- name: Install msmtp-mta when Mailu is used and package exists on distro
  package:
    name: "{{ SYS_SVC_MAIL_MSMTP_PACKAGES.mta }}"
    state: present
  when:
    - SYSTEM_EMAIL_EXTERNAL | bool
    - SYS_SVC_MAIL_MSMTP_PACKAGES.mta

- name: Provide sendmail compatibility link when msmtp-mta is unavailable
  file:
    src: /usr/bin/msmtp
    dest: /usr/bin/sendmail
    state: link
    force: true
  when:
    - SYSTEM_EMAIL_EXTERNAL | bool
    - not SYS_SVC_MAIL_MSMTP_PACKAGES.mta

- name: configure msmtprc.conf.j2
  template:
    src: "msmtprc.conf.j2"
    dest: "/root/.msmtprc"
    mode: 600

- include_role:
    name: sys-ctl-hlth-msmtp
  when: run_once_sys_ctl_hlth_msmtp is not defined
