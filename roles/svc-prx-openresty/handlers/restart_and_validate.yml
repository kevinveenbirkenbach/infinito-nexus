- name: Validate OpenResty configuration (Pre-Flight-Check)
  command: >
    docker exec {{ OPENRESTY_CONTAINER }} openresty -t -q
  register: openresty_test_pre
  changed_when: false
  failed_when: >
    openresty_test_pre.rc != 0 and
    ('is not running' not in ((openresty_test_pre.stderr | default('')) | lower)) and
    ('no such container' not in ((openresty_test_pre.stderr | default('')) | lower)) and
    ('is restarting' not in ((openresty_test_pre.stderr | default('')) | lower))

- name: Restart OpenResty container
  command: docker restart {{ OPENRESTY_CONTAINER }}
  register: openresty_restart
  changed_when: true
  failed_when: >
    openresty_restart.rc != 0 and
    ('is not running' not in ((openresty_restart.stderr | default('')) | lower)) and
    ('no such container' not in ((openresty_restart.stderr | default('')) | lower))
