- name: Restart and validate OpenResty
  block:

    - name: Validate OpenResty configuration (Pre-Flight-Check)
      command: >
        docker exec {{ OPENRESTY_CONTAINER }} openresty -t -q
      register: openresty_test_pre
      changed_when: false
      failed_when: >
        openresty_test_pre.rc != 0 and
        ('is not running' not in ((openresty_test_pre.stderr | default('')) | lower)) and
        ('no such container' not in ((openresty_test_pre.stderr | default('')) | lower)) and
        ('is restarting' not in ((openresty_test_pre.stderr | default('')) | lower))

    - name: Restart OpenResty container
      command: docker restart {{ OPENRESTY_CONTAINER }}
      register: openresty_restart
      changed_when: true
      failed_when: >
        openresty_restart.rc != 0 and
        ('is not running' not in ((openresty_restart.stderr | default('')) | lower)) and
        ('no such container' not in ((openresty_restart.stderr | default('')) | lower))

    - name: Wait until OpenResty container is running
      command: >
        docker inspect -f '{{ "{{.State.Running}}" }}' {{ OPENRESTY_CONTAINER }}
      register: openresty_running
      changed_when: false
      until: openresty_running.stdout | trim == "true"
      retries: 24
      delay: 5
      when: MODE_ASSERT | bool

    - name: Validate OpenResty configuration (Post-Flight-Check)
      command: >
        docker exec {{ OPENRESTY_CONTAINER }} openresty -t -q
      register: openresty_test_post
      changed_when: false
      failed_when: openresty_test_post.rc != 0
      when: MODE_ASSERT | bool

  rescue:
    - name: Dump OpenResty container logs on failure
      command: >
        docker logs --tail=200 {{ OPENRESTY_CONTAINER }}
      register: openresty_logs
      changed_when: false
      failed_when: false

    - name: Show OpenResty logs
      debug:
        msg: |
          ===== OpenResty container logs (last 200 lines) =====
          {{ openresty_logs.stdout | default('') }}
          {{ openresty_logs.stderr | default('') }}

    - name: Fail explicitly after dumping logs
      fail:
        msg: >
          OpenResty failed to start or validate.
          Logs were printed above.
