---
- name: Wait until OpenResty container is running
  command: docker inspect -f '{{.State.Running}}' {{ OPENRESTY_CONTAINER }}
  register: openresty_status
  retries: 10
  delay: 3
  until: openresty_status.stdout.strip() == "true"
  changed_when: false
  listen: restart openresty

- name: Validate OpenResty configuration
  command: >
    docker exec {{ OPENRESTY_CONTAINER }} openresty -t -q
  register: openresty_test
  changed_when: false
  failed_when: >
    openresty_test.rc != 0 and
    ('is not running' not in ((openresty_test.stderr | default('')) | lower)) and
    ('no such container' not in ((openresty_test.stderr | default('')) | lower))
  listen: restart openresty

- name: Restart OpenResty container
  command: docker restart {{ OPENRESTY_CONTAINER }}
  listen: restart openresty
