# Keep in mind to don't use inj_enabled. 
- name: "Check if Matomo endpoint is reachable"
  uri:
    url: "{{ lookup('tls_resolve', 'web-app-matomo', 'url.base') }}"
    method: HEAD
    validate_certs: yes
    status_code: 200
  register: matomo_reachability
  failed_when: false
  changed_when: false
  when:
    - application_id != 'web-app-matomo'
    - run_once_web_app_matomo is not defined

- name: "Load Matomo (Once)"
  include_tasks: "utils/load_app.yml"
  when: >
    (matomo_reachability.status | default(0) | int) != 200 or
    (users.administrator.tokens['web-app-matomo'] | default('') | string | trim) == ""
  vars:
    load_app_id: 'web-app-matomo'

# Matomo can't use this dependencies - At least not on the initial setup run
- when:
    - application_id != 'web-app-matomo'
  block:
    - name: "Load CDN (Once)"
      include_tasks: "utils/load_app.yml"
      when:
        - application_id != 'web-svc-cdn'
        - run_once_web_svc_cdn is not defined
      vars:
        load_app_id: 'web-svc-cdn'

    - name: "Load Logout (Once)"
      include_tasks: "utils/load_app.yml"
      when: 
        - run_once_web_svc_logout is not defined
        - application_id != 'web-svc-logout'
      vars:
        load_app_id: 'web-svc-logout'
