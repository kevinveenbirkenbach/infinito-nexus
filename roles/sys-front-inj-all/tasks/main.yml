- block:
    - name: Include dependency 'sys-svc-webserver-core'
      include_role:
        name: sys-svc-webserver-core
      when: run_once_sys_svc_webserver_core is not defined
    - include_tasks: utils/run_once.yml
  when: run_once_sys_front_inj_all is not defined

- name: Build inj_enabled
  set_fact:
    inj_enabled: "{{ applications | inj_enabled(application_id, SRV_WEB_INJ_COMP_FEATURES_ALL) }}"

- name: "Included dependent services"
  include_tasks: 01_dependencies.yml
  vars:
    proxy_extra_configuration: ""

- name: Reinitialize 'inj_enabled' for '{{ domain }}', after loading the required webservices
  set_fact:
    inj_enabled: "{{ applications | inj_enabled(application_id, SRV_WEB_INJ_COMP_FEATURES_ALL) }}"
    inj_head_features: "{{ SRV_WEB_INJ_COMP_FEATURES_ALL | inj_features('head') }}"
    inj_body_features: "{{ SRV_WEB_INJ_COMP_FEATURES_ALL | inj_features('body') }}"

- name: "Load CDN Service for '{{ domain }}'"
  include_role:
    name: sys-svc-cdn
    public: true

- name: "Activate logout proxy for '{{ domain }}'"
  include_role:
    name: sys-front-inj-logout
    public: true
  when: inj_enabled.logout

- name: "Activate Desktop iFrame notifier for '{{ domain }}'"
  include_role:
    name:   sys-front-inj-desktop
    public: true
  when: inj_enabled.desktop

- name: "Activate Corporate CSS for '{{ domain }}'"
  include_role:
    name: sys-front-inj-css
  when: inj_enabled.css

- name: "Activate Matomo Tracking for '{{ domain }}'"
  include_role:
    name: sys-front-inj-matomo
  when: inj_enabled.matomo

- name: "Activate Javascript for '{{ domain }}'"
  include_role:
    name: sys-front-inj-javascript
  when: inj_enabled.javascript
