- name: Build inj_enabled
  set_fact:
    inj_enabled: "{{ applications | inj_enabled(application_id, SRV_WEB_INJ_COMP_FEATURES_ALL) }}"

- name: "Load CDN Service for '{{ domain }}'"
  include_role:
    name: sys-svc-cdn
    public: true # Expose variables so that they can be used in all injection roles

- name: Reinitialize 'inj_enabled' for '{{ domain }}', after modification by CDN
  set_fact:
    inj_enabled: "{{ applications | inj_enabled(application_id, SRV_WEB_INJ_COMP_FEATURES_ALL) }}"
    inj_head_features: "{{ SRV_WEB_INJ_COMP_FEATURES_ALL | inj_features('head') }}"
    inj_body_features: "{{ SRV_WEB_INJ_COMP_FEATURES_ALL | inj_features('body') }}"

- name: "Activate Desktop iFrame notifier for '{{ domain }}'"
  include_role:
    name:   sys-front-inj-desktop
    public: true # Vars used in templates
  when: inj_enabled.desktop

- name: "Activate Corporate CSS for '{{ domain }}'"
  include_role:
    name: sys-front-inj-css
  when: inj_enabled.css

- name: "Activate Matomo Tracking for '{{ domain }}'"
  include_role:
    name: sys-front-inj-matomo
  when: inj_enabled.matomo

- name: "Activate Javascript for '{{ domain }}'"
  include_role:
    name: sys-front-inj-javascript
  when: inj_enabled.javascript

- name: "Activate logout proxy for '{{ domain }}'"
  include_role:
    name: sys-front-inj-logout
    public: true # Vars used in templates
  when: inj_enabled.logout

- block:
  - name: Include dependency 'sys-svc-webserver'
    include_role:
      name: sys-svc-webserver
    when: run_once_sys_svc_webserver is not defined
  - include_tasks: utils/run_once.yml
  when: run_once_sys_front_inj_all is not defined