name: Mirror Docker Hub images to GHCR (only missing)

on:
  workflow_call:
    inputs:
      ghcr_namespace:
        description: "GHCR namespace/org (default: repository owner)"
        required: false
        type: string
      ghcr_prefix:
        description: "GHCR repo prefix (default: mirror)"
        required: false
        type: string
        default: "mirror"
      repo_root:
        description: "Repository root path (default: .)"
        required: false
        type: string
        default: "."
      images_per_hour:
        description: "Optional throttle: max images mirrored per hour"
        required: false
        type: string
        default: ""
    secrets:
      DOCKERHUB_USERNAME:
        required: false
      DOCKERHUB_TOKEN:
        required: false

permissions:
  contents: read
  packages: write

concurrency:
  group: mirror-images-${{ github.repository }}-${{ github.ref_name }}
  # Cancel scheduled Mirror sync, because may it works with outdatet mirror lists
  cancel-in-progress: true

jobs:
  sync:
    name: ðŸªž Mirror missing images
    runs-on: ubuntu-latest

    # Copy secrets/inputs into env so we can reference them in "if:" (env.* is allowed there)
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      IMAGES_PER_HOUR: ${{ inputs.images_per_hour || '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install PyYAML

      - name: Install skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      # Optional: Docker Hub login to avoid rate limits while mirroring
      - name: Login to Docker Hub (optional)
        if: ${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Mirror images to GHCR (only missing, best-effort)
        shell: bash
        run: |
          set -euo pipefail

          GHCR_NAMESPACE="${{ inputs.ghcr_namespace || github.repository_owner }}"
          GHCR_PREFIX="${{ inputs.ghcr_prefix || 'mirror' }}"
          REPO_ROOT="${{ inputs.repo_root || '.' }}"

          echo ">>> Mirror namespace: ${GHCR_NAMESPACE}"
          echo ">>> Mirror prefix:    ${GHCR_PREFIX}"
          echo ">>> Repo root:        ${REPO_ROOT}"
          echo ">>> Mode:             only-missing"
          echo ">>> Throttle:         ${IMAGES_PER_HOUR:-<disabled>} images/hour"

          EXTRA_ARGS=()
          if [ -n "${IMAGES_PER_HOUR:-}" ]; then
            EXTRA_ARGS+=( --images-per-hour "${IMAGES_PER_HOUR}" )
          fi

          python -m cli.mirror.sync \
            --repo-root "${REPO_ROOT}" \
            --ghcr-namespace "${GHCR_NAMESPACE}" \
            --ghcr-prefix "${GHCR_PREFIX}" \
            --only-missing \
            "${EXTRA_ARGS[@]}"

          echo ">>> Mirror sync finished."
