name: Mark stable commit

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'

jobs:
  lint-ansible:
    uses: ./.github/workflows/lint-ansible.yml
  lint-docker:
    uses: ./.github/workflows/lint-docker.yml
  lint-python:
    uses: ./.github/workflows/lint-python.yml
  lint-shell:
    uses: ./.github/workflows/lint-shell.yml
  security-codeql:
    uses: ./.github/workflows/security-codeql.yml
  test-code-integration:
    uses: ./.github/workflows/test-code-integration.yml
  test-code-lint:
    uses: ./.github/workflows/test-code-lint.yml
  test-code-unit:
    uses: ./.github/workflows/test-code-unit.yml
  test-deploy-server:
    uses: ./.github/workflows/test-deploy-server.yml
  test-deploy-universal:
    uses: ./.github/workflows/test-deploy-universal.yml
  test-deploy-workstation:
    uses: ./.github/workflows/test-deploy-workstation.yml
  test-install-make:
    uses: ./.github/workflows/test-install-make.yml
  test-install-pkgmgr:
    uses: ./.github/workflows/test-install-pkgmgr.yml
  mark-stable:
    needs:
      - lint-python
      - lint-shell
      - lint-docker
      - security-codeql
      - test-code-integration
      - test-code-lint
      - test-code-unit
      - test-deploy-server
      - test-deploy-universal
      - test-deploy-workstation
      - test-install-make
      - test-install-pkgmgr
    runs-on: ubuntu-latest

    # Only run this job if the push is for a version tag (v*)
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write  # Required to move/update the tag

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true  # We need all tags for version comparison

      - name: Move 'stable' tag only if this version is the highest
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "Ref: $GITHUB_REF"
          echo "SHA: $GITHUB_SHA"

          VERSION="${GITHUB_REF#refs/tags/}"
          echo "Current version tag: ${VERSION}"

          echo "Collecting all version tags..."
          ALL_V_TAGS="$(git tag --list 'v*' || true)"

          if [[ -z "${ALL_V_TAGS}" ]]; then
            echo "No version tags found. Skipping stable update."
            exit 0
          fi

          echo "All version tags:"
          echo "${ALL_V_TAGS}"

          # Determine highest version using natural version sorting
          LATEST_TAG="$(printf '%s\n' ${ALL_V_TAGS} | sort -V | tail -n1)"

          echo "Highest version tag: ${LATEST_TAG}"

          if [[ "${VERSION}" != "${LATEST_TAG}" ]]; then
            echo "Current version ${VERSION} is NOT the highest version."
            echo "Stable tag will NOT be updated."
            exit 0
          fi

          echo "Current version ${VERSION} IS the highest version."
          echo "Updating 'stable' tag..."

          # Delete existing stable tag (local + remote)
          git tag -d stable 2>/dev/null || true
          git push origin :refs/tags/stable || true

          # Create new stable tag
          git tag stable "$GITHUB_SHA"
          git push origin stable

          echo "âœ… Stable tag updated to ${VERSION}."
