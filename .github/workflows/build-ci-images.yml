name: Build CI images (all distros)

on:
  workflow_call:
    inputs:
      distros:
        description: "Space-separated distro list"
        required: true
        type: string

permissions:
  contents: read
  packages: write

concurrency:
  group: infinito-build-${{ github.ref }}
  cancel-in-progress: false

jobs:
  prepare:
    name: ðŸ·ï¸ Label images
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.out.outputs.matrix }}
      image_tag: ci-${{ github.sha }}
    steps:
      - name: Install jq
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Compute matrix JSON
        id: out
        run: |
          set -euo pipefail
          distros="${{ inputs.distros }}"
          json="$(printf '%s' "$distros" | jq -Rc 'split(" ") | map(select(length>0))')"
          echo "matrix=${json}" >> "$GITHUB_OUTPUT"
          echo "Using matrix: ${json}"

  build:
    name: "build: ${{ matrix.distro }}-${{ matrix.variant }}"
    needs: prepare
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        distro: ${{ fromJson(needs.prepare.outputs.matrix) }}
        variant: 
          - full
          # - slim ; It doesn't make sense in this configuration, because it allways uses the full size parents layers
 
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Disk pressure (start)
        shell: bash
        run: |
          set -euo pipefail
          echo "=== Disk pressure: START ==="
          echo "Runner: $(uname -a)"
          echo
          df -h
          echo
          docker version || true
          echo
          docker system df || true
          echo
          docker buildx version || true
          echo
          docker buildx du || true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          install: true

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Disk pressure (pre-build)
        shell: bash
        run: |
          set -euo pipefail
          echo "=== Disk pressure: PRE-BUILD ==="
          df -h
          echo
          docker system df || true
          echo
          docker buildx du || true

      - name: Compute image names
        id: names
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ matrix.variant }}" == "slim" ]]; then
            echo "suffix=-slim" >> "$GITHUB_OUTPUT"
          else
            echo "suffix=" >> "$GITHUB_OUTPUT"
          fi
      - name: Build & push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          target: ${{ matrix.variant }}
          tags: |
            ghcr.io/${{ github.repository_owner }}/infinito-${{ matrix.distro }}${{ steps.names.outputs.suffix }}:${{ needs.prepare.outputs.image_tag }}
          build-args: |
            PKGMGR_IMAGE=ghcr.io/kevinveenbirkenbach/pkgmgr-${{ matrix.distro }}${{ steps.names.outputs.suffix }}:stable
            NIX_CONFIG=access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
          cache-from: type=gha,scope=infinito-${{ matrix.distro }}-${{ matrix.variant }}
          cache-to: type=gha,mode=max,scope=infinito-${{ matrix.distro }}-${{ matrix.variant }}

      - name: Disk pressure (post-build)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo "=== Disk pressure: POST-BUILD ==="
          df -h
          echo
          docker system df || true
          echo
          docker buildx du || true

      - name: Cleanup (always)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo "=== Cleanup ==="
          docker buildx prune -af || true
          docker builder prune -af || true
          docker image prune -af || true
          docker container prune -f || true
          echo
          echo "=== Disk pressure: AFTER CLEANUP ==="
          df -h
          echo
          docker system df || true
          docker buildx du || true
