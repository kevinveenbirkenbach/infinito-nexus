name: CI Orchestrator
on:
  workflow_call:
    inputs:
      distros:
        description: "Space-separated distro list"
        required: false
        type: string
        default: "arch debian ubuntu fedora centos"
      whitelist:
        description: "Optional space-separated whitelist of app ids"
        required: false
        type: string
        default: ""

concurrency:
  group: infinito-test-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  packages: write
  security-events: write

jobs:
  # Security Checks
  security-codeql:
    uses: ./.github/workflows/security-codeql.yml

  # Linting
  lint-ansible:
    uses: ./.github/workflows/lint-ansible.yml
  lint-docker:
    uses: ./.github/workflows/lint-docker.yml
  lint-python:
    uses: ./.github/workflows/lint-python.yml
  lint-shell:
    uses: ./.github/workflows/lint-shell.yml
  lint-gate:
    name: üö¶ Gate lint
    needs: [lint-ansible, lint-python, lint-docker, lint-shell]
    runs-on: ubuntu-latest
    steps:
      - run: echo "lint gate passed"

  # Build Docker Images 
  build-ci-images:
    uses: ./.github/workflows/build-ci-images.yml
    with:
      distros: "arch debian ubuntu fedora centos"

  # Code Testing
  test-code-integration:
    uses: ./.github/workflows/test-code-integration.yml
    needs: build-ci-images
  test-code-lint:
    uses: ./.github/workflows/test-code-lint.yml
    needs: build-ci-images
  test-code-unit:
    uses: ./.github/workflows/test-code-unit.yml 
    needs: build-ci-images
  test-code-gate:
    name: üö¶ Gate code
    needs: [test-code-integration, test-code-lint, test-code-unit]
    runs-on: ubuntu-latest
    steps:
      - run: echo "code gate passed"

  # Gate for the code Quality
  code-quality-gate:
    needs: [lint-gate, test-code-gate, security-codeql]
    runs-on: ubuntu-latest
    steps:
      - run: echo "Quality Checks passed"
  
  # Test DNS configuration
  test-dns:
    needs: 
      - build-ci-images
      - code-quality-gate
    uses: ./.github/workflows/test-dns.yml
    with:
      distros: "arch debian ubuntu fedora centos"
  
  # Sync Missing Images
  images-mirror-missing:
    uses: ./.github/workflows/images-mirror-missing.yml
    secrets: inherit

  # Deploy tests

  test-deploy-server:
    needs:
      - test-dns
      - images-mirror-missing
    uses: ./.github/workflows/test-deploy-server.yml
    with:
      distros: ${{ inputs.distros }}
      whitelist: ${{ inputs.whitelist }}

  test-deploy-universal:
    needs:
      - test-dns
      - images-mirror-missing
    uses: ./.github/workflows/test-deploy-universal.yml
    with:
      distros: ${{ inputs.distros }}
      whitelist: ${{ inputs.whitelist }}

  test-deploy-workstation:
    needs:
      - code-quality-gate
      - build-ci-images
    uses: ./.github/workflows/test-deploy-workstation.yml
    with:
      distros: ${{ inputs.distros }}
      whitelist: ${{ inputs.whitelist }}

  # Test Installation
  test-install-make:
    uses: ./.github/workflows/test-install-make.yml
    needs:
      - code-quality-gate
  test-install-pkgmgr:
    uses: ./.github/workflows/test-install-pkgmgr.yml
    needs:
      - code-quality-gate
  test-install-gate:
    name: üö¶ Gate installation
    needs: [test-install-make, test-install-pkgmgr]
    runs-on: ubuntu-latest
    steps:
      - run: echo "Installation is possible via pkgmgr and make"

  done:
    name: üèÅ Finish pipeline
    needs:
      - test-deploy-server
      - test-deploy-universal
      - test-deploy-workstation
      - test-install-gate
    runs-on: ubuntu-latest
    steps:
      - name: Done
        run: echo "All checks passed."
