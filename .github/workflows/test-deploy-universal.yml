# .github/workflows/test-deploy-universal.yml
name: Test Infinito.Nexus Deploy (universal)

on:
  workflow_call:
  workflow_dispatch:

permissions:
  contents: read
  packages: read

env:
  MODE: universal
  DISTROS: "arch debian ubuntu fedora centos"
  ONLY_APP: ""
  MISSING_ONLY: "true"
  NIX_CONFIG: |
    access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

jobs:
  discover:
    name: discover apps (arch)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      apps: ${{ steps.discover.outputs.apps }}

    steps:
      - uses: actions/checkout@v6

      - name: Install jq
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Start stack for discovery (arch)
        shell: bash
        run: |
          set -euo pipefail
          make up

      - name: Discover apps (JSON)
        id: discover
        shell: bash
        run: |
          set -euo pipefail
          apps="$(MODE="${MODE}" scripts/ci/discover.sh)"
          [[ -n "${apps}" ]] || apps='[]'

          if [[ -n "${ONLY_APP}" ]]; then
            apps="$(jq -nc --arg a "${ONLY_APP}" '[ $a ]')"
          fi

          echo "apps=${apps}" >> "$GITHUB_OUTPUT"
          echo "apps_json=${apps}"

  universal:
    name: deploy:universal (${{ matrix.app }})
    runs-on: ubuntu-latest
    timeout-minutes: 240
    needs: discover

    strategy:
      fail-fast: false
      matrix:
        app: ${{ fromJson(needs.discover.outputs.apps) }}

    steps:
      - uses: actions/checkout@v6

      - name: Install jq
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Start stack (arch)
        shell: bash
        run: |
          set -euo pipefail
          make up

      - name: Deploy app
        shell: bash
        run: |
          set -euo pipefail

          normalize_bool() {
            case "${1:-}" in
              true|True|TRUE|1) echo "true" ;;
              false|False|FALSE|0) echo "false" ;;
              *) echo "true" ;;
            esac
          }

          export MODE="universal"
          export DISTROS="${DISTROS}"
          export MISSING_ONLY="$(normalize_bool "${MISSING_ONLY}")"
          export APP="${{ matrix.app }}"

          scripts/ci/deploy-one-app.sh

      - name: Show last 200 log lines on failure
        if: failure()
        shell: bash
        run: |
          scripts/ci/log-tail.sh logs 200

      - name: Upload deploy logs
        if: ${{ always() && env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: deploy-logs-universal-${{ matrix.app }}
          path: logs/
          if-no-files-found: warn
          retention-days: 14
