name: CI (Push)

concurrency:
  group: global-ci-${{ github.repository }}-${{ github.ref_name }}
  cancel-in-progress: false

on:
  push:
    branches:
      - "**"

permissions:
  contents: read
  packages: write
  security-events: write

jobs:
  pick-distro:
    name: ðŸŽ² Pick distro(s)
    runs-on: ubuntu-latest
    outputs:
      distros: ${{ steps.pick.outputs.distros }}
    steps:
      - id: pick
        shell: bash
        run: |
          set -euo pipefail

          ALL_DISTROS=(arch debian ubuntu fedora centos)

          # If this is a version tag push like v1.2.3 -> run all distros
          if [[ "${GITHUB_REF_TYPE}" == "tag" && "${GITHUB_REF_NAME}" =~ ^v[0-9]+(\.[0-9]+)*$ ]]; then
            distros="${ALL_DISTROS[*]}"
            echo "ðŸŽ¯ Version tag detected (${GITHUB_REF_NAME}) â†’ running ALL distros"
          else
            # Otherwise (branch push) -> pick exactly one random distro
            one="$(printf "%s\n" "${ALL_DISTROS[@]}" | shuf -n 1)"
            distros="${one}"
            echo "ðŸŽ² Branch push â†’ picked distro: ${one}"
          fi

          echo "distros=${distros}" >> "$GITHUB_OUTPUT"
          echo "=== Selected distros: ${distros} ==="

  ci-orchestrator:
    name: ðŸŽ¶ Orchestra CI/CD
    needs: pick-distro
    uses: ./.github/workflows/ci-orchestrator.yml
    with:
      # ci-orchestrator expects a space-separated list â†’ here it's either one or many
      distros: ${{ needs.pick-distro.outputs.distros }}
