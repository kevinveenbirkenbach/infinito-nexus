name: CI (Push)

concurrency:
  group: global-ci-${{ github.repository }}-${{ github.ref_name }}
  cancel-in-progress: false

on:
  push:
    branches:
      - "**"
    tags:
      - "v*"

permissions:
  contents: write
  packages: write
  actions: read
  security-events: write

jobs:
  pick-distro:
    name: ðŸŽ² Pick distro(s)
    runs-on: ubuntu-latest
    outputs:
      distros: ${{ steps.pick.outputs.distros }}
    steps:
      - id: pick
        shell: bash
        run: |
          set -euo pipefail

          ALL_DISTROS=(arch debian ubuntu fedora centos)

          # If this is a version tag push like v1.2.3 -> run all distros
          if [[ "${GITHUB_REF_TYPE}" == "tag" && "${GITHUB_REF_NAME}" =~ ^v[0-9]+(\.[0-9]+)*$ ]]; then
            distros="${ALL_DISTROS[*]}"
            echo "ðŸŽ¯ Version tag detected (${GITHUB_REF_NAME}) â†’ running ALL distros"
          else
            # Otherwise (branch push) -> pick exactly one random distro
            one="$(printf "%s\n" "${ALL_DISTROS[@]}" | shuf -n 1)"
            distros="${one}"
            echo "ðŸŽ² Branch push â†’ picked distro: ${one}"
          fi

          echo "distros=${distros}" >> "$GITHUB_OUTPUT"
          echo "=== Selected distros: ${distros} ==="

  ci-orchestrator:
    name: ðŸŽ¶ Orchestra CI/CD
    needs: pick-distro
    uses: ./.github/workflows/ci-orchestrator.yml
    with:
      # ci-orchestrator expects a space-separated list â†’ here it's either one or many
      distros: ${{ needs.pick-distro.outputs.distros }}
    secrets: inherit

  # Guard job: only allow version releases if the tag commit is contained in origin/master
  release-guard:
    name: "ðŸ›¡ï¸ Guard release"
    if: startsWith(github.ref, 'refs/tags/v')
    needs: ci-orchestrator
    runs-on: ubuntu-latest
    outputs:
      allowed: ${{ steps.guard.outputs.allowed }}
    steps:
      - name: Checkout (with full history)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Fetch master
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin master:refs/remotes/origin/master --force

      - name: "Guard: tag commit must be contained in origin/master"
        id: guard
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME}"
          tag_sha="$(git rev-list -n 1 "${tag}")"
          echo "Tag: ${tag} -> ${tag_sha}"

          if git merge-base --is-ancestor "${tag_sha}" "origin/master"; then
            echo "allowed=true" >> "$GITHUB_OUTPUT"
            echo "âœ… Tag commit is on origin/master"
          else
            echo "allowed=false" >> "$GITHUB_OUTPUT"
            echo "â›” Tag commit is NOT on origin/master"
          fi

  release-version:
    name: ðŸš€ Release version
    needs: release-guard
    if: needs.release-guard.outputs.allowed == 'true'
    uses: ./.github/workflows/release-version.yml
    with:
      tag: ${{ github.ref_name }}
    secrets: inherit
