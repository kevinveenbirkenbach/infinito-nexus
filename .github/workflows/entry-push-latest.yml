name: CI (Push)

concurrency:
  group: global-ci-${{ github.repository }}-${{ github.ref_name }}
  cancel-in-progress: false

on:
  push:
    branches:
      - master
      - main
      - "feature/**"
      - "hotfix/**"

permissions:
  contents: write
  packages: write
  actions: read
  security-events: write

jobs:
  pick-distro:
    if: github.event.created == false
    name: ðŸŽ² Pick distro(s)
    runs-on: ubuntu-latest
    outputs:
      distros: ${{ steps.pick.outputs.distros }}
      is_version: ${{ steps.pick.outputs.is_version }}
      version_tag: ${{ steps.pick.outputs.version_tag }}
    steps:
      - name: Checkout (with tags)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - id: pick
        shell: bash
        run: |
          set -euo pipefail

          ALL_DISTROS=(arch debian ubuntu fedora centos)

          version_tag="$(
            git tag --points-at "${GITHUB_SHA}" \
              | grep -E '^v[0-9]+(\.[0-9]+)*$' \
              | head -n 1 || true
          )"

          if [[ -n "${version_tag}" ]]; then
            echo "is_version=true" >> "$GITHUB_OUTPUT"
            echo "version_tag=${version_tag}" >> "$GITHUB_OUTPUT"
            distros="${ALL_DISTROS[*]}"
            echo "ðŸŽ¯ Commit ${GITHUB_SHA} has version tag ${version_tag} â†’ running ALL distros"
          else
            echo "is_version=false" >> "$GITHUB_OUTPUT"
            echo "version_tag=" >> "$GITHUB_OUTPUT"
            one="$(printf "%s\n" "${ALL_DISTROS[@]}" | shuf -n 1)"
            distros="${one}"
            echo "ðŸŽ² No version tag on commit â†’ picked distro: ${one}"
          fi

          echo "distros=${distros}" >> "$GITHUB_OUTPUT"
          echo "=== Selected distros: ${distros} ==="
          echo "=== is_version: $(grep -E '^is_version=' "$GITHUB_OUTPUT" | tail -n 1) ==="
          echo "=== version_tag: $(grep -E '^version_tag=' "$GITHUB_OUTPUT" | tail -n 1) ==="

  ci-orchestrator:
    if: github.event.created == false
    name: ðŸŽ¶ Orchestrate CI
    needs: pick-distro
    uses: ./.github/workflows/ci-orchestrator.yml
    with:
      # ci-orchestrator expects a space-separated list â†’ here it's either one or many
      distros: ${{ needs.pick-distro.outputs.distros }}
    secrets: inherit

  # Guard job: only allow version releases if the tag commit is contained in origin/master
  release-guard:
    name: "ðŸ›¡ï¸ Guard release"
    if: github.event.created == false && needs.pick-distro.outputs.is_version == 'true'
    needs:
      - pick-distro
      - ci-orchestrator
    runs-on: ubuntu-latest
    outputs:
      allowed: ${{ steps.guard.outputs.allowed }}
    steps:
      - name: Checkout (with full history)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Fetch master
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin master:refs/remotes/origin/master --force

      - name: "Guard: tag commit must be contained in origin/master"
        id: guard
        shell: bash
        env:
          VERSION_TAG: ${{ needs.pick-distro.outputs.version_tag }}
        run: |
          set -euo pipefail

          if [[ -z "${VERSION_TAG}" ]]; then
            echo "allowed=false" >> "$GITHUB_OUTPUT"
            echo "â›” No version tag detected for this commit"
            exit 0
          fi

          tag="${VERSION_TAG}"
          tag_sha="$(git rev-list -n 1 "${tag}")"
          echo "Tag: ${tag} -> ${tag_sha}"

          if git merge-base --is-ancestor "${tag_sha}" "origin/master"; then
            echo "allowed=true" >> "$GITHUB_OUTPUT"
            echo "âœ… Tag commit is on origin/master"
          else
            echo "allowed=false" >> "$GITHUB_OUTPUT"
            echo "â›” Tag commit is NOT on origin/master"
          fi

  release-version:
    name: ðŸš€ Release version
    needs:
      - pick-distro
      - release-guard
    if: github.event.created == false && needs.release-guard.outputs.allowed == 'true'
    uses: ./.github/workflows/release-version.yml
    with:
      tag: ${{ needs.pick-distro.outputs.version_tag }}
    secrets: inherit
