name: Test Infinito.Nexus Deploy

on:
  workflow_call:
    inputs:
      only_app:
        type: string
        required: false
        default: ''
      only_distro:
        type: string
        required: false
        default: ''
      mode:
        type: string
        required: true
        description: "server | workstation | rest"
      distros:
        type: string
        required: false
        default: 'arch debian ubuntu fedora centos'
      tested_lifecycles:
        type: string
        required: false
        default: 'alpha beta rc stable'
      missing_only:
        type: boolean
        required: false
        default: true
      keep_stack_on_failure:
        type: boolean
        required: false
        default: true

      server_include_re:
        type: string
        required: false
        default: '^(web-app-|web-svc-)'
      server_exclude_re:
        type: string
        required: false
        default: '^(web-app-oauth2-proxy)$'

      workstation_include_re:
        type: string
        required: false
        default: '^(desk-|util-desk-)'
      workstation_exclude_re:
        type: string
        required: false
        default: ''

      final_exclude_re:
        type: string
        required: false
        default: ''

  workflow_dispatch:
    inputs:
      mode:
        description: "server | workstation | rest"
        required: true
        default: "server"
      distros:
        description: "space-separated list"
        required: true
        default: "arch debian ubuntu fedora centos"
      tested_lifecycles:
        description: "space or comma separated"
        required: true
        default: "alpha beta rc stable"

      only_app:
        description: "optional: run only this app"
        required: false
        default: ""
      only_distro:
        description: "optional: run only this distro"
        required: false
        default: ""

      missing_only:
        description: "build only if missing"
        required: false
        default: "true"
      keep_stack_on_failure:
        description: "keep stack up on failure"
        required: false
        default: "true"

      server_include_re:
        description: "regex include for server discovery"
        required: false
        default: "^(web-app-|web-svc-)"
      server_exclude_re:
        description: "regex exclude for server discovery"
        required: false
        default: "^(web-app-oauth2-proxy)$"

      workstation_include_re:
        description: "regex include for workstation discovery"
        required: false
        default: "^(desk-|util-desk-)"
      workstation_exclude_re:
        description: "regex exclude for workstation discovery"
        required: false
        default: ""

      final_exclude_re:
        description: "final grep -Ev regex after selection"
        required: false
        default: ""

permissions:
  contents: read
  packages: read

jobs:
  discover:
    name: Discover apps
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      apps: ${{ steps.discover.outputs.apps }}
      deploy_type: ${{ steps.discover.outputs.deploy_type }}
      distros: ${{ steps.discover.outputs.distros }}
    env:
      NIX_CONFIG: |
        access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
      TESTED_LIFECYCLES: ${{ inputs.tested_lifecycles || github.event.inputs.tested_lifecycles }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show Docker version
        run: docker version

      - name: Install jq
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Discover apps (JSON)
        id: discover
        shell: bash
        run: |
          set -euo pipefail

          mode="${{ inputs.mode || github.event.inputs.mode }}"
          distros="${{ inputs.distros || github.event.inputs.distros }}"
          tested="${{ inputs.tested_lifecycles || github.event.inputs.tested_lifecycles }}"

          only_app="${{ inputs.only_app || github.event.inputs.only_app }}"
          only_distro="${{ inputs.only_distro || github.event.inputs.only_distro }}"

          server_include_re="${{ inputs.server_include_re || github.event.inputs.server_include_re }}"
          server_exclude_re="${{ inputs.server_exclude_re || github.event.inputs.server_exclude_re }}"
          workstation_include_re="${{ inputs.workstation_include_re || github.event.inputs.workstation_include_re }}"
          workstation_exclude_re="${{ inputs.workstation_exclude_re || github.event.inputs.workstation_exclude_re }}"
          final_excl="${{ inputs.final_exclude_re || github.event.inputs.final_exclude_re }}"

          # Hard defaults (important for act/workflow_dispatch edge-cases)
          : "${mode:=server}"
          : "${distros:=arch debian ubuntu fedora centos}"
          : "${tested:=alpha beta rc stable}"
          : "${server_include_re:=^(web-app-|web-svc-)}"
          : "${server_exclude_re:=^(web-app-oauth2-proxy)$}"
          : "${workstation_include_re:=^(desk-|util-desk-)}"
          : "${workstation_exclude_re:=}"
          : "${final_excl:=}"

          export TESTED_LIFECYCLES="${tested}"

          export INFINITO_DISTRO="arch"
          make up

          discover() {
            local include_re="$1"
            local exclude_re="$2"
            INCLUDE_RE="${include_re}" EXCLUDE_RE="${exclude_re}" scripts/tests/discover-apps.sh
          }

          all_json="$(discover '.*' '')"
          [[ -n "${all_json}" ]] || all_json='[]'

          server_json="$(discover "${server_include_re}" "${server_exclude_re}")"
          [[ -n "${server_json}" ]] || server_json='[]'

          workstation_json="$(discover "${workstation_include_re}" "${workstation_exclude_re}")"
          [[ -n "${workstation_json}" ]] || workstation_json='[]'

          case "${mode}" in
            server)
              apps_json="${server_json}"
              deploy_type="server"
              ;;
            workstation)
              apps_json="${workstation_json}"
              deploy_type="workstation"
              ;;
            rest)
              apps_json="$(
                jq -nc \
                  --argjson all "${all_json}" \
                  --argjson server "${server_json}" \
                  --argjson workstation "${workstation_json}" \
                  '
                    def uniq: unique;
                    def union($a;$b): ($a + $b) | uniq;
                    def minus($a;$b): $a | map(select(. as $x | ($b | index($x)) | not));

                    (union($server; $workstation) | uniq) as $covered
                    | minus($all; $covered)
                    | unique
                  '
              )"
              # rest wird als "deploy:server" ausgeführt (nur Filter ändert sich)
              deploy_type="server"
              ;;
            *)
              echo "ERROR: invalid mode=${mode} (use server|workstation|rest)" >&2
              exit 2
              ;;
          esac

          if [[ -n "${final_excl}" ]]; then
            txt="$(
              echo "${apps_json}" \
              | jq -r '.[]' \
              | grep -Ev "${final_excl}" || true
            )"
            apps_json="$(
              printf "%s\n" "${txt}" \
              | jq -R -s -c 'split("\n") | map(select(length>0))'
            )"
          fi

          if [[ -n "${only_app}" ]]; then
            apps_json="$(jq -nc --arg a "${only_app}" '[ $a ]')"
          fi

          if [[ -n "${only_distro}" ]]; then
            distros="${only_distro}"
          fi

          echo "apps=${apps_json}" >> "$GITHUB_OUTPUT"
          echo "deploy_type=${deploy_type}" >> "$GITHUB_OUTPUT"
          echo "distros=${distros}" >> "$GITHUB_OUTPUT"

          echo "mode=${mode}"
          echo "deploy_type=${deploy_type}"
          echo "distros=${distros}"
          echo "TESTED_LIFECYCLES=${TESTED_LIFECYCLES}"
          echo "only_app=${only_app}"
          echo "only_distro=${only_distro}"
          echo "server_include_re=${server_include_re}"
          echo "server_exclude_re=${server_exclude_re}"
          echo "workstation_include_re=${workstation_include_re}"
          echo "workstation_exclude_re=${workstation_exclude_re}"
          echo "final_exclude_re=${final_excl}"
          echo "apps=${apps_json}"

  test:
    name: "deploy:${{ needs.discover.outputs.deploy_type }} app=${{ matrix.app }} (all distros)"
    needs: discover
    runs-on: ubuntu-latest
    timeout-minutes: 240

    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        app: ${{ fromJson(needs.discover.outputs.apps) }}

    env:
      NIX_CONFIG: |
        access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show Docker version
        run: docker version

      - name: Run deploy test (per app, all distros)
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p logs

          app="${{ matrix.app }}"
          deploy_type="${{ needs.discover.outputs.deploy_type }}"
          distros="${{ needs.discover.outputs.distros }}"
          read -r -a distro_arr <<< "${distros}"

          missing_only="${{ inputs.missing_only || github.event.inputs.missing_only || 'true' }}"
          keep_stack="${{ inputs.keep_stack_on_failure || github.event.inputs.keep_stack_on_failure || 'true' }}"

          normalize_bool() {
            case "$1" in
              true|True|TRUE|1) echo "true" ;;
              false|False|FALSE|0) echo "false" ;;
              *) echo "true" ;;
            esac
          }
          missing_only="$(normalize_bool "${missing_only}")"
          keep_stack="$(normalize_bool "${keep_stack}")"

          for distro in "${distro_arr[@]}"; do
            export INFINITO_DISTRO="${distro}"

            log_file="logs/deploy-${deploy_type}-${distro}-${app}.log"

            echo "=== $(date -u) ===" | tee "${log_file}"
            echo "Deploy type: ${deploy_type}" | tee -a "${log_file}"
            echo "Distro: ${distro}" | tee -a "${log_file}"
            echo "App: ${app}" | tee -a "${log_file}"
            echo | tee -a "${log_file}"

            {
              echo "--- disk before ---"
              df -h
              docker system df || true

              echo "--- deploy (per app) ---"
              set +e
              args=( --type "${deploy_type}" --app "${app}" )
              if [[ "${missing_only}" == "true" ]]; then args+=( --missing ); fi
              if [[ "${keep_stack}" == "true" ]]; then args+=( --keep-stack-on-failure ); fi
              scripts/tests/deploy.sh "${args[@]}"
              rc=$?
              set -e

              echo "--- disk after deploy ---"
              df -h
              docker system df || true

              if [[ $rc -eq 0 ]]; then
                echo "--- cleanup (success) ---"
                docker system prune -af --volumes
                docker builder prune -af
              else
                echo "--- no cleanup (failure; keep stack for debugging) ---"
              fi

              exit $rc
            } 2>&1 | tee -a "${log_file}"
          done
