name: Test Infinito.Nexus Deploy (local)

on:
  workflow_dispatch:
    inputs:
      test_deploy_type:
        description: "server | universal | workstation"
        required: false
        default: "server"
        type: string
      distros:
        description: "Space-separated distro list"
        required: false
        default: "debian"
        type: string
      whitelist:
        description: "Optional space-separated whitelist of app ids"
        required: false
        type: string
        default: ""

permissions:
  contents: read
  packages: read

# IMPORTANT:
# - For local `act`, prefer overriding via `--env`.
# - For GitHub UI dispatch, inputs are used as fallback.
env:
  TEST_DEPLOY_TYPE: "server"
  DISTROS: "debian"
  NIX_CONFIG: ""
  INFINITO_IMAGE_TAG: "latest"

jobs:
  discover:
    name: ðŸ”Ž Discover apps (local)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      apps: ${{ steps.discover.outputs.apps }}
      test_deploy_type: ${{ steps.vars.outputs.test_deploy_type }}
      distros: ${{ steps.vars.outputs.distros }}
      whitelist: ${{ steps.vars.outputs.whitelist }}

    steps:
      - uses: actions/checkout@v6

      - name: Resolve effective inputs/env
        id: vars
        shell: bash
        env:
          INPUT_TEST_DEPLOY_TYPE: ${{ inputs.test_deploy_type }}
          INPUT_DISTROS: ${{ inputs.distros }}
          INPUT_WHITELIST: ${{ inputs.whitelist }}
        run: |
          set -euo pipefail
          bash scripts/meta/resolve/input.sh

      - name: Install deps (jq + envsubst)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq gettext-base

      - name: Start stack for discovery (arch)
        shell: bash
        run: |
          set -euo pipefail
          make up

      - name: Discover apps
        id: discover
        shell: bash
        env:
          WHITELIST: ${{ inputs.whitelist }}
        run: |
          set -euo pipefail
          apps="$(./scripts/meta/resolve/apps.sh)"
          [[ -n "$apps" ]] || apps='[]'
          echo "apps=$apps" >> "$GITHUB_OUTPUT"
          echo "apps_json=$apps" >> "$GITHUB_OUTPUT"
          echo "apps_json=$apps"

  deploy:
    name: ðŸš€ Deploy ${{ needs.discover.outputs.test_deploy_type }} app (${{ matrix.app }})
    runs-on: ubuntu-latest
    timeout-minutes: 360
    needs: discover

    strategy:
      fail-fast: false
      max-parallel: 1   # immer linear
      matrix:
        app: ${{ fromJson(needs.discover.outputs.apps) }}

    steps:
      - uses: actions/checkout@v6

      - name: Install deps (jq + envsubst)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq gettext-base

      - name: Start stack (arch)
        shell: bash
        run: |
          set -euo pipefail
          make up

      - name: Deploy app (same as CI logic)
        shell: bash
        run: |
          set -euo pipefail
          export TEST_DEPLOY_TYPE="${{ needs.discover.outputs.test_deploy_type }}"
          export DISTROS="${{ needs.discover.outputs.distros }}"
          export APP="${{ matrix.app }}"
          export WHITELIST="${{ needs.discover.outputs.whitelist }}"
          make ci-deploy-app
