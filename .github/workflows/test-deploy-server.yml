name: Test Infinito.Nexus Deploy (server)

on:
  workflow_call:

permissions:
  contents: read
  packages: read

jobs:
  discover:
    name: Discover server apps
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      apps: ${{ steps.discover.outputs.apps }}
    env:
      NIX_CONFIG: |
        access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Show Docker version
        run: docker version

      - name: Install jq
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Discover invokable server apps (JSON)
        id: discover
        shell: bash
        run: |
          set -euo pipefail
          export INFINITO_DISTRO="arch"
          make down
          make up
          apps_json="$(scripts/tests/discover-server-apps.sh)"
          if [[ -z "${apps_json}" ]]; then
            apps_json="[]"
          fi

          # Exclude known-flaky/unsupported apps from CI matrix
          # (keep the list explicit and easy to maintain)
          apps_json="$(echo "${apps_json}" | jq -c 'map(select(. != "web-app-oauth2-proxy"))')"

          echo "apps=${apps_json}" >> "$GITHUB_OUTPUT"
          echo "Discovered apps (filtered): ${apps_json}"

  test:
    name: "deploy:server app=${{ matrix.app }} (all distros)"
    needs: discover
    runs-on: ubuntu-latest
    timeout-minutes: 240

    strategy:
      fail-fast: true
      matrix:
        app: ${{ fromJson(needs.discover.outputs.apps) }}

    env:
      NIX_CONFIG: |
        access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Show Docker version
        run: docker version

      - name: Run deploy test (server, per app, all distros)
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p logs

          app="${{ matrix.app }}"
          distros=(arch debian ubuntu fedora centos)

          for distro in "${distros[@]}"; do
            export INFINITO_DISTRO="${distro}"

            log_file="logs/deploy-server-${distro}-${app}.log"

            echo "=== $(date -u) ===" | tee "${log_file}"
            echo "Deploy type: server" | tee -a "${log_file}"
            echo "Distro: ${distro}" | tee -a "${log_file}"
            echo "App: ${app}" | tee -a "${log_file}"
            echo | tee -a "${log_file}"

            {
              echo "--- make down ---"
              make down || true
              echo
              echo "--- deploy (per app) ---"
              scripts/tests/deploy.sh --missing --type server --app "${app}" --keep-stack-on-failure
            } 2>&1 | tee -a "${log_file}"
          done

      - name: Show last lines on failure
        if: failure()
        shell: bash
        run: |
          echo "=== DEBUG: logs directory ==="
          ls -la logs || true

          echo
          echo "=== tail -n 200 logs/deploy-server-arch-orchestrator.log ==="
          tail -n 200 logs/deploy-server-arch-orchestrator.log || true
          echo

          shopt -s nullglob
          for f in logs/deploy-server-*-${{ matrix.app }}.log logs/deploy-server-*-app-${{ matrix.app }}.log; do
            echo "=== tail -n 200 $f ==="
            tail -n 200 "$f" || true
            echo
          done

      - name: Upload deploy logs
        if: ${{ always() && env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: deploy-logs-server-${{ matrix.app }}
          path: logs/deploy-server-*-${{ matrix.app }}.log
          if-no-files-found: warn
          retention-days: 14
