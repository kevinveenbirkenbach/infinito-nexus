name: Code analyses

on:
  workflow_call:
    inputs:
      distros:
        description: "Space-separated distro list"
        required: false
        type: string
        default: "arch debian ubuntu fedora centos"

concurrency:
  group: infinito-test-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  packages: write
  security-events: write

jobs:
  lint-ansible:
    uses: ./.github/workflows/lint-ansible.yml
  lint-docker:
    uses: ./.github/workflows/lint-docker.yml
  lint-python:
    uses: ./.github/workflows/lint-python.yml
  lint-shell:
    uses: ./.github/workflows/lint-shell.yml
  security-codeql:
    uses: ./.github/workflows/security-codeql.yml
  test-code-integration:
    uses: ./.github/workflows/test-code-integration.yml
  test-code-lint:
    uses: ./.github/workflows/test-code-lint.yml
  test-code-unit:
    uses: ./.github/workflows/test-code-unit.yml
  build-ci-images:
    uses: ./.github/workflows/build-ci-images.yml
    with:
      distros: ${{ inputs.distros }}
  test-dns:
    needs: 
      - build-ci-images
    uses: ./.github/workflows/test-dns.yml
    with:
      distros: "arch"
  # Priority A
  test-deploy-server:
    needs: 
      - test-dns
      - build-ci-images
    uses: ./.github/workflows/test-deploy-server.yml
    with:
      distros: ${{ inputs.distros }}
  # Priority B
  test-deploy-universal:
    needs:
      - test-dns 
      - build-ci-images
      - test-deploy-server
    uses: ./.github/workflows/test-deploy-universal.yml
    with:
      distros: ${{ inputs.distros }}
  # Priority C
  test-deploy-workstation:
    needs:
      - build-ci-images
      - test-deploy-server
      - test-deploy-universal
    uses: ./.github/workflows/test-deploy-workstation.yml
    with:
      distros: ${{ inputs.distros }}
  test-install-make:
    uses: ./.github/workflows/test-install-make.yml
  test-install-pkgmgr:
    uses: ./.github/workflows/test-install-pkgmgr.yml

  done:
    needs:
      - build-ci-images
      - lint-python
      - lint-shell
      - lint-docker
      - security-codeql
      - test-code-integration
      - test-code-lint
      - test-code-unit
      - test-deploy-server
      - test-deploy-workstation
      - test-deploy-universal
      - test-install-make
      - test-install-pkgmgr
    runs-on: ubuntu-latest
    steps:
      - name: Done
        run: echo "All checks passed."
